<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>รีวิวลูกค้าทั้งหมด • alltasks24.online</title>

  <!-- Bootstrap + Icons + ฟอนต์ (ให้เหมือนหน้าแรก) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- ใช้ไฟล์สไตล์เดียวกับหน้าแรก -->
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="bg-body-tertiary">

  <!-- Navbar โทนเดียวกับหน้าแรก -->
  <nav class="navbar navbar-expand-lg sticky-top bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" style="color:var(--primary)" href="/">alltasks24.online</a>
      <div class="ms-auto">
        <a class="btn btn-outline-primary btn-sm" href="/"><i class="bi bi-arrow-left me-1"></i> กลับหน้าแรก</a>
      </div>
    </div>
  </nav>

  <main class="py-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-end mb-3">
        <h1 class="h4 mb-0">รีวิวลูกค้าทั้งหมด</h1>
        <div id="avgAll" class="text-muted small"></div>
      </div>

      <!-- กริดรีวิว -->
      <div id="reviewAllList" class="row g-3" data-page-size="6"></div>

      <!-- Pager -->
      <nav class="mt-3" aria-label="รีวิวแบบแบ่งหน้า">
        <ul class="pagination justify-content-center" id="reviewPager">
          <li class="page-item">
            <button class="page-link" id="pagePrev" type="button">ก่อนหน้า</button>
          </li>
          <li class="page-item disabled">
            <span class="page-link" id="pageIndicator">หน้า 1</span>
          </li>
          <li class="page-item">
            <button class="page-link" id="pageNext" type="button">ถัดไป</button>
          </li>
        </ul>
      </nav>
    </div>
  </main>

  <!-- Footer โทนเดียวกับหน้าแรก -->
  <footer class="site-footer py-4">
    <div class="container d-flex justify-content-between align-items-center">
      <small>© <span id="yearNow">2025</span> alltasks24.online</small>
      <div class="d-flex gap-3">
        <a href="#" class="text-decoration-none">เงื่อนไขบริการ</a>
        <a href="#" class="text-decoration-none">นโยบายความเป็นส่วนตัว</a>
      </div>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- โมดูล Firestore (ทำงานเฉพาะหน้านี้) -->
  <script type="module">
    import { db } from './firebase-init.js';
    import {
      collection, query, where, orderBy, limit, startAfter, getDocs,
      getCountFromServer
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const list = document.getElementById('reviewAllList');
    const prevBtn = document.getElementById('pagePrev');
    const nextBtn = document.getElementById('pageNext');
    const indicator = document.getElementById('pageIndicator');
    const avgAll = document.getElementById('avgAll');

    const PAGE_SIZE = Number(list?.dataset.pageSize || 6);
    let page = 1;
    const cursors = []; // เก็บ doc สุดท้ายของแต่ละหน้า

    // ปีใน footer
    const y = document.getElementById('yearNow');
    if (y) y.textContent = new Date().getFullYear();

    // โหลดหนึ่งหน้า (แสดงรีวิวให้เร็วสุดด้วย skeleton ก่อน)
    async function loadPage(pageIndex){
      if (!list) return;

      // skeleton ให้ผู้ใช้เห็นทันที
      list.innerHTML = Array.from({length: PAGE_SIZE}).map(()=>`
        <div class="col-md-6">
          <div class="placeholder-glow p-3 bg-white rounded-3 shadow-sm">
            <span class="placeholder col-6"></span>
            <span class="placeholder col-8"></span>
          </div>
        </div>
      `).join('');
      if (indicator) indicator.textContent = 'กำลังโหลด…';

      // คิวรีรีวิว (ล่าสุดก่อน)
      let q = query(
        collection(db, 'reviews'),
        where('approved','==', true),
        orderBy('createdAt','desc'),
        limit(PAGE_SIZE)
      );
      const startCursor = cursors[pageIndex - 2];
      if (pageIndex > 1 && startCursor) {
        q = query(q, startAfter(startCursor));
      }

      const snap = await getDocs(q);

      const frag = document.createDocumentFragment();
      snap.forEach(docSnap=>{
        const r = docSnap.data() || {};
        const created = r.createdAt?.toDate?.() ? r.createdAt.toDate() : null;
        const timeText = created ? created.toLocaleString('th-TH', {
          year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
        }) : '';

        const col = document.createElement('div');
        col.className = 'col-md-6';
        col.innerHTML = `
          <div class="card shadow-sm border-0 h-100">
            ${r.imageUrl ? `<img src="${r.imageUrl}" class="card-img-top" alt="รีวิว">` : ''}
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">${r.name || 'ผู้ใช้'}</div>
                <span class="badge text-bg-success">
                  ${'★'.repeat(Number(r.rating||0))}${'☆'.repeat(5 - Number(r.rating||0))}
                </span>
              </div>
              <p class="mb-1 mt-2 text-muted small">${r.text || ''}</p>
              ${timeText ? `<div class="text-muted small"><i class="bi bi-clock me-1"></i>${timeText}</div>` : ''}
            </div>
          </div>`;
        frag.appendChild(col);
      });
      list.innerHTML = '';
      list.appendChild(frag);

      // เก็บ cursor ของหน้าที่โหลด
      const last = snap.docs[snap.docs.length - 1] || null;
      if (last) cursors[pageIndex - 1] = last;

      // อัปเดตปุ่ม/ตัวชี้หน้า
      if (indicator) indicator.textContent = `หน้า ${pageIndex}`;
      if (prevBtn) prevBtn.disabled = (pageIndex === 1);
      if (nextBtn) nextBtn.disabled = (snap.size < PAGE_SIZE); // หมดแล้ว
    }

    // นับจำนวน + คำนวณค่าเฉลี่ย "ภายหลังจากเรนเดอร์หน้าแรกแล้ว"
    async function updateAverageLater(){
      try {
        // ขึ้นข้อความเบื้องต้นเร็วๆ ไม่บล็อค UI
        if (avgAll) avgAll.textContent = 'กำลังคำนวณค่าเฉลี่ย…';

        // ดึงจำนวนรีวิวอนุมัติแล้ว (เร็ว)
        const qc = query(collection(db, 'reviews'), where('approved', '==', true));
        const cntSnap = await getCountFromServer(qc);
        const total = cntSnap.data().count || 0;

        // ค่อยๆ กวาดรวมคะแนนเป็น batch (ไม่บล็อคการแสดงผล)
        let sum = 0, counted = 0, last = null;
        while (true) {
          let q = query(
            collection(db,'reviews'),
            where('approved','==',true),
            orderBy('createdAt','desc'),
            limit(100)
          );
          if (last) q = query(q, startAfter(last));
          const snap = await getDocs(q);
          snap.forEach(d=>{
            const r = d.data() || {};
            const rt = Number(r.rating || 0);
            if (!Number.isNaN(rt) && rt > 0) { sum += rt; counted++; }
          });
          if (snap.size < 100) break;
          last = snap.docs[snap.docs.length-1];
        }

        const avg = counted ? (sum / counted) : 0;
        if (avgAll) avgAll.textContent = `คะแนนเฉลี่ย ${avg.toFixed(1)}/5 จาก ${total} รีวิว`;
      } catch {
        // ไม่ต้องแจ้ง error เพื่อไม่ให้กวนผู้ใช้
        if (avgAll) avgAll.textContent = '';
      }
    }

    // ปุ่มก่อนหน้า/ถัดไป
    prevBtn?.addEventListener('click', () => { if (page > 1) { page--; loadPage(page); }});
    nextBtn?.addEventListener('click', () => { if (!nextBtn.disabled) { page++; loadPage(page); }});

    // ลำดับการทำงาน: 1) แสดงรีวิวหน้าแรกก่อน  2) แล้วค่อยคำนวณค่าเฉลี่ยเบื้องหลัง
    (async () => {
      await loadPage(1);
      // ให้ browser วาดหน้าเสร็จแล้วค่อยเริ่มงานหนัก
      setTimeout(updateAverageLater, 0);
    })();
  </script>
</body>
</html>
