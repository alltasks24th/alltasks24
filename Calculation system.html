<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>คำนวณราคา & บิล</title>
  <meta name="description" content="คำนวณราคา • สร้างบิล • PNG/PDF/พิมพ์ • คลังบิล (ดู/แก้ไข/ลบ)">
  <!-- libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F6F7FB; --card:#ffffff; --ink:#0F172A; --muted:#6b7280;
      --primary:#7C3AED; --accent:#A78BFA; --soft:#F3E8FF; --border:#E5E7EB;
      --scale:1.00;
    }
    [data-theme="dark"]{
      --bg:#0b1020; --card:#0F172A; --ink:#E5EAF2; --muted:#94A3B8;
      --primary:#A78BFA; --accent:#C4B5FD; --soft:#1f1847; --border:#1F2540;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--bg); color:var(--ink);
      font-family:"Kanit",-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans Thai",sans-serif;
      font-size:calc(15px * var(--scale));
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      font-variant-numeric: tabular-nums;
    }
    .container-narrow{ max-width:1180px; }
    .brand{
      background:linear-gradient(90deg,#6D28D9,#8B5CF6,#A78BFA);
      color:#fff; border-bottom:1px solid rgba(255,255,255,.15);
    }
    .logo-dot{ width:38px; height:38px; border-radius:10px; background:#fff; display:grid; place-items:center; color:#6D28D9; font-weight:800 }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 30px rgba(17,12,46,.08) }
    .section-title{ font-weight:800; font-size:1.15rem }
    .subtle{ color:var(--muted) }
    .btn-primary{ background:var(--primary); border-color:var(--primary) }
    .btn-outline-primary{ color:var(--primary); border-color:var(--primary) }
    .btn-outline-primary:hover{ background:var(--soft); border-color:var(--primary) }
    .eyebrow{ font-size:.82rem; letter-spacing:.06em; text-transform:uppercase; color:var(--muted) }
    .kbd{ background:#eef2ff; color:#4338ca; border:1px solid #c7d2fe; padding:.05rem .35rem; border-radius:.4rem }
    /* Hints */
    .hint{ font-size:.82rem; color:var(--muted) }
    .hint-toggle{ cursor:pointer; user-select:none }
    /* Table alignment (key fix) */
    .table-receipt{ table-layout: fixed; border-collapse:separate; border-spacing:0; width:100% }
    .table-receipt thead th{ background:#F3F4F6; }
    .table-receipt th, .table-receipt td{
      padding:.55rem .6rem; border-bottom:1px dashed var(--border); vertical-align:middle;
    }
    .table-receipt td:nth-child(1){ text-align:left }
    .table-receipt td:nth-child(3),
    .table-receipt td:nth-child(4),
    .table-receipt td:nth-child(5),
    .table-receipt th:nth-child(3),
    .table-receipt th:nth-child(4),
    .table-receipt th:nth-child(5){ text-align:right }
    .table-receipt input{
      width:100%; border:1px solid var(--border);
      border-radius:8px; padding:.35rem .5rem; background:var(--card);
    }
    .table-receipt .item-name{ text-align:left }
    .table-receipt .item-qty, .table-receipt .item-price{ text-align:right }
    .table-receipt .btn-del{ opacity:.7 }
    /* Pretty output */
    .pretty-doc{ width:210mm; margin:auto; background:#fff; color:#0f172a;
      border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(16,24,40,.08); }
    .pretty-header{
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color:#fff; padding:20px 22px; display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .pretty-logo{ width:56px; height:56px; border-radius:12px; overflow:hidden; border:3px solid rgba(255,255,255,.85);
      background:#fff; display:grid; place-items:center }
    .pretty-title{ font-size:40px; font-weight:900; letter-spacing:.02em }
    .pretty-sub{ opacity:.9; font-size:12px }
    .pretty-body{ padding:18px 22px }
    .pretty-table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .pretty-table thead th{ background:#6D28D9; color:#fff; text-transform:uppercase; letter-spacing:.06em; font-size:12px; padding:10px 10px; }
    .pretty-table th, .pretty-table td{ padding:12px 10px; border-bottom: 1px dashed #e5e7eb; vertical-align:middle }
    .pretty-table td:nth-child(1){ text-align:left; color:#64748b }
    .pretty-table td:nth-child(3),
    .pretty-table td:nth-child(4),
    .pretty-table td:nth-child(5),
    .pretty-table th:nth-child(3),
    .pretty-table th:nth-child(4),
    .pretty-table th:nth-child(5){ text-align:right }
    .pill-total{ background:var(--primary); color:#fff; border-radius:999px; padding:12px 16px; display:flex; justify-content:space-between; font-weight:900; font-size:18px }
    .pill-tax{ background:#e2e8f0; color:#0f172a; border-radius:12px; padding:10px 14px; display:flex; justify-content:space-between; font-weight:800 }
    .pill-sub{ background:var(--accent); color:#fff; border-radius:999px; padding:10px 14px; display:flex; justify-content:space-between; font-weight:800 }
    .pretty-pay{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px }
    .stamp{
      position:absolute; top:18px; right:18px; padding:6px 12px; border:3px dashed rgba(255,255,255,.9);
      border-radius:12px; transform: rotate(-12deg); font-weight:800; letter-spacing:.06em; background:rgba(255,255,255,.18)
    }
    .pretty-wrap{ position:relative }
    .qr-box{ width:120px; height:120px; border:2px dashed #cbd5e1; border-radius:12px; display:grid; place-items:center; color:#94a3b8 }
    /* Nav bar under compute (sticky) */
    #summaryBar{ position:sticky; bottom:12px; z-index:3; display:flex; justify-content:space-between; align-items:center; gap:1rem; padding:.6rem .85rem; border:1px solid var(--border); border-radius:.75rem; background:var(--card); box-shadow:0 6px 20px rgba(17, 12, 46, 0.08) }
    /* Receipt simple preview block */
    #receipt{ border:1px solid var(--border); border-radius:12px }
    /* Print rules */
    #prettyPrint{ display:none }
    @media print{
      body{ background:#fff }
      .navbar, .container-narrow, .no-print{ display:none !important }
      #prettyPrint{ display:block !important }
      .pretty-doc{ box-shadow:none; border:none }
      @page{ size:A4; margin:10mm }
    }
    /* Misc */
    .form-section{ position:relative }
    .form-section .badge-soft{
      position:absolute; top:-12px; right:12px; background:var(--soft); color:#4c1d95; padding:.2rem .5rem; border-radius:999px; border:1px solid #e9d5ff; font-size:.78rem
    }
    /* Grid columns for settings */
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:.5rem }
    .grid-3{ display:grid; grid-template-columns:repeat(3, 1fr); gap:.5rem }
    .grid-4{ display:grid; grid-template-columns:repeat(4, 1fr); gap:.5rem }
    @media(max-width: 720px){
      .grid-2,.grid-3,.grid-4{ grid-template-columns:1fr }
      .pretty-pay{ grid-template-columns: 1fr }
    }
    .w-80mm{ width:80mm; margin:auto }
    .tnum{ font-variant-numeric: tabular-nums; }
  </style>

<style id="ui-polish-v1">
/* ===== Polished UI v1 (visual-only patch) ===== */
:root { --ui-card-radius: 1rem; --ui-card-shadow: 0 10px 30px rgba(0,0,0,.06); --ui-border: rgba(0,0,0,.08); --ui-border-dark: rgba(255,255,255,.12); --ui-focus: rgba(111,66,193,.25); }
/* Sticky, translucent topbar */
.pro-ui .navbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-bottom: 1px solid var(--ui-border); background-color: rgba(255,255,255,.75); }
[data-theme="dark"] .pro-ui .navbar { background-color: rgba(0,0,0,.35); border-bottom-color: var(--ui-border-dark); }
/* Cards */
.pro-ui .card { border-radius: var(--ui-card-radius); box-shadow: var(--ui-card-shadow); border: 1px solid var(--ui-border); }
[data-theme="dark"] .pro-ui .card { border-color: var(--ui-border-dark); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
/* Inputs */
.pro-ui .form-control, .pro-ui .form-select, .pro-ui input, .pro-ui select, .pro-ui textarea { border-radius: .75rem !important; transition: box-shadow .2s, border-color .2s, background-color .2s; }
.pro-ui .form-control:focus, .pro-ui .form-select:focus, .pro-ui input:focus, .pro-ui textarea:focus, .pro-ui select:focus { border-color: var(--primary, #6f42c1) !important; box-shadow: 0 0 0 .2rem var(--ui-focus) !important; outline: none; }
/* Buttons */
.pro-ui .btn { border-radius: .75rem; transition: transform .05s ease, box-shadow .2s ease; }
.pro-ui .btn:active { transform: translateY(1px); }
.pro-ui .btn-primary { background: var(--primary, #6f42c1); border-color: var(--primary, #6f42c1); }
.pro-ui .btn-outline-primary { color: var(--primary, #6f42c1); border-color: var(--primary, #6f42c1); }
.pro-ui .btn-outline-primary:hover { background: var(--primary, #6f42c1); color: #fff; }
/* Section spacing */
.pro-ui .container, .pro-ui .container-fluid { padding-top: .5rem; padding-bottom: 1.25rem; }
/* Tables */
.pro-ui thead th { position: sticky; top: 56px; background: rgba(255,255,255,.9); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 1; }
[data-theme="dark"] .pro-ui thead th { background: rgba(0,0,0,.5); }
.pro-ui tbody tr { transition: background-color .15s ease; }
.pro-ui tbody tr:hover { background-color: rgba(0,0,0,.035); }
[data-theme="dark"] .pro-ui tbody tr:hover { background-color: rgba(255,255,255,.05); }
.pro-ui table td, .pro-ui table th { border-top: 1px solid var(--ui-border); }
[data-theme="dark"] .pro-ui table td, [data-theme="dark"] .pro-ui table th { border-top-color: var(--ui-border-dark); }
/* Pretty print area */
.pro-ui #prettyPrint, .pro-ui .pretty-doc { border-radius: 1rem; box-shadow: 0 20px 40px rgba(0,0,0,.08); }
[data-theme="dark"] .pro-ui #prettyPrint, [data-theme="dark"] .pro-ui .pretty-doc { box-shadow: 0 20px 60px rgba(0,0,0,.45); }
/* Divider */
.pro-ui .soft-divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(0,0,0,.1), transparent); margin: 1rem 0; }
[data-theme="dark"] .pro-ui .soft-divider { background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent); }
/* Keep print CSS intact */
@media print { .pro-ui .navbar { display: none !important; } }
</style>


<link rel="canonical" href="https://alltasks24.online/Calculation system.html">

<link rel="manifest" href="/icons/site.webmanifest">

<!-- SEO auto (safe-add) -->
<meta property="og:type" content="website">
<meta property="og:title" content="คำนวณราคา & บิล">
<meta property="og:description" content="AllTasks24 — รับจ้างสารพัด 24 ชั่วโมง: ส่งของ เอกสาร งานช่าง ทำความสะอาด ซักรีด และอีกมากมาย ในจังหวัดนครสวรรค์ สื่อสารง่าย เรียกใช้งานได้ตลอด 24 ชม.">
<meta property="og:url" content="https://alltasks24.online/Calculation system.html">
<meta property="og:image" content="/icons/android-chrome-512x512.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="คำนวณราคา & บิล">
<meta name="twitter:description" content="AllTasks24 — รับจ้างสารพัด 24 ชั่วโมง: ส่งของ เอกสาร งานช่าง ทำความสะอาด ซักรีด และอีกมากมาย ในจังหวัดนครสวรรค์ สื่อสารง่าย เรียกใช้งานได้ตลอด 24 ชม.">
<meta name="twitter:image" content="/icons/android-chrome-512x512.png">

<script type="application/ld+json">{"@context": "https://schema.org", "@type": "WebSite", "name": "AllTasks24", "url": "https://alltasks24.online"}</script>
</head>
<body class="paper-a4 pro-ui">
  <nav class="navbar brand">
    <div class="container-narrow container-fluid">
      <div class="d-flex align-items-center gap-2">
        <div class="logo-dot">A</div>
        <div>
          <div class="fw-bold">ระบบคำนวณค่าบริการ</div>
          <div class="small" style="opacity:.9">คำนวณราคา & บิล • PNG/PDF/พิมพ์ • คลังบิล CRUD</div>
        </div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="paper">
          <button class="btn btn-light" id="paperA4">A4</button>
          <button class="btn btn-light" id="paperA5">A5</button>
          <button class="btn btn-light" id="paper80">80mm</button>
        </div>
        <div class="form-check form-switch ms-2">
          <input id="ui_dark" class="form-check-input" type="checkbox">
          <label class="form-check-label text-white-50" for="ui_dark">Dark</label>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-narrow my-3">
    <!-- ตั้งค่า & สูตรคำนวณ -->
    <section class="card p-3 form-section">
      <span class="badge-soft">ตั้งค่า & สูตรคำนวณ</span>
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title">ฐาน/ระยะ/รอคิว/ปัดเศษ</div>
        <div class="d-flex gap-2">
          <button id="btnCfgSave" class="btn btn-outline-primary btn-sm">บันทึกการตั้งค่า</button>
          <button id="btnCfgLoad" class="btn btn-outline-secondary btn-sm">โหลด</button>
          <button id="btnCfgReset" class="btn btn-outline-secondary btn-sm">Default</button>
          <span class="hint-toggle subtle small" id="toggleHints">แสดง/ซ่อนคำอธิบาย</span>
        </div>
      </div>
      <div class="grid-4 mt-2">
        <div>
          <label class="form-label">ฐานในเมือง</label>
          <input id="cfg_base" type="number" class="form-control" value="59">
          <div class="hint">ค่าเริ่มต้นของงานในพื้นที่บริการ (บาท)</div>
        </div>
        <div>
          <label class="form-label">ระยะในฐาน (กม.)</label>
          <input id="cfg_incKm" type="number" class="form-control" value="3">
          <div class="hint">ระยะทางที่รวมอยู่ในฐานแล้ว ไม่คิดเพิ่ม</div>
        </div>
        <div>
          <label class="form-label">เกินระยะ/กม. ชั้น1</label>
          <input id="cfg_perKm1" type="number" class="form-control" value="8">
          <div class="hint">คิดเพิ่มต่อกิโล หลังเกินระยะในฐาน จนถึงจุดเริ่มชั้น2</div>
        </div>
        <div>
          <label class="form-label">เริ่มชั้น2 ที่ (กม.)</label>
          <input id="cfg_tier2Start" type="number" class="form-control" value="15">
          <div class="hint">ตั้งแต่ระยะนี้ขึ้นไป ใช้เรตราคา “ชั้น2”</div>
        </div>
        <div>
          <label class="form-label">เกินระยะ/กม. ชั้น2</label>
          <input id="cfg_perKm2" type="number" class="form-control" value="6">
          <div class="hint">คิดเพิ่มต่อกิโล สำหรับช่วงระยะชั้น2</div>
        </div>
        <div>
          <label class="form-label">ขั้นต่ำ</label>
          <input id="cfg_minCharge" type="number" class="form-control" value="49">
          <div class="hint">ราคาต่ำสุดที่รับงาน (กันราคาต่ำเกินไป)</div>
        </div>
        <div>
          <label class="form-label">จุดแวะ/จุด</label>
          <input id="cfg_stop" type="number" class="form-control" value="10">
          <div class="hint">คิดเพิ่มต่อ 1 จุดแวะ</div>
        </div>
        <div>
          <label class="form-label">รอคิว/ชม.</label>
          <input id="cfg_wait" type="number" class="form-control" value="100">
          <div class="hint">ถ้าต้องรอคิว คิดราย 1 ชั่วโมง (ปัดขึ้นเป็นช่วงละ 15 นาที)</div>
        </div>
        <div>
          <label class="form-label">กลางคืน</label>
          <input id="cfg_night" type="number" class="form-control" value="10">
          <div class="hint">ค่าบริการเพิ่มพิเศษเมื่อทำงานเวลากลางคืน</div>
        </div>
        <div>
          <label class="form-label">ฝนตก</label>
          <input id="cfg_rain" type="number" class="form-control" value="8">
          <div class="hint">ค่าบริการเพิ่มเมื่อสภาพอากาศมีฝน</div>
        </div>
        <div>
          <label class="form-label">เสาร์–อาทิตย์/นักขัต</label>
          <input id="cfg_weekend" type="number" class="form-control" value="10">
          <div class="hint">เพิ่มพิเศษวันหยุด</div>
        </div>
        <div>
          <label class="form-label">ปัดเศษ</label>
          <select id="cfg_roundTo" class="form-select">
            <option value="1">ไม่ปัด</option><option value="5" selected>5</option><option value="10">10</option>
          </select>
          <div class="hint">ปัดเศษรวมบริการให้ลงตัว (เช่น 5 บาท)</div>
        </div>
        <div>
          <label class="form-label">คูณขนาด</label>
          <input id="cfg_multSize" type="number" step="0.01" class="form-control" value="1.05">
          <div class="hint">ถ้าสินค้า/งาน “กลาง” ให้คูณอัตรานี้</div>
        </div>
        <div>
          <label class="form-label">คูณแรงงาน (2 คน)</label>
          <input id="cfg_multLabor" type="number" step="0.01" class="form-control" value="1.30">
          <div class="hint">หากต้องใช้ 2 คน ให้คูณอัตรานี้</div>
        </div>
        <div>
          <label class="form-label">ธีมสีหลัก</label>
          <input type="color" id="ui_primary" class="form-control form-control-color" value="#7C3AED">
          <div class="hint">เปลี่ยนสี UI/หัวเอกสารให้เข้ากับแบรนด์</div>
        </div>
        <div>
          <label class="form-label">ธีมสีรอง</label>
          <input type="color" id="ui_accent" class="form-control form-control-color" value="#A78BFA">
          <div class="hint">ใช้กับปุ่ม/แท็บ/เส้นไฮไลต์</div>
        </div>
      </div>
      <hr>
      <div class="eyebrow">ข้อมูลร้าน</div>
      <div class="grid-3 mt-1">
        <div>
          <label class="form-label">ชื่อร้าน</label>
          <input id="biz_name" class="form-control" value="alltasks24 — นครสวรรค์">
        </div>
        <div>
          <label class="form-label">โทร</label>
          <input id="biz_phone" class="form-control" value="080-000-0000">
        </div>
        <div>
          <label class="form-label">LINE</label>
          <input id="biz_line" class="form-control" value="@yourline">
        </div>
        <div class="col-12">
          <label class="form-label">ที่อยู่</label>
          <input id="biz_addr" class="form-control" placeholder="ที่อยู่/คำอธิบายท้ายบิล">
        </div>
        <div class="col-12">
          <label class="form-label">หมายเหตุท้ายบิล</label>
          <input id="biz_note" class="form-control" value="ขอบคุณที่ใช้บริการ">
        </div>
        <div class="col-12">
          <label class="form-label">โลโก้/QR (อัปโหลดหรือ URL)</label>
          <div class="input-group">
            <span class="input-group-text">LOGO</span><input id="biz_logo" class="form-control" placeholder="https://..."><input id="biz_logo_file" type="file" class="form-control" accept="image/*">
          </div>
          <div class="input-group mt-1">
            <span class="input-group-text">QR</span><input id="biz_qr" class="form-control" placeholder="https://..."><input id="biz_qr_file" type="file" class="form-control" accept="image/*">
          </div>
          <div class="hint mt-1">* ใส่เป็นลิงก์รูป หรือกดเลือกไฟล์เพื่อบันทึกเป็น dataURL (จดจำในเครื่อง)</div>
        </div>
      </div>
    </section>

    <!-- คำนวณราคา -->
    <section class="card p-3 mt-3 form-section">
      <span class="badge-soft">คำนวณราคา</span>
      <div class="grid-4">
        <div>
          <label class="form-label">ประเภทงาน</label>
          <input id="jobName" class="form-control" placeholder="เช่น รับ-ส่งของ/ซ่อม/ติดตั้ง">
        </div>
        <div>
          <label class="form-label">ค่าสินค้าจริง (ถ้ามี)</label>
          <input id="otherCost" type="number" class="form-control" value="0">
        </div>
        <div>
          <label class="form-label">ระยะทาง (กม.)</label>
          <input id="km" type="number" step="0.1" class="form-control">
          <div class="hint">ใส่เฉพาะ “ขาไป” หากเลือกไป-กลับ ระบบจะคูณ 2 ให้เอง</div>
        </div>
        <div>
          <label class="form-label">ไป–กลับ?</label>
          <select id="roundtrip" class="form-select"><option value="no" selected>เที่ยวเดียว</option><option value="yes">ไป–กลับ</option></select>
        </div>
        <div>
          <label class="form-label">จุดแวะ</label>
          <input id="stops" type="number" class="form-control" value="0">
        </div>
        <div>
          <label class="form-label">รอคิว (นาที)</label>
          <input id="wait" type="number" class="form-control" value="0">
        </div>
        <div>
          <label class="form-label">ขนาด</label>
          <select id="size" class="form-select"><option value="small">เล็ก</option><option value="medium">กลาง</option></select>
        </div>
        <div>
          <label class="form-label">คนทำงาน</label>
          <select id="workers" class="form-select"><option value="1">1 คน</option><option value="2">2 คน</option></select>
        </div>
        <div>
          <label class="form-label">เงื่อนไข</label>
          <div class="form-check"><input id="night" class="form-check-input" type="checkbox"><label class="form-check-label" for="night">กลางคืน</label></div>
          <div class="form-check"><input id="rain" class="form-check-input" type="checkbox"><label class="form-check-label" for="rain">ฝนตก</label></div>
          <div class="form-check"><input id="weekend" class="form-check-input" type="checkbox"><label class="form-check-label" for="weekend">เสาร์–อาทิตย์/นักขัต</label></div>
        </div>
        <div>
          <label class="form-label">ส่วนลด (บาท)</label>
          <input id="discount" type="number" class="form-control" value="0">
        </div>
        <div>
          <label class="form-label">ภาษี</label>
          <select id="vat" class="form-select"><option value="no" selected>ไม่คิด VAT</option><option value="yes">VAT 7%</option></select>
        </div>
      </div>

      <div id="resultBox" class="mt-2">
        <div class="h4 fw-bold text-primary" id="grandLabel">฿0</div>
        <div class="small subtle" id="breakdownBox"></div>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button id="btnCompute" class="btn btn-primary"><i class="bi bi-calculator me-1"></i>คำนวณ</button>
        <button id="btnCreateReceipt" class="btn btn-primary"><i class="bi bi-receipt me-1"></i>สร้างบิล</button>
        <button id="btnSaveDraft" class="btn btn-outline-primary">บันทึกฉบับร่าง</button>
        <button id="btnLoadLast" class="btn btn-outline-secondary">โหลดครั้งล่าสุด</button>
        <button id="btnCopySummary" class="btn btn-outline-secondary">คัดลอกสรุป</button>
      </div>

      <div id="summaryBar" class="no-print mt-3">
        <div class="fw-bold">รวม: <span id="grandSummary">฿0</span></div>
        <div class="d-flex gap-2">
          <button id="summaryCreate" class="btn btn-primary btn-sm">สร้างบิล</button>
          <button id="summaryPrint" class="btn btn-outline-secondary btn-sm">พิมพ์</button>
        </div>
      </div>
    </section>

    <!-- เอกสาร -->
    <section class="card p-3 mt-3 form-section">
      <span class="badge-soft">เอกสารสำหรับลูกค้า</span>
      <div class="d-flex align-items-center justify-content-between">
        <div class="section-title">ตารางรายการ (จัดคอลัมน์แน่น-คงที่)</div>
        <div class="d-flex gap-2">
          <div class="input-group input-group-sm" style="width:220px">
            <span class="input-group-text">หัวเอกสาร</span>
            <select id="docTitle" class="form-select form-select-sm">
              <option value="ใบเสร็จ/บิลรับงาน" selected>ใบเสร็จ/บิลรับงาน</option>
              <option value="ใบเสนอราคา">ใบเสนอราคา</option>
              <option value="ใบแจ้งหนี้">ใบแจ้งหนี้</option>
            </select>
          </div>
          <button id="btnAddRow" class="btn btn-outline-primary btn-sm">เพิ่มบรรทัด</button>
          <div class="btn-group btn-group-sm">
            <button id="btnCapClean" class="btn btn-outline-primary">PNG</button>
            <button id="btnPDF" class="btn btn-outline-primary">PDF</button>
            <button id="btnPrint" class="btn btn-outline-secondary">พิมพ์</button>
          </div>
        </div>
      </div>

      <!-- mini form -->
      <div class="row g-2 mt-1">
        <div class="col-md-6"><div class="small subtle">ลูกค้า</div><input id="cust_name" class="form-control form-control-sm" placeholder="ชื่อลูกค้า/หน่วยงาน"></div>
        <div class="col-md-3"><div class="small subtle">เบอร์โทร</div><input id="cust_phone" class="form-control form-control-sm" placeholder="080-xxx-xxxx"></div>
        <div class="col-md-3"><div class="small subtle">เลขที่เอกสาร</div><input id="inv_no" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><div class="small subtle">ที่อยู่ลูกค้า</div><input id="cust_addr" class="form-control form-control-sm"></div>
        <div class="col-md-3"><div class="small subtle">เลขผู้เสียภาษี</div><input id="cust_taxid" class="form-control form-control-sm" placeholder="(ถ้ามี)"></div>
        <div class="col-md-3">
          <div class="small subtle">วันที่/เวลา</div>
          <div class="d-flex gap-1"><input id="inv_date" class="form-control form-control-sm"><input id="inv_time" class="form-control form-control-sm"></div>
        </div>
        <div class="col-md-9"><div class="small subtle">งาน/รายละเอียด</div><input id="inv_job" class="form-control form-control-sm"></div>
        <div class="col-md-3"><div class="small subtle">หมายเหตุ</div><input id="inv_note" class="form-control form-control-sm"></div>
      </div>

      <div class="table-responsive mt-2">
        <table class="table-receipt align-middle" id="rc_table">
          <colgroup>
            <col style="width:10%">
            <col style="width:46%">
            <col style="width:14%">
            <col style="width:10%">
            <col style="width:20%">
          </colgroup>
          <thead>
            <tr>
              <th>ลำดับ</th>
              <th>รายการ</th>
              <th>ราคา/หน่วย</th>
              <th>จำนวน</th>
              <th>รวม</th>
            </tr>
          </thead>
          <tbody id="rc_items">
            <tr><td class="text-muted" colspan="5">— กด “สร้างบิล” เพื่อใส่อัตโนมัติ หรือ “เพิ่มบรรทัด” —</td></tr>
          </tbody>
          <tfoot>
            <tr><th class="text-end" colspan="4">ค่าสินค้าตามจริง</th><th class="text-end tnum" id="rc_other">฿0</th></tr>
            <tr><th class="text-end" colspan="4">ส่วนลด</th><th class="text-end tnum" id="rc_discount">฿0</th></tr>
            <tr><th class="text-end" colspan="4">Vat 7%</th><th class="text-end tnum" id="rc_vat">฿0</th></tr>
            <tr><th class="text-end" colspan="4">รวมทั้งสิ้น</th><th class="text-end tnum" id="rc_total" style="font-size:1.05rem">฿0</th></tr>
          </tfoot>
        </table>
      </div>

      <div class="row g-2">
        <div class="col-md-3"><div class="small subtle">วิธีชำระเงิน</div><input id="pay_method" class="form-control form-control-sm" value="เงินสด"></div>
        <div class="col-md-3"><div class="small subtle">สถานะ</div><select id="pay_status" class="form-select form-select-sm"><option>ค้างชำระ</option><option selected>ชำระแล้ว</option></select></div>
        <div class="col-md-3"><div class="small subtle">เลขอ้างอิง</div><input id="pay_ref" class="form-control form-control-sm" placeholder="เช่น TX1234"></div>
        <div class="col-md-3"><div class="small subtle">กำหนดชำระ</div><input id="pay_due" type="date" class="form-control form-control-sm"></div>
      </div>

      <section id="receipt" class="p-3 p-md-4 mt-3 rounded">
        <div class="small subtle">บันทึกเป็น PNG/PDF/พิมพ์ จะใช้เวอร์ชัน “สวยพิเศษ” ให้อัตโนมัติ</div>
        <div class="d-flex justify-content-between align-items-start mt-1">
          <div>
            <div class="fw-bold" id="docTitleView">ใบเสร็จ/บิลรับงาน</div>
            <div class="small" id="bizNameView">alltasks24 — นครสวรรค์</div>
          </div>
          <div class="text-end">
            <div class="small" id="bizContactView">โทร 080-000-0000 • LINE @yourline</div>
            <div class="small" id="bizAddrView"></div>
          </div>
        </div>
      </section>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button id="btnSaveBill" class="btn btn-primary btn-sm"><i class="bi bi-save me-1"></i>บันทึกบิล</button>
        <button id="btnNewBill" class="btn btn-outline-secondary btn-sm">สร้างใหม่</button>
      </div>
    </section>

    <!-- คลังบิล -->
    <section class="card p-3 mt-3 form-section">
      <span class="badge-soft">คลังบิล (LocalStorage)</span>
      <div class="d-flex gap-2 align-items-center">
        <input id="invSearch" class="form-control form-control-sm" placeholder="ค้นหา" style="max-width:300px">
        <select id="invFilter" class="form-select form-select-sm" style="width:auto"><option value="all">ทั้งหมด</option><option value="paid">ชำระแล้ว</option><option value="unpaid">ค้างชำระ</option></select>
        <div class="subtle small ms-auto">* เก็บไว้ในเครื่องของคุณ</div>
      </div>
      <div id="invList" class="vstack gap-2 mt-2"></div>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <div id="invMeta" class="small subtle">–</div>
        <ul id="invPager" class="pagination pagination-sm mb-0"></ul>
      </div>
    </section>
        
    <!-- รายละเอียดบิล (ดูอย่างเร็ว) -->
    <section class="card p-3 mt-3" id="invQuickView">
      <span class="badge-soft">รายละเอียดบิล (ดูอย่างเร็ว)</span>
      <div id="invPreview" class="small subtle">เลือก “ดู/แก้ไข” จากคลังบิลด้านบน เพื่อแสดงรายละเอียดที่นี่</div>
    </section>

<!-- คำอธิบายช่องตั้งค่า (ช่วยจำ) -->
<section class="card p-3 mt-3" id="settings-help">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <span class="badge bg-secondary-subtle text-secondary-emphasis">ช่วยจำ</span>
      <span class="fw-semibold ms-2">คำอธิบายช่องตั้งค่า (ฐาน/ระยะ/รอคิว/ปัดเศษ)</span>
    </div>
    <button class="btn btn-outline-secondary btn-sm"
            data-bs-toggle="collapse" data-bs-target="#settings-help-body"
            aria-expanded="true" aria-controls="settings-help-body">
      แสดง/ซ่อน
    </button>
  </div>

  <div id="settings-help-body" class="collapse show">
    <dl class="row gy-2 mb-3">
      <dt class="col-sm-4">ฐานในเมือง</dt>
      <dd class="col-sm-8">ราคาเริ่มต้นต่อหนึ่งงาน/หนึ่งเที่ยว ภายในพื้นที่บริการ</dd>

      <dt class="col-sm-4">ระยะในฐาน (กม.)</dt>
      <dd class="col-sm-8">ระยะที่ “รวมอยู่ในราคาเริ่มต้น” — ภายในระยะนี้ไม่คิดค่า กม. เพิ่ม</dd>

      <dt class="col-sm-4">เกินระยะ/กม. ชั้น 1</dt>
      <dd class="col-sm-8">ค่า/กม. สำหรับช่วงที่เกิน “ระยะในฐาน” จนถึงก่อน “เริ่มชั้น 2”</dd>

      <dt class="col-sm-4">เริ่มชั้น 2 ที่ (กม.)</dt>
      <dd class="col-sm-8">ตั้งแต่ระยะนี้ขึ้นไป เปลี่ยนไปใช้เรทราคา “ชั้น 2”</dd>

      <dt class="col-sm-4">เกินระยะ/กม. ชั้น 2</dt>
      <dd class="col-sm-8">ค่า/กม. สำหรับส่วนระยะตั้งแต่ “เริ่มชั้น 2” เป็นต้นไป</dd>

      <dt class="col-sm-4">ขั้นต่ำ</dt>
      <dd class="col-sm-8">กันราคาไม่ให้ต่ำเกินไป ถ้าต่ำกว่านี้จะยกขึ้นมาเท่าค่านี้</dd>

      <dt class="col-sm-4">จุดแวะ/จุด</dt>
      <dd class="col-sm-8">คิดเพิ่มเป็นเงินตรา ต่อ 1 จุดแวะ</dd>

      <dt class="col-sm-4">รอคิว/ชม.</dt>
      <dd class="col-sm-8">ค่ารอเป็นบาทต่อชั่วโมง (ระบบคูณเวลาที่กรอกให้)</dd>

      <dt class="col-sm-4">กลางคืน / ฝนตก / เสาร์–อาทิตย์/นักขัต</dt>
      <dd class="col-sm-8">ค่าบวกพิเศษแบบเป็นเงินตรา จะบวกเมื่อเลือกใช้เงื่อนไขนั้น</dd>

      <dt class="col-sm-4">ปัดเศษ</dt>
      <dd class="col-sm-8">ปัด “ราคาบริการ” ให้ลงตัวตามขั้น (เช่น 5 หรือ 10 บาท) เพื่อเลขสวย/คิดเงินง่าย</dd>

      <dt class="col-sm-4">คูณขนาด</dt>
      <dd class="col-sm-8">ตัวคูณเมื่อเลือกงาน “ขนาดกลาง” (เช่น 1.05 = เพิ่ม 5%)</dd>

      <dt class="col-sm-4">คูณแรงงาน (2 คน)</dt>
      <dd class="col-sm-8">ตัวคูณเมื่อใช้แรงงาน 2 คน (เช่น 1.30 = เพิ่ม 30%)</dd>

      <dt class="col-sm-4">ธีมสีหลัก/ธีมสีรอง</dt>
      <dd class="col-sm-8">ปรับโทนสีหน้าจอ/เอกสาร <u>ไม่กระทบราคา</u></dd>
    </dl>

    <div class="border-top pt-3">
      <div class="fw-semibold mb-1">ลำดับการคำนวณ (ย่อ)</div>
      <ol class="mb-2 small">
        <li>ราคาเริ่มต้น = <strong>ฐานในเมือง</strong></li>
        <li>บวกค่า กม. ตามช่วง (ชั้น 1 / ชั้น 2) — ถ้า “ไป–กลับ” ให้คูณระยะก่อนคิด</li>
        <li>บวก <strong>จุดแวะ + รอคิว + (กลางคืน/ฝนตก/วันหยุดที่เลือก)</strong></li>
        <li>ถ้ามี <strong>ขนาดกลาง</strong> หรือ <strong>แรงงาน 2 คน</strong> ⇒ คูณตัวคูณที่ตั้งไว้</li>
        <li>บังคับ <strong>ขั้นต่ำ</strong> แล้ว <strong>ปัดเศษ</strong></li>
        <li>รวมกับ <strong>ค่าสินค้าจริง − ส่วนลด + VAT (ถ้าเลือก)</strong> ⇒ <strong>ยอดสุทธิ</strong></li>
      </ol>
      <div class="small text-muted">
        ทิป: เช็กราคาแปลก ๆ ด้วย 3 จุดนี้ — (1) ระยะในฐาน (2) เริ่มชั้น 2 ต้องมากกว่า “ระยะในฐาน” (3) ตัวคูณ 1.00/1.05/1.30 ตรงงานจริงหรือไม่
      </div>
    </div>
  </div>
</section>
    
  </div>

  <!-- Pretty print container (used for window.print) -->
  <div id="prettyPrint"></div>

  <script>
    // ===== Utils =====
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    const thBaht=n=>'฿'+(Math.round(n)).toLocaleString('th-TH');
    const stepRound=(n,step)=>step<=1?Math.round(n):Math.round(n/step)*step;
    const nowTH=()=>{ const now=new Date(); const tz=7*60; const local=new Date(now.getTime()+(tz-now.getTimezoneOffset())*60000); const d=local; const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0'); return {date:`${yyyy}-${mm}-${dd}`, time:`${hh}:${mi}`}; };
    const genInvNo=()=>{ const {date}=nowTH(); const yymmdd=date.replaceAll('-','').slice(2); let run=Number(localStorage.getItem('inv_seq')||'0')+1; localStorage.setItem('inv_seq', String(run)); return `AT${yymmdd}-${String(run).padStart(3,'0')}`; };

    // ===== Theme =====
    function applyTheme(){
      document.documentElement.style.setProperty('--primary',$('#ui_primary').value||'#7C3AED');
      document.documentElement.style.setProperty('--accent',$('#ui_accent').value||'#A78BFA');
    }

    // ===== Config =====
    function getCfg(){ return {
      base:+$('#cfg_base').value||0, incKm:+$('#cfg_incKm').value||0, perKm1:+$('#cfg_perKm1').value||0,
      tier2Start:+$('#cfg_tier2Start').value||0, perKm2:+$('#cfg_perKm2').value||0, minCharge:+$('#cfg_minCharge').value||0,
      stop:+$('#cfg_stop').value||0, wait:+$('#cfg_wait').value||0, night:+$('#cfg_night').value||0, rain:+$('#cfg_rain').value||0,
      weekend:+$('#cfg_weekend').value||0, roundTo:+$('#cfg_roundTo').value||1, multSize:+$('#cfg_multSize').value||1.0, multLabor:+$('#cfg_multLabor').value||1.0
    };}
    function applyBiz(){
      $('#bizNameView').textContent=$('#biz_name').value||'';
      $('#bizContactView').textContent='โทร '+($('#biz_phone').value||'')+' • LINE '+($('#biz_line').value||'');
      $('#bizAddrView').textContent=$('#biz_addr').value||'';
    }
    function saveCfg(){
      const cfg=getCfg();
      const ui={ primary:$('#ui_primary').value, accent:$('#ui_accent').value, dark: $('#ui_dark').checked?1:0 };
      const biz={ name:$('#biz_name').value, phone:$('#biz_phone').value, line:$('#biz_line').value, addr:$('#biz_addr').value, note:$('#biz_note').value };
      localStorage.setItem('cfg_v4', JSON.stringify({cfg,ui,biz}));
      alert('บันทึกการตั้งค่าแล้ว');
    }
    function loadCfg(){
      const d=JSON.parse(localStorage.getItem('cfg_v4')||'{}');
      if(!d||!d.cfg){ alert('ยังไม่มีการบันทึก'); return; }
      const c=d.cfg;
      $('#cfg_base').value=c.base; $('#cfg_incKm').value=c.incKm; $('#cfg_perKm1').value=c.perKm1; $('#cfg_tier2Start').value=c.tier2Start; $('#cfg_perKm2').value=c.perKm2; $('#cfg_minCharge').value=c.minCharge;
      $('#cfg_stop').value=c.stop; $('#cfg_wait').value=c.wait; $('#cfg_night').value=c.night; $('#cfg_rain').value=c.rain; $('#cfg_weekend').value=c.weekend; $('#cfg_roundTo').value=c.roundTo;
      $('#cfg_multSize').value=c.multSize; $('#cfg_multLabor').value=c.multLabor;
      if(d.ui){ $('#ui_primary').value=d.ui.primary||'#7C3AED'; $('#ui_accent').value=d.ui.accent||'#A78BFA'; $('#ui_dark').checked = d.ui.dark?true:false; document.documentElement.setAttribute('data-theme', d.ui.dark?'dark':'light'); }
      if(d.biz){ $('#biz_name').value=d.biz.name||''; $('#biz_phone').value=d.biz.phone||''; $('#biz_line').value=d.biz.line||''; $('#biz_addr').value=d.biz.addr||''; $('#biz_note').value=d.biz.note||''; }
      applyTheme(); applyBiz();
      alert('โหลดการตั้งค่าแล้ว');
    }
    function defaultCfg(){
      ['cfg_base','cfg_incKm','cfg_perKm1','cfg_tier2Start','cfg_perKm2','cfg_minCharge','cfg_stop','cfg_wait','cfg_night','cfg_rain','cfg_weekend'].forEach((id,i)=>{
        const def=[59,3,8,15,6,49,10,100,10,8,10][i]; document.getElementById(id).value=def;
      });
      $('#cfg_roundTo').value=5; $('#cfg_multSize').value=1.05; $('#cfg_multLabor').value=1.30;
      $('#ui_primary').value='#7C3AED'; $('#ui_accent').value='#A78BFA'; $('#ui_dark').checked=false; document.documentElement.setAttribute('data-theme','light');
      alert('คืนค่าเริ่มต้นแล้ว');
      applyTheme();
    }

    // ===== Compute =====
    function compute(){
      const cfg=getCfg(); let km=+($('#km').value||0); if($('#roundtrip').value==='yes') km*=2;
      const stops=+($('#stops').value||0), waitMin=+($('#wait').value||0), other=+($('#otherCost').value||0), discount=+($('#discount').value||0); const vatYes=$('#vat').value==='yes';
      let distCharge=0; if(km>cfg.incKm){
        const t1=Math.max(Math.min(km,cfg.tier2Start)-cfg.incKm,0); const t2=Math.max(km-Math.max(cfg.tier2Start,cfg.incKm),0);
        distCharge=(t1*cfg.perKm1)+(t2*cfg.perKm2);
      }
      const waitFee=Math.ceil(waitMin/15)*(cfg.wait/4); const stopFee=stops*cfg.stop;
      const sur=(($('#night').checked?cfg.night:0)+($('#rain').checked?cfg.rain:0)+($('#weekend').checked?cfg.weekend:0));
      let service=cfg.base+distCharge+waitFee+stopFee+sur;
      if($('#size').value==='medium') service*=cfg.multSize;
      if($('#workers').value==='2') service*=cfg.multLabor;
      if(service<cfg.minCharge) service=cfg.minCharge;
      const serviceRounded=stepRound(service, cfg.roundTo);
      let subtotal=serviceRounded+other-discount; if(subtotal<0) subtotal=0;
      const vat=vatYes?Math.round(subtotal*0.07):0; const grand=subtotal+vat;
      const lines=[];
      lines.push(['ฐาน/ในเมือง',thBaht(cfg.base)]);
      if(distCharge>0) lines.push(['ค่าระยะทาง',thBaht(distCharge)]);
      if(stopFee>0) lines.push([`จุดแวะ × ${stops}`,thBaht(stopFee)]);
      if(waitFee>0) lines.push([`รอคิว ${Math.ceil(waitMin/15)*15} นาที`,thBaht(waitFee)]);
      if(sur>0){ const s=[]; if($('#night').checked) s.push('กลางคืน'); if($('#rain').checked) s.push('ฝนตก'); if($('#weekend').checked) s.push('หยุด'); lines.push([`เงื่อนไข (${s.join(', ')})`,thBaht(sur)]); }
      if(serviceRounded!==service) lines.push(['ปัดเศษ',`→ ${thBaht(serviceRounded)}`]);
      if(other>0) lines.push(['ค่าสินค้าจริง',thBaht(other)]);
      if(discount>0) lines.push(['ส่วนลด','− '+thBaht(discount)]);
      if(vat>0) lines.push(['VAT 7%',thBaht(vat)]);
      $('#breakdownBox').innerHTML=lines.map(([l,r])=>`<div class="d-flex justify-content-between"><span>${l}</span><span class="tnum">${r}</span></div>`).join('');
      $('#grandLabel').textContent=thBaht(grand); $('#grandSummary').textContent=thBaht(grand);
      const last={ job:($('#jobName').value||'งานทั่วไป'), km:+($('#km').value||0), roundtrip:$('#roundtrip').value, stops, wait:waitMin, size:$('#size').value, workers:+($('#workers').value||1), night:$('#night').checked, rain:$('#rain').checked, weekend:$('#weekend').checked, other, discount, vat:$('#vat').value, service:serviceRounded, vatAmt:vat, grand };
      localStorage.setItem('last_calc', JSON.stringify(last)); return {last};
    }

    // ===== Receipt items =====
    function addRow(item='',qty=1,price=0){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="tnum"><span class="row-no"></span></td>
        <td><input class="item-name" value="${item}" placeholder="พิมพ์ชื่อรายการ"></td>
        <td><input type="number" class="item-price tnum" min="0" step="1" value="${Math.round(price)}"></td>
        <td><input type="number" class="item-qty tnum" min="0" step="1" value="${qty}"></td>
        <td class="tnum text-end"><span class="item-total">฿0</span> <button class="btn btn-sm btn-link text-danger btn-del">ลบ</button></td>`;
      $('#rc_items').appendChild(tr); renumberRows(); recalcReceipt();
    }
    function renumberRows(){ $$('#rc_items tr').forEach((tr,i)=>{ const no=tr.querySelector('.row-no'); if(no) no.textContent=String(i+1).padStart(2,'0'); }); }
    function recalcReceipt(){
      let sum=0;
      $$('#rc_items tr').forEach(tr=>{
        const qty=+(tr.querySelector('.item-qty')?.value||0);
        const price=+(tr.querySelector('.item-price')?.value||0);
        const total=qty*price;
        const cell=tr.querySelector('.item-total'); if(cell) cell.textContent=thBaht(total);
        sum+=total||0;
      });
      const other=+($('#rc_other').dataset.val||0), discount=+($('#rc_discount').dataset.val||0), vat=+($('#rc_vat').dataset.val||0);
      const grand=sum+other-discount+vat;
      $('#rc_total').textContent=thBaht(grand);
    }
    function clearReceipt(){
      $('#rc_items').innerHTML='<tr><td class="text-muted" colspan="5">— กด “สร้างบิล” เพื่อใส่อัตโนมัติ หรือ “เพิ่มบรรทัด” —</td></tr>';
      $('#rc_other').dataset.val=0; $('#rc_discount').dataset.val=0; $('#rc_vat').dataset.val=0;
      $('#rc_other').textContent='฿0'; $('#rc_discount').textContent='฿0'; $('#rc_vat').textContent='฿0'; $('#rc_total').textContent='฿0';
      const t=nowTH(); $('#inv_date').value=t.date; $('#inv_time').value=t.time; $('#inv_no').value=''; $('#inv_job').value=''; $('#inv_note').value=''; $('#cust_name').value=''; $('#cust_phone').value=''; $('#cust_addr').value=''; $('#cust_taxid').value='';
    }
    function createFromCalc(){
      let d=JSON.parse(localStorage.getItem('last_calc')||'{}'); if(!d||!d.service){ compute(); d=JSON.parse(localStorage.getItem('last_calc')||'{}'); }
      if(!d||!d.service){ alert('กรุณาคำนวณก่อน'); return; }
      if($('#rc_items').children.length && !$('#rc_items').querySelector('.text-muted')){ /* keep existing rows */ } else { $('#rc_items').innerHTML=''; }
      addRow(`ค่าบริการ: ${($('#jobName').value||'ทั่วไป')}`,1,d.service);
      $('#rc_other').dataset.val=Math.round(d.other||0); $('#rc_other').textContent=thBaht(d.other||0);
      $('#rc_discount').dataset.val=Math.round(d.discount||0); $('#rc_discount').textContent=thBaht(d.discount||0);
      $('#rc_vat').dataset.val=Math.round(d.vatAmt||0); $('#rc_vat').textContent=thBaht(d.vatAmt||0);
      recalcReceipt();
      const t=nowTH(); if(!$('#inv_date').value) $('#inv_date').value=t.date; if(!$('#inv_time').value) $('#inv_time').value=t.time; if(!$('#inv_job').value) $('#inv_job').value=$('#jobName').value||'งานทั่วไป'; if(!$('#inv_no').value) $('#inv_no').value=genInvNo(); $('#docTitleView').textContent=$('#docTitle').value;
    }

    // ===== Pretty output =====
    function getReceiptData(){
      const items = $$('#rc_items tr').map(tr => {
        const name=tr.querySelector('.item-name')?.value; if(!name) return null;
        return { name, qty:+(tr.querySelector('.item-qty')?.value||0), price:+(tr.querySelector('.item-price')?.value||0) };
      }).filter(Boolean).map(x=>({ ...x, total:x.qty*x.price }));
      const sum = items.reduce((s,x)=>s+(x.total||0),0);
      const other=+($('#rc_other').dataset.val||0), discount=+($('#rc_discount').dataset.val||0), vat=+($('#rc_vat').dataset.val||0);
      const sub = sum+other-discount;
      const grand = sub+vat;
      return {
        title: $('#docTitle').value,
        inv_no: $('#inv_no').value || '',
        date: $('#inv_date').value || nowTH().date,
        time: $('#inv_time').value || nowTH().time,
        job: $('#inv_job').value || '',
        note: $('#inv_note').value || '',
        cust: { name: $('#cust_name').value||'', phone: $('#cust_phone').value||'', addr: $('#cust_addr').value||'', taxid: $('#cust_taxid').value||'' },
        biz: { name: $('#biz_name').value||'', phone: $('#biz_phone').value||'', line: $('#biz_line').value||'', addr: $('#biz_addr').value||'', note: $('#biz_note').value||'' },
        assets: { logo: localStorage.getItem('biz_logo_data')||$('#biz_logo').value||'', qr: localStorage.getItem('biz_qr_data')||$('#biz_qr').value||'' },
        pay: { method: $('#pay_method').value||'', status: $('#pay_status').value||'ค้างชำระ', ref: $('#pay_ref').value||'', due: $('#pay_due').value||'' },
        items, sums: { sum, other, discount, sub, vat, grand }
      };
    }
    function buildPrettyDoc(data){
      const el=document.createElement('div'); el.className='pretty-doc';
      let cols=`<colgroup><col style="width:10%"><col style="width:50%"><col style="width:14%"><col style="width:10%"><col style="width:16%"></colgroup>`;
      el.innerHTML=`
      <div class="pretty-wrap">
        <div class="pretty-header">
          <div class="d-flex align-items-center gap-2">
            <div class="pretty-logo">${data.assets.logo?`<img src="${data.assets.logo}" style="max-width:100%;max-height:100%">`:`<span class="fw-bold" style="color:var(--primary)">LOGO</span>`}</div>
            <div>
              <div class="pretty-title">${data.title}</div>
              <div class="pretty-sub">${data.biz.name||''} • โทร ${data.biz.phone||''} • LINE ${data.biz.line||''}</div>
            </div>
          </div>
          <div class="text-end">
            <div><b>เลขที่:</b> ${data.inv_no||'-'}</div>
            <div><b>วันที่:</b> ${data.date||''} <span class="pretty-sub">เวลา ${data.time||''}</span></div>
            ${data.pay.due?`<div><b>ครบกำหนด:</b> ${data.pay.due}</div>`:''}
          </div>
          ${data.pay.status==='ชำระแล้ว'?`<div class="stamp">ชำระแล้ว</div>`:''}
        </div>

        <div class="pretty-body">
          <div class="row g-2">
            <div class="col-6">
              <div class="fw-bold">ออกเอกสารถึง</div>
              <div>${data.cust.name||'-'}</div>
              ${data.cust.phone?`<div class="pretty-sub">โทร ${data.cust.phone}</div>`:''}
              ${data.cust.addr?`<div class="pretty-sub">${data.cust.addr}</div>`:''}
              ${data.cust.taxid?`<div class="pretty-sub">เลขผู้เสียภาษี ${data.cust.taxid}</div>`:''}
            </div>
            <div class="col-6">
              <div class="fw-bold">รายละเอียดงาน</div>
              <div>${data.job||'-'}</div>
              ${data.note?`<div class="pretty-sub">หมายเหตุ: ${data.note}</div>`:''}
            </div>
          </div>

          <table class="pretty-table mt-2">
            ${cols}
            <thead><tr><th>ลำดับ</th><th>รายการ</th><th>ราคา/หน่วย</th><th>จำนวน</th><th>รวม</th></tr></thead>
            <tbody>
              ${data.items.map((it,i)=>`<tr>
                <td>${String(i+1).padStart(2,'0')}</td>
                <td>${it.name}</td>
                <td>${Math.round(it.price).toLocaleString('th-TH')}</td>
                <td>${it.qty}</td>
                <td>${Math.round(it.total).toLocaleString('th-TH')}</td>
              </tr>`).join('')}
              ${data.sums.other?`<tr><td>-</td><td>ค่าสินค้าตามจริง</td><td>${Math.round(data.sums.other).toLocaleString('th-TH')}</td><td>1</td><td>${Math.round(data.sums.other).toLocaleString('th-TH')}</td></tr>`:''}
              ${data.sums.discount?`<tr><td>-</td><td>ส่วนลดรวม</td><td>- ${Math.round(data.sums.discount).toLocaleString('th-TH')}</td><td>1</td><td>- ${Math.round(data.sums.discount).toLocaleString('th-TH')}</td></tr>`:''}
            </tbody>
          </table>

          <div class="row g-2 mt-2 align-items-end">
            <div class="col-md-6"><div class="pretty-sub">* คอลัมน์ถูกล็อกความกว้างไว้แล้ว • ใช้ตัวเลข tabular-nums</div></div>
            <div class="col-md-6">
              <div class="pill-sub d-flex justify-content-between"><span>รวมก่อนภาษี</span><span>฿${Math.round(data.sums.sub).toLocaleString('th-TH')}</span></div>
              <div class="pill-tax mt-2 d-flex justify-content-between"><span>VAT 7%</span><span>฿${Math.round(data.sums.vat).toLocaleString('th-TH')}</span></div>
              <div class="pill-total mt-2 d-flex justify-content-between"><span>รวมทั้งสิ้น</span><span>฿${Math.round(data.sums.grand).toLocaleString('th-TH')}</span></div>
            </div>
          </div>

          <div class="pretty-pay">
            <div>
              <div class="fw-bold">การชำระเงิน</div>
              <div>วิธี: ${data.pay.method||'-'} • สถานะ: ${data.pay.status||'-'}</div>
              ${data.pay.ref?`<div class="pretty-sub">เลขอ้างอิง: ${data.pay.ref}</div>`:''}
              ${data.biz.note?`<div class="pretty-sub mt-1">${data.biz.note}</div>`:''}
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div><div class="fw-bold">สแกนเพื่อชำระ</div><div class="pretty-sub">PromptPay/โอนเงิน</div></div>
              ${data.assets.qr?`<img src="${data.assets.qr}" style="width:120px;height:120px;object-fit:contain">`:`<div class="qr-box">QR</div>`}
            </div>
          </div>

          <div class="d-flex justify-content-between mt-2" style="color:#64748b">
            <div>ที่อยู่: ${data.biz.addr||'-'}</div>
            <div>โทร ${data.biz.phone||''} • LINE ${data.biz.line||''}</div>
          </div>
        </div>
      </div>`;
      return el;
    }
    async function capturePretty(to='png'){
      const data=getReceiptData(); const pretty=buildPrettyDoc(data);
      if(document.body.classList.contains('paper-a5')){ pretty.style.width='148mm'; }
      if(document.body.classList.contains('paper-80')){ pretty.style.width='80mm'; }
      const holder=document.createElement('div'); holder.style.position='fixed'; holder.style.left='-9999px'; holder.style.top='0'; holder.appendChild(pretty); document.body.appendChild(holder);
      const canvas=await html2canvas(pretty,{ scale:2, useCORS:true, backgroundColor:'#FFFFFF' });
      if(to==='png'){ const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='เอกสาร.png'; a.click(); }
      if(to==='pdf'){ const { jsPDF } = window.jspdf; const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'}); const img=canvas.toDataURL('image/png'); const pageW=pdf.internal.pageSize.getWidth(); const imgW=pageW-20; const imgH=canvas.height*imgW/canvas.width; pdf.addImage(img,'PNG',10,10,imgW,imgH); pdf.save('เอกสาร.pdf'); }
      document.body.removeChild(holder);
    }
    function printPretty(){
      const data=getReceiptData(); const pretty=buildPrettyDoc(data); const box=$('#prettyPrint'); box.innerHTML=''; box.appendChild(pretty); window.print(); setTimeout(()=>{ box.innerHTML=''; }, 300);
    }

    // ===== Save/Load invoices =====
    let invoices=[]; let invPage=1; const perPage=6;
    function saveBill(){
      const bill={ inv_no: $('#inv_no').value||genInvNo(), date: $('#inv_date').value||nowTH().date, time: $('#inv_time').value||nowTH().time, cust_name: $('#cust_name').value, job: $('#inv_job').value, totalText: $('#rc_total').textContent, pay_status: $('#pay_status').value };
      const arr=JSON.parse(localStorage.getItem('invoices')||'[]');
      const idx=arr.findIndex(x=>x.inv_no===bill.inv_no);
      if(idx>=0) arr[idx]=bill; else arr.push(bill);
      localStorage.setItem('invoices', JSON.stringify(arr));
      $('#inv_no').value=bill.inv_no; renderInvList(); alert('บันทึกแล้ว');
    }
    function renderInvList(){
      const q=($('#invSearch').value||'').toLowerCase().trim(); const f=$('#invFilter').value;
      const arr=JSON.parse(localStorage.getItem('invoices')||'[]');
      const filtered=arr.filter(inv=>{ const hay=(inv.inv_no+' '+inv.cust_name+' '+inv.job).toLowerCase(); const byQ=!q||hay.includes(q); const byF=(f==='all')||(f==='paid'&&inv.pay_status==='ชำระแล้ว')||(f==='unpaid'&&inv.pay_status!=='ชำระแล้ว'); return byQ&&byF; });
      invoices=arr; const total=filtered.length, pages=Math.max(1,Math.ceil(total/perPage)); if(invPage>pages) invPage=pages;
      const list=filtered.slice((invPage-1)*perPage,(invPage-1)*perPage+perPage);
      $('#invList').innerHTML=list.map(inv=>`<div class="d-flex align-items-center justify-content-between border rounded p-2">
        <div><div class="fw-semibold">${inv.inv_no}</div><div class="small subtle">${inv.date} ${inv.time} • ${inv.cust_name||'-'} • ${inv.job||'-'}</div></div>
        <div class="text-end"><span class="badge rounded-pill text-bg-${inv.pay_status==='ชำระแล้ว'?'success':'warning'}">${inv.pay_status}</span><div class="fw-bold">${inv.totalText||'฿0'}</div>
          <div class="mt-1 d-flex gap-1 justify-content-end">
            <button class="btn btn-sm btn-outline-secondary" data-act="load" data-id="${inv.inv_no}">ดู/แก้ไข</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${inv.inv_no}">ลบ</button>
          </div>
        </div></div>`).join('');
      $('#invMeta').textContent=`พบ ${total} บิล • หน้า ${invPage}/${pages}`;
      const pager=[];
      pager.push(`<li class="page-item ${invPage===1?'disabled':''}"><a class="page-link" href="#" data-page="${invPage-1}">ก่อนหน้า</a></li>`);
      for(let p=1;p<=pages;p++){ if(p===1||p===pages||Math.abs(p-invPage)<=1){ pager.push(`<li class="page-item ${p===invPage?'active':''}"><a class="page-link" href="#" data-page="${p}">${p}</a></li>`);} else if(Math.abs(p-invPage)===2){ pager.push('<li class="page-item disabled"><span class="page-link">…</span></li>'); } }
      pager.push(`<li class="page-item ${invPage===pages?'disabled':''}"><a class="page-link" href="#" data-page="${invPage+1}">ถัดไป</a></li>`);
      $('#invPager').innerHTML=pager.join('');
    }
    function loadBillById(id){
      const arr=JSON.parse(localStorage.getItem('invoices')||'[]');
      const bill=arr.find(x=>x.inv_no===id);
      if(!bill){ alert('ไม่พบบิล'); return; }
      // minimal: load header
      $('#inv_no').value=bill.inv_no; $('#inv_date').value=bill.date; $('#inv_time').value=bill.time;
      $('#cust_name').value=bill.cust_name||''; $('#inv_job').value=bill.job||'';
      // load status
      $('#pay_status').value=bill.pay_status||'ค้างชำระ';
      alert('โหลดบิลแล้ว (แก้ไขรายละเอียดเพิ่มเติมได้)');
    }
    function delBillById(id){
      const arr=JSON.parse(localStorage.getItem('invoices')||'[]');
      const idx=arr.findIndex(x=>x.inv_no===id);
      if(idx<0) return;
      if(confirm('ลบบิลนี้ใช่ไหม?')){
        arr.splice(idx,1); localStorage.setItem('invoices', JSON.stringify(arr)); renderInvList();
      }
    }

    // ===== Events =====
    window.addEventListener('DOMContentLoaded', ()=>{
      applyTheme(); applyBiz();
      const t=nowTH(); $('#inv_date').value=t.date; $('#inv_time').value=t.time;
      renderInvList();

      // Theme toggles
      $('#ui_primary').addEventListener('input', applyTheme); $('#ui_accent').addEventListener('input', applyTheme);
      $('#ui_dark').addEventListener('change',e=>document.documentElement.setAttribute('data-theme', e.target.checked?'dark':'light'));

      // Paper width
      $('#paperA4').addEventListener('click', ()=>{ document.body.classList.remove('paper-a5','paper-80'); document.body.classList.add('paper-a4'); });
      $('#paperA5').addEventListener('click', ()=>{ document.body.classList.remove('paper-a4','paper-80'); document.body.classList.add('paper-a5'); });
      $('#paper80').addEventListener('click', ()=>{ document.body.classList.remove('paper-a4','paper-a5'); document.body.classList.add('paper-80'); });

      // Config save/load
      $('#btnCfgSave').addEventListener('click', saveCfg);
      $('#btnCfgLoad').addEventListener('click', loadCfg);
      $('#btnCfgReset').addEventListener('click', defaultCfg);
      $('#toggleHints').addEventListener('click', ()=> $$('.hint').forEach(el=> el.style.display = (el.style.display==='none'?'':'none')) );

      // Compute
      $('#btnCompute').addEventListener('click', compute);
      $('#btnCreateReceipt').addEventListener('click', ()=>{ compute(); createFromCalc(); });
      $('#summaryCreate').addEventListener('click', ()=>{ compute(); createFromCalc(); });
      $('#btnSaveDraft').addEventListener('click', ()=>{ compute(); alert('บันทึกฉบับร่างแล้ว'); });
      $('#btnLoadLast').addEventListener('click', ()=>{
        const d=JSON.parse(localStorage.getItem('last_calc')||'{}'); if(!d||!Object.keys(d).length){ alert('ยังไม่มีฉบับร่าง'); return; }
        $('#jobName').value=d.job||''; $('#km').value=d.km||0; $('#roundtrip').value=d.roundtrip||'no'; $('#stops').value=d.stops||0; $('#wait').value=d.wait||0; $('#otherCost').value=d.other||0; $('#discount').value=d.discount||0; $('#vat').value=d.vat||'no'; $('#size').value=d.size||'small'; $('#workers').value=String(d.workers||1); $('#night').checked=!!d.night; $('#rain').checked=!!d.rain; $('#weekend').checked=!!d.weekend; compute();
      });
      $('#btnCopySummary').addEventListener('click', ()=>{ const text=$('#breakdownBox').innerText+'\\nรวม: '+$('#grandLabel').innerText; navigator.clipboard.writeText(text).then(()=>alert('คัดลอกแล้ว')); });

      // Items
      $('#btnAddRow').addEventListener('click', ()=> addRow('',1,0));
      $('#rc_items').addEventListener('input', (e)=>{ if(e.target.matches('.item-qty,.item-price,.item-name')) recalcReceipt(); renumberRows(); });
      $('#rc_items').addEventListener('click', (e)=>{ if(e.target.closest('.btn-del')){ e.preventDefault(); const tr=e.target.closest('tr'); tr.parentElement.removeChild(tr); if(!$('#rc_items').children.length){ $('#rc_items').innerHTML='<tr><td class="text-muted" colspan="5">— กด “สร้างบิล” เพื่อใส่อัตโนมัติ หรือ “เพิ่มบรรทัด” —</td></tr>'; } renumberRows(); recalcReceipt(); } });

      // Biz inputs
      ['biz_name','biz_phone','biz_line','biz_addr','biz_note'].forEach(id=>document.getElementById(id).addEventListener('input', applyBiz));
      function setImg(inputUrl, inputFile, key){ if(inputFile.files?.[0]){ const fr=new FileReader(); fr.onload=()=> localStorage.setItem(key, fr.result); fr.readAsDataURL(inputFile.files[0]); } else if(inputUrl.value) localStorage.setItem(key, inputUrl.value); }
      $('#biz_logo').addEventListener('change',()=>setImg($('#biz_logo'),$('#biz_logo_file'),'biz_logo_data')); $('#biz_logo_file').addEventListener('change',()=>setImg($('#biz_logo'),$('#biz_logo_file'),'biz_logo_data'));
      $('#biz_qr').addEventListener('change',()=>setImg($('#biz_qr'),$('#biz_qr_file'),'biz_qr_data')); $('#biz_qr_file').addEventListener('change',()=>setImg($('#biz_qr'),$('#biz_qr_file'),'biz_qr_data'));

      // Capture/Print
      $('#btnCapClean').addEventListener('click', ()=> capturePretty('png'));
      $('#btnPDF').addEventListener('click', ()=> capturePretty('pdf'));
      $('#btnPrint').addEventListener('click', printPretty);
      $('#summaryPrint').addEventListener('click', printPretty);

      // Save Bill
      $('#btnSaveBill').addEventListener('click', saveBill);
      $('#btnNewBill').addEventListener('click', clearReceipt);

      // Pager
      $('#invPager').addEventListener('click', (e)=>{ if(e.target.matches('a.page-link')){ e.preventDefault(); invPage=Number(e.target.dataset.page||1); renderInvList(); } });
      $('#invSearch').addEventListener('input',()=>{ invPage=1; renderInvList(); });
      $('#invFilter').addEventListener('change',()=>{ invPage=1; renderInvList(); });
      // Load/Del buttons inside list
      $('#invList').addEventListener('click', (e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const act=btn.dataset.act, id=btn.dataset.id;
        if(act==='load') loadBillById(id);
        if(act==='del') delBillById(id);
      });

      // Hide hints initially on mobile for compactness
      if(window.innerWidth<780){ $$('.hint').forEach(el=> el.style.display='none'); }
    });
  </script>

<script>
// --- Quick Preview below the LocalStorage list ---
(function(){
  function getStore(){ try { return JSON.parse(localStorage.getItem('invoices')||'[]')||[]; } catch(e){ return []; } }
  function findById(id){ return getStore().find(x=>x.inv_no===id) || null; }
  function htmlEscape(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
  function renderInvPreview(bill){
    const box = document.getElementById('invPreview');
    if(!box) return;
    if(!bill){ box.innerHTML = '<div class="subtle small">ยังไม่ได้เลือกบิล</div>'; return; }
    box.innerHTML = `
      <div class="row g-2">
        <div class="col-md-7">
          <div class="small subtle">เลขที่บิล</div>
          <div class="fw-semibold">${htmlEscape(bill.inv_no||'-')}</div>
          <div class="small subtle mt-2">ลูกค้า</div>
          <div>${htmlEscape(bill.cust_name||'-')}</div>
          <div class="small subtle mt-2">งาน/รายละเอียด</div>
          <div>${htmlEscape(bill.job||'-')}</div>
        </div>
        <div class="col-md-5 text-md-end">
          <div class="small subtle">วันที่/เวลา</div>
          <div>${htmlEscape(bill.date||'-')} ${htmlEscape(bill.time||'')}</div>
          <div class="small subtle mt-2">สถานะ</div>
          <div><span class="badge rounded-pill text-bg-${(bill.pay_status||'').includes('ชำระแล้ว')?'success':'warning'}">${htmlEscape(bill.pay_status||'-')}</span></div>
          <div class="small subtle mt-2">ยอดสุทธิ</div>
          <div class="h5 mb-0">${htmlEscape(bill.totalText||'฿0')}</div>
        </div>
      </div>`;
  }
  window.showInvPreviewById = function(id){ renderInvPreview(findById(id)); };

  document.addEventListener('DOMContentLoaded', function(){
    var list = document.getElementById('invList');
    if(list){
      list.addEventListener('click', function(e){
        var btn = e.target.closest('button[data-act="load"]');
        if(btn){ window.showInvPreviewById(btn.dataset.id); }
      });
    }
  });
})();
</script>





<!-- === Cloud sync for Calculator Config & Invoices (Firestore) — SAFE FOR ADMIN === -->
<script type="module">
  import { db, ensureAnonAuth } from './firebase-init.js';
  import { doc, getDoc, setDoc, onSnapshot } 
    from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
  import { getAuth, onAuthStateChanged } 
    from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

  const auth = getAuth();
  const cfgRef = doc(db, 'settings', 'calculator_v4');

  // รอให้ session เดิม (เช่น admin) ฟื้นก่อน ถ้ายังไม่มีและไม่ได้อยู่โหมด admin ค่อยล็อกอินนิรนาม
  async function safeAuth(){
    const role = (localStorage.getItem('role')||'').toLowerCase();
    if (role === 'owner' || role === 'admin') return;

    await new Promise(resolve => {
      let done = false;
      const t = setTimeout(async () => {
        if (!auth.currentUser) {
          try { if (typeof ensureAnonAuth === 'function') await ensureAnonAuth(); } catch(e){}
        }
        resolve();
      }, 800);
      onAuthStateChanged(auth, (u)=>{
        if (u) { clearTimeout(t); resolve(); }
      });
    });
  }

  async function loadCfgCloud(){
    try{
      const snap = await getDoc(cfgRef);
      if (snap.exists()){
        localStorage.setItem('cfg_v4', JSON.stringify(snap.data()));
        console.log('[cfg] loaded from Firestore');
        try{ window.loadCfg && window.loadCfg(); }catch(e){}
      }
    }catch(e){ console.error('[cfg] load error:', e); }
  }

  async function syncCfgToCloud(){
    try{
      const payload = JSON.parse(localStorage.getItem('cfg_v4')||'{}');
      await setDoc(cfgRef, payload, { merge:true });
      console.log('[cfg] synced to Firestore');
    }catch(e){ console.error('[cfg] sync error:', e); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnCfgSave');
    if (btn){
      btn.addEventListener('click', async ()=>{
        try{ window.saveCfg && window.saveCfg(); }catch(e){}
        await syncCfgToCloud();
      });
    }
  });

  (function(){
    const btnBill = document.getElementById('btnSaveBill');
    if (!btnBill) return;
    btnBill.addEventListener('click', async ()=>{
      const before = localStorage.getItem('invoices')||'[]';
      setTimeout(async ()=>{
        try{
          const after = JSON.parse(localStorage.getItem('invoices')||'[]');
          const bill = after.at(-1);
          if (bill?.inv_no){
            await setDoc(doc(db,'invoices', String(bill.inv_no)), bill, { merge:true });
            console.log('[invoice] saved:', bill.inv_no);
          }
        }catch(e){ console.error('[invoice] sync error:', e); }
      }, 50);
    });
  })();

  document.addEventListener('DOMContentLoaded', async ()=>{
    await safeAuth();
    await loadCfgCloud();
    setTimeout(loadCfgCloud, 400);
    setTimeout(loadCfgCloud, 1200);
    try{ onSnapshot(cfgRef, s=>{ if(s.exists()){ localStorage.setItem('cfg_v4', JSON.stringify(s.data())); } }); }catch(e){}
  });
</script>


<!-- PWA SW register (assistant v35) -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js');
  });
}
</script>

<script src="assets/sw-register.js"></script>
<script src="assets/perf-boost.js"></script>
</body>
</html>
