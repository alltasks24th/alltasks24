<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>alltasks24 — Admin</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">

  <!-- Favicons / PWA -->
  <link rel="icon" href="/icons/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/icons/site.webmanifest">
  <meta name="theme-color" content="#6C37FF">

  <style>
    :root{ --border:#e9ecef; }
    body{ font-family:"Kanit",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .sidebar{min-width:260px;max-width:260px;background:#fff;border-right:1px solid var(--border);min-height:100vh;position:sticky;top:0}
    .nav-pills .nav-link.active{background:#6C37FF}
    .card-clean{border:1px solid var(--border);border-radius:14px;background:#fff}
    .stat{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px}
    .text-hint{font-size:.85rem;color:#6b7280}
  </style>
</head>
<body>

<!-- Topbar -->
<nav class="navbar bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <span class="navbar-brand">alltasks24 — Admin</span>
    <div class="d-flex align-items-center gap-2">
      <span class="badge text-bg-warning">รีวิวใหม่ <span id="countNewReviews">0</span></span>
      <button id="btnLogout" class="btn btn-outline-primary btn-sm"><i class="bi bi-box-arrow-right me-1"></i>ออกจากระบบ</button>
    </div>
  </div>
</nav>

<div class="d-flex">
  <!-- Sidebar -->
  <aside class="sidebar p-3 d-none d-md-block">
    <div class="nav nav-pills flex-column gap-1">
      <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-dashboard"><i class="bi bi-speedometer2 me-2"></i>แดชบอร์ด</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-services"><i class="bi bi-grid me-2"></i>บริการ</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-areas"><i class="bi bi-geo-alt me-2"></i>พื้นที่</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-bookings"><i class="bi bi-calendar-check me-2"></i>การจอง</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tickets"><i class="bi bi-inbox me-2"></i>คำขอ/แจ้งปัญหา</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reviews"><i class="bi bi-chat-quote me-2"></i>รีวิว</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-users"><i class="bi bi-people me-2"></i>ผู้ใช้/บทบาท</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-promos"><i class="bi bi-ticket-perforated me-2"></i>โปรโมชัน</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-banners"><i class="bi bi-images me-2"></i>แบนเนอร์</button>
      <button class="nav-link" id="tab-products-tab" data-bs-toggle="pill" data-bs-target="#tab-products"><i class="bi bi-bag me-2"></i>ร้านค้า</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-faq"><i class="bi bi-question-circle me-2"></i>FAQ</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-settings"><i class="bi bi-gear me-2"></i>ตั้งค่า</button>
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-chat"><i class="bi bi-chat-dots me-2"></i>แชทสด</button>
    </div>
  </aside>

  <!-- Content -->
  <main class="flex-grow-1 p-3">
    <div class="tab-content">

      <!-- Dashboard -->
      <div class="tab-pane fade show active" id="tab-dashboard">
        <div class="row g-3 mb-3">
          <div class="col-md-3"><div class="stat"><div class="text-muted">คำขอจอง</div><div class="h4 mb-0" id="countBookings">0</div></div></div>
          <div class="col-md-3"><div class="stat"><div class="text-muted">ผู้ใช้งาน (roles)</div><div class="h4 mb-0" id="countUsers">0</div></div></div>
          <div class="col-md-3"><div class="stat"><div class="text-muted">โปรโมชัน</div><div class="h4 mb-0" id="countPromos">0</div></div></div>
        </div>
        <!-- เนื้อหา dashboard อื่นๆ ของคุณ -->
      </div>

      <!-- Services -->
      <div class="tab-pane fade" id="tab-services">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">จัดการบริการ</h5>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#svcModal"><i class="bi bi-plus-lg me-1"></i>เพิ่มบริการ</button>
        </div>
        <table class="table table-hover align-middle">
          <thead><tr><th>ชื่อบริการ</th><th>หมวดหมู่</th><th>ภาพ</th><th class="text-end">จัดการ</th></tr></thead>
          <tbody id="svcTableBody"></tbody>
        </table>
      </div>

      <!-- Areas / Bookings / Tickets / Reviews / Users … -->
      <div class="tab-pane fade" id="tab-areas"></div>
      <div class="tab-pane fade" id="tab-bookings"></div>
      <div class="tab-pane fade" id="tab-tickets"></div>
      <div class="tab-pane fade" id="tab-reviews"></div>
      <div class="tab-pane fade" id="tab-users"></div>

      <!-- Promotions -->
      <div class="tab-pane fade" id="tab-promos">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">โปรโมชัน</h5>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#promoModal"><i class="bi bi-plus-lg me-1"></i>เพิ่มโปรโมชัน</button>
        </div>
        <table class="table table-hover">
          <thead><tr><th>ชื่อ</th><th>ช่วงเวลา</th><th>คำอธิบาย</th><th class="text-end">จัดการ</th></tr></thead>
          <tbody id="promoTableBody"></tbody>
        </table>
      </div>

      <!-- Banners -->
      <div class="tab-pane fade" id="tab-banners">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">แบนเนอร์สไลด์</h5>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bannerModal"><i class="bi bi-plus-lg me-1"></i>เพิ่มสไลด์</button>
        </div>
        <table class="table table-hover">
          <thead><tr><th>หัวเรื่อง</th><th>คำอธิบาย</th><th>ภาพ</th><th class="text-end">จัดการ</th></tr></thead>
          <tbody id="bannerTableBody"></tbody>
        </table>
      </div>

      <!-- Products -->
      <div class="tab-pane fade" id="tab-products" role="tabpanel" aria-labelledby="tab-products-tab">
        <div class="row g-3 mt-3">
          <div class="col-lg-5">
            <div class="card">
              <div class="card-header fw-semibold">เพิ่ม/แก้สินค้า</div>
              <div class="card-body">
                <form id="productForm">
                  <input type="hidden" id="prodId">
                  <div class="mb-2"><label class="form-label">ชื่อ</label><input id="name" class="form-control" required></div>
                  <div class="mb-2"><label class="form-label">คำอธิบาย</label><textarea id="desc" class="form-control" rows="3"></textarea></div>

                  <div class="row g-2">
                    <div class="col-6"><label class="form-label">ราคา (฿)</label><input id="price" type="number" class="form-control" required></div>
                    <div class="col-6"><label class="form-label">หน่วย</label><input id="unit" class="form-control" placeholder="ครั้ง / แพ็ก / เที่ยว"></div>
                  </div>

                  <div class="row g-2 mt-1">
                    <div class="col-4"><label class="form-label">Sale (฿)</label><input id="salePrice" type="number" class="form-control"></div>
                    <div class="col-4"><label class="form-label">เริ่มโปรฯ</label><input id="saleStart" type="datetime-local" class="form-control"></div>
                    <div class="col-4"><label class="form-label">จบโปรฯ</label><input id="saleEnd" type="datetime-local" class="form-control"></div>
                  </div>

                  <div class="mt-2">
                    <label class="form-label">รูปปก (URL หรืออัปโหลด)</label>
                    <div class="input-group">
                      <input id="cover" class="form-control" placeholder="https://...">
                      <input id="coverFile" type="file" accept="image/*" class="form-control" style="max-width:240px">
                    </div>
                  </div>

                  <div class="mt-2">
                    <label class="form-label">แกลเลอรี (คั่นด้วย , )</label>
                    <div class="input-group">
                      <input id="gallery" class="form-control" placeholder="https://..., https://...">
                      <input id="galleryFiles" type="file" accept="image/*" multiple class="form-control" style="max-width:280px">
                    </div>
                    <div class="text-hint mt-1">เลือกหลายไฟล์ได้ ระบบจะเติม URL ต่อท้ายโดยคั่นด้วย ,</div>
                  </div>

                  <div class="mt-2"><label class="form-label">แท็ก (คั่นด้วย , )</label><input id="tags" class="form-control" placeholder="ทำความสะอาด, โปรฯ"></div>

                  <div class="row g-2 mt-1">
                    <div class="col-4"><label class="form-label">สต็อก</label><input id="stock" type="number" class="form-control" placeholder="เว้นได้"></div>
                    <div class="col-4"><label class="form-label">ลำดับ (rank)</label><input id="rank" type="number" class="form-control" value="999"></div>
                    <div class="col-4"><label class="form-label">โปรโมชัน</label><input id="promoText" class="form-control" placeholder="ส่งฟรี/คูปอง..."></div>
                  </div>

                  <div class="row g-2 mt-2">
                    <div class="col-6">
                      <div class="form-check"><input id="featured" class="form-check-input" type="checkbox"><label class="form-check-label" for="featured">แนะนำ (หน้าแรก)</label></div>
                      <div class="form-check"><input id="isBestSeller" class="form-check-input" type="checkbox"><label class="form-check-label" for="isBestSeller">ฮิต</label></div>
                      <div class="form-check"><input id="isNew" class="form-check-input" type="checkbox"><label class="form-check-label" for="isNew">ใหม่</label></div>
                    </div>
                    <div class="col-6">
                      <div class="form-check"><input id="freeShip" class="form-check-input" type="checkbox"><label class="form-check-label" for="freeShip">ส่งฟรี</label></div>
                      <div class="form-check"><input id="isActive" class="form-check-input" type="checkbox" checked><label class="form-check-label" for="isActive">เปิดแสดง</label></div>
                    </div>
                  </div>

                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" id="btnSave" type="submit">บันทึก</button>
                    <button class="btn btn-secondary" id="btnReset" type="button">ล้างฟอร์ม</button>
                    <button class="btn btn-outline-danger d-none" id="btnDelete" type="button">ลบ</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card">
              <div class="card-header fw-semibold d-flex justify-content-between">
                รายการสินค้า <span class="small text-muted">เรียงตาม rank</span>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="width:56px">ลำดับ</th>
                        <th>ชื่อ</th>
                        <th>ราคา</th>
                        <th>แท็ก</th>
                        <th>แนะนำ</th>
                        <th>เปิด</th>
                        <th style="width:160px">จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div><!-- /row -->
      </div><!-- /products -->

      <!-- FAQ / Settings / Chat -->
      <div class="tab-pane fade" id="tab-faq"></div>
      <div class="tab-pane fade" id="tab-settings"></div>
      <div class="tab-pane fade" id="tab-chat"></div>

    </div><!-- /.tab-content -->
  </main>
</div>

<!-- ====== Modals ====== -->
<!-- Service Modal -->
<div class="modal fade" id="svcModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">บริการ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input id="svcId" type="hidden">
        <label class="form-label">ชื่อบริการ</label><input id="svcName" class="form-control">
        <label class="form-label mt-2">หมวดหมู่</label><input id="svcCat" class="form-control">

        <!-- URL + File -->
        <label class="form-label mt-2">ภาพ</label>
        <div class="input-group">
          <input id="svcImg" class="form-control" placeholder="https://...">
          <input id="svcImgFile" type="file" accept="image/*" class="form-control" style="max-width:240px">
        </div>
        <small class="text-hint">วางลิงก์หรือเลือกไฟล์จากเครื่องก็ได้</small>

        <label class="form-label mt-2">รายละเอียด</label><textarea id="svcDesc" rows="3" class="form-control"></textarea>

        <label class="form-label mt-2">ป้ายกำกับ (คั่นด้วย , )</label>
        <input id="svcTags" class="form-control" placeholder="เช่น ด่วน 24 ชม., รายครั้ง, รายเดือน">

        <label class="form-label mt-2">แกลเลอรีผลงาน (1 ลิงก์ต่อ 1 บรรทัด)</label>
        <textarea id="svcGallery" rows="4" class="form-control" placeholder="https://...1.jpg
https://...2.jpg"></textarea>

        <!-- Upload gallery multi -->
        <div class="mt-2">
          <label class="form-label">อัปโหลดแกลเลอรี</label>
          <input id="svcGalleryFiles" type="file" accept="image/*" multiple class="form-control" style="max-width:280px">
          <small class="text-hint">เลือกหลายไฟล์ได้ ระบบจะเติมลิงก์ลงกล่องด้านบน (ขึ้นบรรทัดใหม่)</small>
        </div>
      </div>
      <div class="modal-footer"><button id="svcSave" class="btn btn-primary">บันทึก</button></div>
    </div>
  </div>
</div>

<!-- Promotion Modal -->
<div class="modal fade" id="promoModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">โปรโมชัน</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input id="promoId" type="hidden">
        <label class="form-label">ชื่อ</label><input id="promoTitle" class="form-control">
        <label class="form-label mt-2">คำอธิบาย</label><textarea id="promoDesc" class="form-control"></textarea>

        <!-- URL + File -->
        <label class="form-label mt-2">ภาพ</label>
        <div class="input-group">
          <input id="promoImg" class="form-control" placeholder="https://...">
          <input id="promoImgFile" type="file" accept="image/*" class="form-control" style="max-width:240px">
        </div>

        <div class="row mt-2">
          <div class="col"><label class="form-label">เริ่ม</label><input id="promoStart" type="date" class="form-control"></div>
          <div class="col"><label class="form-label">สิ้นสุด</label><input id="promoEnd" type="date" class="form-control"></div>
        </div>
      </div>
      <div class="modal-footer"><button id="promoSave" class="btn btn-primary">บันทึก</button></div>
    </div>
  </div>
</div>

<!-- Banner Modal -->
<div class="modal fade" id="bannerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">แบนเนอร์</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input id="banId" type="hidden">
        <label class="form-label">หัวเรื่อง</label><input id="banTitle" class="form-control">
        <label class="form-label mt-2">คำอธิบาย</label><input id="banSub" class="form-control">

        <!-- URL + File -->
        <label class="form-label mt-2">ภาพ</label>
        <div class="input-group">
          <input id="banImg" class="form-control" placeholder="https://...">
          <input id="banImgFile" type="file" accept="image/*" class="form-control" style="max-width:240px">
        </div>
      </div>
      <div class="modal-footer"><button id="banSave" class="btn btn-primary">บันทึก</button></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- ต้องมาก่อน admin.js -->
<script type="module" src="firebase-init.js"></script>
<script type="module" src="auth.js"></script>
<script type="module" src="admin.js"></script>

<!-- ===== ตัวช่วยอัปโหลดรูป (ไม่แตะ admin.js เดิม) ===== -->
<script type="module">
  import { getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const app = getApps().length ? getApp() : null;
  const storage = app ? getStorage(app) : getStorage();

  async function upUploadOne(fileEl, inputEl, folder){
    const f = fileEl?.files?.[0];
    if(!f || !inputEl) return;
    const safe = f.name.replace(/[^\w.\-]+/g,'_');
    const key  = `${folder}/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${safe}`;
    const snap = await uploadBytes(ref(storage, key), f);
    const url  = await getDownloadURL(snap.ref);
    inputEl.value = url;
    fileEl.value = "";
  }

  async function upUploadManyToLines(fileEl, textareaEl, folder){
    const files = Array.from(fileEl?.files||[]);
    if(!files.length || !textareaEl) return;
    const urls = [];
    for(const f of files){
      const safe = f.name.replace(/[^\w.\-]+/g,'_');
      const key  = `${folder}/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${safe}`;
      const snap = await uploadBytes(ref(storage, key), f);
      urls.push(await getDownloadURL(snap.ref));
    }
    const cur = (textareaEl.value||'').trim();
    textareaEl.value = [cur, ...urls].filter(Boolean).join('\n');
    fileEl.value = "";
  }

  async function upUploadManyToCsv(fileEl, inputEl, folder){
    const files = Array.from(fileEl?.files||[]);
    if(!files.length || !inputEl) return;
    const urls = [];
    for(const f of files){
      const safe = f.name.replace(/[^\w.\-]+/g,'_');
      const key  = `${folder}/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${safe}`;
      const snap = await uploadBytes(ref(storage, key), f);
      urls.push(await getDownloadURL(snap.ref));
    }
    const cur = (inputEl.value||'').split(',').map(s=>s.trim()).filter(Boolean);
    inputEl.value = [...cur, ...urls].join(', ');
    fileEl.value = "";
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    // Services
    document.getElementById('svcImgFile')?.addEventListener('change', ()=> 
      upUploadOne(document.getElementById('svcImgFile'), document.getElementById('svcImg'), 'services')
    );
    document.getElementById('svcGalleryFiles')?.addEventListener('change', ()=> 
      upUploadManyToLines(document.getElementById('svcGalleryFiles'), document.getElementById('svcGallery'), 'services/gallery')
    );

    // Promotions
    document.getElementById('promoImgFile')?.addEventListener('change', ()=> 
      upUploadOne(document.getElementById('promoImgFile'), document.getElementById('promoImg'), 'promotions')
    );

    // Banners
    document.getElementById('banImgFile')?.addEventListener('change', ()=> 
      upUploadOne(document.getElementById('banImgFile'), document.getElementById('banImg'), 'banners')
    );

    // Products
    document.getElementById('coverFile')?.addEventListener('change', ()=> 
      upUploadOne(document.getElementById('coverFile'), document.getElementById('cover'), 'products')
    );
    document.getElementById('galleryFiles')?.addEventListener('change', ()=> 
      upUploadManyToCsv(document.getElementById('galleryFiles'), document.getElementById('gallery'), 'products')
    );
  });
</script>

</body>
</html>
