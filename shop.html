<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>สินค้าทั้งหมด | alltasks24</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#6f3cff;         /* โทนม่วงเดียวกับหน้าแรก */
      --primary-100:#ede9fe;
      --chip-bg:#f3f4f6;
      --sale:#ef4444;
      --ok:#10b981;
      --muted:#6b7280;
      --card-shadow:0 6px 18px rgba(0,0,0,.06);
      --page-bg:#f6f3ff;
    }
    body{ background:var(--page-bg); }

    .btn-primary{ background:var(--primary); border-color:var(--primary); }
    .btn-primary:hover{ filter:brightness(0.95); }
    .badge-soft{ background:var(--chip-bg); color:#374151; font-weight:600; }

    /* การ์ดสินค้า */
    .product-card{ box-shadow:var(--card-shadow); border:0; border-radius:18px; overflow:hidden; }
    .thumb{ position:relative; overflow:hidden; background:#fff; }
    .thumb img{ width:100%; height:220px; object-fit:cover; display:block; }
    .sale-badge{
      position:absolute; top:.5rem; left:.5rem; z-index:3;
      background:var(--sale); color:#fff; border-radius:10px; padding:.2rem .5rem;
      font-weight:700; font-size:.85rem;
    }
    .stock-badge{
      position:absolute; top:.5rem; right:.5rem; z-index:3;
      background:#111827; color:#fff; opacity:.9; border-radius:10px; padding:.2rem .55rem;
      font-size:.8rem; font-weight:700;
    }

    .price{ font-weight:800; }
    .price .old{ color:#9ca3af; text-decoration:line-through; font-weight:600; margin-left:.25rem; }

    /* skeleton ตอนโหลด */
    .skeleton{ background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%); background-size:400% 100%; animation:shimmer 1.2s infinite; border-radius:14px; }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .sk-thumb{ height:220px; }
    .sk-line{ height:14px; margin-top:10px; }
    .sk-line-lg{ height:18px; margin-top:12px; }

    /* โมดัล */
    .modal-header{ border-bottom:0; }
    .modal-body .big{ font-size:1.25rem; }
    .modal .carousel-item img{ height:320px; object-fit:cover; }
  </style>
</head>
<body>

  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <div class="text-muted small">รับจ้างสารพัด 24 ชั่วโมง</div>
        <h1 class="h4 fw-bold mb-0">สินค้าทั้งหมด</h1>
        <div id="resultCount" class="text-muted small"></div>
      </div>
      <a href="index.html" class="btn btn-outline-secondary btn-sm">กลับหน้าแรก</a>
    </div>

    <!-- แถบค้นหา/กรอง -->
    <div class="bg-white border rounded-3 p-3 mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-5">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input id="q" class="form-control" placeholder="ค้นหา (ชื่อ/แท็ก)">
            <button id="btnClear" class="btn btn-outline-secondary">ล้าง</button>
          </div>
        </div>
        <div class="col-md-3">
          <select id="sort" class="form-select">
            <option value="rank">เรียงตามลำดับ (rank)</option>
            <option value="new">มาใหม่ก่อน</option>
            <option value="price-asc">ราคาต่ำ→สูง</option>
            <option value="price-desc">ราคาสูง→ต่ำ</option>
          </select>
        </div>
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="onlyFeatured">
            <label class="form-check-label" for="onlyFeatured">แสดงเฉพาะแนะนำ</label>
          </div>
        </div>
      </div>
    </div>

    <!-- กริดสินค้า -->
    <div id="grid" class="row g-3"></div>

    <!-- หน้า -->
    <div class="d-flex justify-content-center gap-2 mt-4">
      <button id="prev" class="btn btn-outline-secondary btn-sm">&lt; ก่อนหน้า</button>
      <span id="pageInfo" class="align-self-center small text-muted">1 / 1</span>
      <button id="next" class="btn btn-outline-secondary btn-sm">ถัดไป &gt;</button>
    </div>
  </div>

  <!-- Modal รายละเอียดสินค้า -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="pmTitle" class="modal-title fw-bold"></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="pmCarouselWrap" class="mb-3">
            <div id="pmCarousel" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner" id="pmSlides"></div>
              <button class="carousel-control-prev" type="button" data-bs-target="#pmCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#pmCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>
          </div>

          <div class="big mb-1">
            <span id="pmPrice" class="price"></span>
          </div>
          <div class="mb-1">
            <span class="text-muted">หมวด/แท็ก:</span>
            <span id="pmTags"></span>
          </div>
          <div class="mb-1"><span class="text-muted">สต็อก:</span> <span id="pmStock" class="fw-semibold"></span></div>
          <div id="pmPromoTime" class="text-muted small mb-2"></div>
          <div id="pmDesc" class="mb-2"></div>

          <div class="d-flex gap-2">
            <a id="btnCall" class="btn btn-primary"><i class="bi bi-telephone-fill me-1"></i>โทร</a>
            <a id="btnLine" class="btn btn-success"><i class="bi bi-line me-1"></i>LINE</a>
            <a id="btnFb"   class="btn btn-primary" style="background:#1877f2;border-color:#1877f2"><i class="bi bi-facebook me-1"></i>Facebook</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase init ของโปรเจค -->
  <script type="module" src="firebase-init.js"></script>

  <!-- โค้ดหน้า shop -->
  <script type="module">
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { app } from './firebase-init.js'; // ต้อง export app ใน firebase-init.js (หน้าอื่นๆ ใช้อยู่แล้ว)

    const db = getFirestore(app);

    // ===== helpers =====
    const $ = s => document.querySelector(s);
    const el = (tag, cls) => { const e = document.createElement(tag); if(cls) e.className = cls; return e; };

    const fmtBaht = n => '฿' + (Number(n||0)).toLocaleString('th-TH');
    const toDate = v => {
      if(!v) return null;
      if(typeof v === 'string') return new Date(v);
      if(v.seconds) return new Date(v.seconds*1000);
      return new Date(v);
    };
    const now = () => new Date();

    const saleActive = p => {
      if(!p.salePrice) return false;
      const s = toDate(p.saleStart), e = toDate(p.saleEnd), t = now();
      if(s && t < s) return false;
      if(e && t > e) return false;
      return true;
    };
    const discountPercent = p => {
      if(!saleActive(p)) return 0;
      const old = Number(p.price||0), s = Number(p.salePrice||0);
      if(!old || s>=old) return 0;
      return Math.round((1 - (s/old))*100);
    };

    // settings (โทร/ไลน์/เฟซ)
    let SETTINGS = { phone:'', line:'', facebook:'' };
    async function loadSettings(){
      try{
        const snap = await getDocs(collection(db,'settings'));
        if(!snap.empty){
          const any = snap.docs[0].data();
          SETTINGS.phone    = any.phone || any.tel || '';
          SETTINGS.line     = any.line  || '';
          SETTINGS.facebook = any.facebook || '';
        }
      }catch(e){ /* เงียบไว้ */ }
    }

    // ===== query & render =====
    let RAW = [];
    let PAGE = 1, PER = 12;

    function renderSkeleton(count=6){
      const grid = $('#grid'); grid.innerHTML='';
      for(let i=0;i<count;i++){
        const col = el('div','col-12 col-sm-6 col-lg-4');
        col.innerHTML = `
          <div class="product-card p-2">
            <div class="thumb skeleton sk-thumb"></div>
            <div class="p-3">
              <div class="skeleton sk-line-lg"></div>
              <div class="skeleton sk-line" style="width:60%"></div>
              <div class="skeleton sk-line" style="width:40%"></div>
            </div>
          </div>`;
        grid.append(col);
      }
    }

    function chip(text){ const b=el('span','badge badge-soft me-1'); b.textContent=text; return b; }

    function buildCard(p){
      const col = el('div','col-12 col-sm-6 col-lg-4');
      const card = el('div','product-card card h-100');
      const thumb = el('div','thumb');
      const img = new Image();
      img.src = p.cover || 'https://placehold.co/800x500?text=No+Image';
      img.alt = p.name || '';
      thumb.append(img);

      // ป้ายลดราคา + สต็อก (ทับบนรูป - ไม่หาย)
      const z1 = el('span','sale-badge'); const pct = discountPercent(p);
      if(pct>0){ z1.textContent = `ลด ${pct}%`; thumb.append(z1); }
      const z2 = el('span','stock-badge'); z2.textContent = `สต็อก ${p.stock ?? '-'}`; thumb.append(z2);

      const body = el('div','card-body');
      const title = el('h5','card-title fw-semibold'); title.textContent = p.name||'-';

      const price = el('div','price mb-1');
      if(saleActive(p)){
        price.innerHTML = `${fmtBaht(p.salePrice)} <span class="old">${fmtBaht(p.price)}</span>`;
      }else{
        price.textContent = fmtBaht(p.price||0);
      }

      const tags = el('div','mb-2');
      (p.tags||[]).slice(0,4).forEach(t=> tags.append(chip('#'+t)));
      if(p.isBestSeller) tags.append(chip('ฮิต'));
      if(p.isNew)        tags.append(chip('ใหม่'));
      if(p.freeShip)     tags.append(chip('ส่งฟรี'));

      const desc = el('div','text-muted small'); desc.textContent = p.desc || '';

      const btn = el('button','btn btn-primary w-100 mt-2'); btn.textContent='ดูรายละเอียด';
      btn.onclick = ()=> openModal(p);

      card.append(thumb, body);
      body.append(title, price, tags, desc, btn);
      col.append(card);
      return col;
    }

    function applyFilter(){
      let list = [...RAW];

      // ค้นหา
      const q = ($('#q').value||'').trim().toLowerCase();
      if(q){
        list = list.filter(p=>{
          const inTags = (p.tags||[]).join(',').toLowerCase().includes(q);
          const inName = (p.name||'').toLowerCase().includes(q);
          return inTags || inName;
        });
      }
      // เฉพาะแนะนำ
      if($('#onlyFeatured').checked){
        list = list.filter(p=> !!p.featured);
      }
      // เรียง
      const s = $('#sort').value;
      if(s==='rank') list.sort((a,b)=>(a.rank??999)-(b.rank??999));
      if(s==='new')  list.sort((a,b)=> (toDate(b.createdAt)?.getTime()||0) - (toDate(a.createdAt)?.getTime()||0));
      if(s==='price-asc')  list.sort((a,b)=>(Number(a.salePrice||a.price||0))-(Number(b.salePrice||b.price||0)));
      if(s==='price-desc') list.sort((a,b)=>(Number(b.salePrice||b.price||0))-(Number(a.salePrice||a.price||0)));

      // page
      const total = Math.max(1, Math.ceil(list.length/PER));
      if(PAGE>total) PAGE = total;
      const start = (PAGE-1)*PER, end = start+PER;
      const pageList = list.slice(start,end);

      $('#resultCount').textContent = `พบทั้งหมด ${list.length} รายการ`;
      $('#pageInfo').textContent = `${PAGE} / ${total}`;
      $('#prev').disabled = PAGE<=1; $('#next').disabled = PAGE>=total;

      const grid = $('#grid'); grid.innerHTML='';
      if(pageList.length===0){
        grid.innerHTML = `<div class="col-12"><div class="bg-white border rounded-3 p-4 text-center text-muted">ไม่พบสินค้า</div></div>`;
        return;
      }
      pageList.forEach(p=> grid.append(buildCard(p)));
    }

    async function loadProducts(){
      renderSkeleton();
      const products = [];
      // อ่านสินค้าเปิดแสดงทั้งหมด (เรียง rank) – ต้องมี composite index แล้ว
      const q1 = query(collection(db,'products'), where('isActive','==',true), orderBy('rank'));
      const snap = await getDocs(q1);
      snap.forEach(d=>{
        const p = d.data(); p.id=d.id;
        // normalize
        p.tags = (p.tags||'').toString().split(',').map(s=>s.trim()).filter(Boolean);
        p.gallery = (p.gallery||'').toString().split(',').map(s=>s.trim()).filter(Boolean);
        products.push(p);
      });
      RAW = products;
      applyFilter();
    }

    function openModal(p){
      $('#pmTitle').textContent = p.name || '';
      // ราคา
      if(saleActive(p)){
        $('#pmPrice').innerHTML = `${fmtBaht(p.salePrice)} <span class="old">${fmtBaht(p.price)}</span>`;
      }else{
        $('#pmPrice').textContent = fmtBaht(p.price||0);
      }
      // แท็ก
      const tg = $('#pmTags'); tg.innerHTML='';
      (p.tags||[]).forEach(t=> tg.append(chip('#'+t)));
      if(p.isBestSeller) tg.append(chip('ฮิต'));
      if(p.isNew)        tg.append(chip('ใหม่'));
      if(p.freeShip)     tg.append(chip('ส่งฟรี'));

      // สต็อก + เวลาโปรฯ
      $('#pmStock').textContent = (p.stock??'-');
      const s = toDate(p.saleStart), e = toDate(p.saleEnd);
      $('#pmPromoTime').textContent = saleActive(p) || (s||e)
        ? `โปรฯ ${ s?('เริ่ม '+s.toLocaleString('th-TH')):'' } ${ e?('– จบ '+e.toLocaleString('th-TH')):'' }`
        : '';

      $('#pmDesc').textContent = p.desc || '';

      // แกลเลอรี
      const slides = $('#pmSlides'); slides.innerHTML='';
      const pics = [p.cover, ...(p.gallery||[])].filter(Boolean);
      if(pics.length===0) pics.push('https://placehold.co/1200x700?text=No+Image');
      pics.forEach((url,i)=>{
        const item = el('div','carousel-item'+(i===0?' active':'')); 
        item.innerHTML = `<img src="${url}" class="d-block w-100" alt="">`;
        slides.append(item);
      });

      // ปุ่มติดต่อ (อ่านจาก SETTINGS)
      const tel = (SETTINGS.phone||'').replace(/\s/g,'');
      $('#btnCall').href = tel ? `tel:${tel}` : '#';
      const lineId = (SETTINGS.line||'').replace('@','').trim();
      $('#btnLine').href = lineId ? `https://line.me/R/ti/p/${lineId}` : '#';
      $('#btnFb').href   = SETTINGS.facebook || '#';

      new bootstrap.Modal('#productModal').show();
    }

    // events
    $('#q').addEventListener('input', ()=>{ PAGE=1; applyFilter(); });
    $('#btnClear').onclick = ()=>{ $('#q').value=''; PAGE=1; applyFilter(); };
    $('#sort').onchange = ()=>{ PAGE=1; applyFilter(); };
    $('#onlyFeatured').onchange = ()=>{ PAGE=1; applyFilter(); };
    $('#prev').onclick = ()=>{ if(PAGE>1){ PAGE--; applyFilter(); } };
    $('#next').onclick = ()=>{ PAGE++; applyFilter(); };

    // go!
    await loadSettings();
    loadProducts();
  </script>
</body>
</html>
