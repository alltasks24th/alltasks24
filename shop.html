<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>ร้านค้า | Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b0f1a; color:#e6e9ef; }
    .navbar, .offcanvas, .card { background:#111729; color:#e6e9ef; }
    .form-control, .form-select { background:#0e1526; color:#e6e9ef; border-color:#28324a; }
    .form-control::placeholder { color:#98a6c7; }
    .btn-primary { background:#4f6ef7; border-color:#4f6ef7; }
    .btn-outline-secondary { border-color:#2b3550; color:#c9d3f5; }
    .btn-outline-secondary:hover { background:#2b3550; color:#fff; }

    .text-muted { color:#98a6c7 !important; }
    .card { border:1px solid #1a2340; }
    .card .badge { font-weight:600; }
    .ratio.bg-light { background:#0e1526 !important; border-color:#28324a !important; }

    /* ริบบิ้นโปรฯ ต้องอยู่บนสุดเสมอ */
    .promo-ribbon { position:absolute; top:.5rem; left:.5rem; z-index:3; }
    .product-media { position:relative; }

    /* หมุนโหลด */
    #loadingWrap { display:none; }
    #loadingWrap.show { display:flex; }

    /* ชิปฟิลเตอร์ที่เลือก */
    #activeTags .badge { background:#1a2340; border:1px solid #2b3550; }

    /* ปุ่มก่อนหน้า/ถัดไป */
    .pagination .page-link { background:#0e1526; color:#c9d3f5; border-color:#28324a; }
    .pagination .page-link:hover { background:#28324a; color:#fff; }
    .pagination .active .page-link { background:#4f6ef7; border-color:#4f6ef7; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg border-bottom border-dark-subtle">
  <div class="container">
    <a class="navbar-brand fw-bold text-white" href="./">MyShop</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <form class="ms-auto d-flex gap-2 my-2 my-lg-0" role="search" onsubmit="return false;">
        <input id="q" class="form-control" type="search" placeholder="ค้นหาสินค้า..." aria-label="Search">
        <div class="form-check d-flex align-items-center">
          <input class="form-check-input me-2" type="checkbox" id="onlyFeatured">
          <label class="form-check-label" for="onlyFeatured">เฉพาะแนะนำ</label>
        </div>
        <button id="btnSearch" class="btn btn-primary">ค้นหา</button>
      </form>
    </div>
  </div>
</nav>

<section class="py-4">
  <div class="container">
    <!-- ชิปบอกสิ่งที่ติ๊ก/เลือก -->
    <div id="activeTags" class="d-flex flex-wrap gap-2 mb-3"></div>

    <!-- สรุปจำนวน / การเรียง -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div class="small text-muted" id="sumTxt">กำลังโหลด...</div>
      <div class="d-flex align-items-center gap-2">
        <label class="small text-muted">เรียงโดย</label>
        <select id="sort" class="form-select form-select-sm" style="width:180px">
          <option value="new">ใหม่ล่าสุด</option>
          <option value="price-asc">ราคาต่ำไปสูง</option>
          <option value="price-desc">ราคาสูงไปต่ำ</option>
          <option value="name-asc">ชื่อ A→Z</option>
        </select>
      </div>
    </div>

    <!-- กริดสินค้า -->
    <div id="grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-3"></div>

    <!-- โหลด -->
    <div id="loadingWrap" class="py-5 justify-content-center align-items-center">
      <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 text-muted">กำลังโหลด...</div>
      </div>
    </div>

    <!-- หน้า -->
    <nav class="mt-4">
      <ul id="pager" class="pagination justify-content-center"></ul>
    </nav>
  </div>
</section>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase v10 (โมดูล) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /* ====== ตั้งค่า Firebase App ของคุณ ======
     ถ้าคุณมีไฟล์ firebase-init.js แล้ว ให้ลบบล็อก config นี้
     แล้วเปลี่ยนเป็น: import { app, db } from './firebase-init.js'
  */
  const firebaseConfig = window.firebaseConfig || {
    // <<< วาง config ของโปรเจกต์คุณตรงนี้ ถ้ามีไฟล์ firebase-init.js อยู่แล้วให้เอาบล็อกนี้ออก >>>
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* ====== Utils ====== */
  const $ = sel => document.querySelector(sel);
  const fmtMoney = n => (typeof n === 'number') ? n.toLocaleString('th-TH', {maximumFractionDigits:0}) : '-';
  const escapeHtml = s => String(s ?? '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
  const toMillis = v => (typeof v === 'number') ? v
                      : (v?.seconds ? v.seconds*1000 : (v? new Date(v).getTime() : null));
  const formatDateTime = ms => {
    try { return new Date(ms).toLocaleString('th-TH', {dateStyle:'medium', timeStyle:'short'}); }
    catch { return ''; }
  };

  function saleInfo(d){
    const now = Date.now();
    const p = d?.promo || {};
    const startAt = p.startAt ? toMillis(p.startAt) : null;
    const endAt   = p.endAt   ? toMillis(p.endAt)   : null;

    const active = p && p.enabled === true
      && (startAt ? now >= startAt : true)
      && (endAt   ? now <= endAt   : true)
      && (typeof p.percent === 'number' && p.percent > 0 && p.percent <= 100);

    const priceAfter = active && typeof d.price === 'number'
      ? Math.max(0, Math.round(d.price * (100 - p.percent) / 100))
      : d.price;

    return {
      active,
      percent: active ? p.percent : 0,
      priceAfter,
      startAtText: startAt ? formatDateTime(startAt) : ''
    };
  }

  /* ====== เรนเดอร์การ์ดสินค้า ====== */
  function cardHtml(d){
    const sInfo = saleInfo(d);
    const stockTxt = (typeof d.stock === 'number')
        ? `สต๊อก: ${d.stock.toLocaleString()} ชิ้น`
        : (d.stockText ? d.stockText : '');

    const ribbonHtml = sInfo.active
        ? `<div class="promo-ribbon"><span class="badge bg-danger">-${sInfo.percent}%</span></div>`
        : '';

    let mediaHtml = '';
    if (Array.isArray(d.images) && d.images.length){
      const id = 'c' + d.id;
      mediaHtml = `
      <div id="${id}" class="carousel slide product-media">
        ${ribbonHtml}
        <div class="carousel-inner">
          ${d.images.map((url, i) => `
            <div class="carousel-item ${i===0?'active':''}">
              <img src="${url}" class="d-block w-100" alt="${escapeHtml(d.name || '')}">
            </div>`).join('')}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#${id}" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">ก่อนหน้า</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#${id}" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">ถัดไป</span>
        </button>
      </div>`;
    } else {
      mediaHtml = `
      <div class="ratio ratio-4x3 bg-light border product-media">
        ${ribbonHtml}
        <div class="d-flex align-items-center justify-content-center text-muted">
          ไม่มีรูปภาพ
        </div>
      </div>`;
    }

    const priceHtml = sInfo.active
      ? `<div class="d-flex align-items-center gap-2">
           <span class="fw-bold text-danger h5 mb-0">${fmtMoney(sInfo.priceAfter)}฿</span>
           <small class="text-muted text-decoration-line-through">${fmtMoney(d.price)}฿</small>
         </div>
         <div class="small text-muted">เริ่มโปร: ${sInfo.startAtText || '-'}</div>`
      : `<div class="fw-bold h5 mb-0">${fmtMoney(d.price)}฿</div>`;

    const metaLines = [
      d.brand ? `แบรนด์: ${escapeHtml(d.brand)}` : '',
      stockTxt
    ].filter(Boolean).map(x=>`<div class="small text-muted">${x}</div>`).join('');

    const tagsHtml = Array.isArray(d.tags) && d.tags.length
      ? `<div class="mt-2 d-flex flex-wrap gap-1">
           ${d.tags.map(t=>`<span class="badge text-bg-secondary">${escapeHtml(t)}</span>`).join('')}
         </div>` : '';

    const tel = d.contactPhone || '';
    const lineUrl = d.lineUrl || 'https://line.me/R/ti/p/~';
    const fbUrl   = d.facebookUrl || 'https://facebook.com/';

    return `
    <div class="col">
      <div class="card h-100 shadow-sm">
        ${mediaHtml}
        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-2">${escapeHtml(d.name || 'สินค้า')}</h6>
          ${priceHtml}
          ${metaLines}
          ${tagsHtml}
          <div class="mt-auto d-grid gap-2">
            <a class="btn btn-primary" href="./product.html?id=${encodeURIComponent(d.id)}">ดูรายละเอียด</a>
            <div class="btn-group" role="group">
              <a class="btn btn-outline-secondary" target="_blank" href="tel:${tel}">โทร</a>
              <a class="btn btn-outline-secondary" target="_blank" href="${lineUrl}">Line</a>
              <a class="btn btn-outline-secondary" target="_blank" href="${fbUrl}">Facebook</a>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }

  /* ====== โหลด/ค้นหา/แบ่งหน้า ====== */
  const PAGE_SIZE = 12;
  let allItems = [];
  let page = 1;

  const grid  = document.getElementById('grid');
  const pager = document.getElementById('pager');
  const sumTxt= document.getElementById('sumTxt');

  function showLoader(show){
    document.getElementById('loadingWrap').classList.toggle('show', !!show);
  }

  function updateActiveChips(){
    const box = document.getElementById('activeTags');
    const chips = [];
    const q = document.getElementById('q').value.trim();
    if(q) chips.push(`<span class="badge rounded-pill">ค้นหา: ${escapeHtml(q)}</span>`);
    if(document.getElementById('onlyFeatured').checked)
      chips.push(`<span class="badge rounded-pill">เฉพาะแนะนำ</span>`);
    box.innerHTML = chips.join('\n');
  }

  function render(){
    // ค้นหาข้อความในชื่อ/คำอธิบาย
    const kw = document.getElementById('q').value.trim().toLowerCase();
    const featured = document.getElementById('onlyFeatured').checked;
    const sort = document.getElementById('sort').value;

    let items = allItems
      .filter(d => !featured || d.isFeatured === true)
      .filter(d => {
        if(!kw) return true;
        const t = `${d.name??''} ${d.desc??''}`.toLowerCase();
        return t.includes(kw);
      });

    // เรียง
    items.sort((a,b)=>{
      if(sort==='price-asc')  return (a.price??0) - (b.price??0);
      if(sort==='price-desc') return (b.price??0) - (a.price??0);
      if(sort==='name-asc')   return String(a.name??'').localeCompare(String(b.name??''), 'th');
      // new: ใช้ createdAt / updatedAt / id
      const am = toMillis(a.updatedAt || a.createdAt) || 0;
      const bm = toMillis(b.updatedAt || b.createdAt) || 0;
      return bm - am;
    });

    // แบ่งหน้า
    const total = items.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    page = Math.min(Math.max(1, page), totalPages);
    const start = (page-1)*PAGE_SIZE;
    const pageItems = items.slice(start, start+PAGE_SIZE);

    // เรนเดอร์กริด
    grid.innerHTML = pageItems.map(cardHtml).join('');

    // สรุป
    sumTxt.innerHTML = `พบ <span class="text-white fw-bold">${total.toLocaleString()}</span> รายการ • หน้า <span class="text-white fw-bold">${page}</span>/<span class="text-white fw-bold">${totalPages}</span>`;

    // เพจจิ้ง
    const li = [];
    li.push(`<li class="page-item ${page<=1?'disabled':''}">
              <button class="page-link" data-goto="${page-1}">ก่อนหน้า</button>
            </li>`);
    for(let i=1;i<=totalPages;i++){
      if(i===1 || i===totalPages || Math.abs(i-page)<=1){
        li.push(`<li class="page-item ${i===page?'active':''}">
                  <button class="page-link" data-goto="${i}">${i}</button>
                </li>`);
      }else if(Math.abs(i-page)===2){
        li.push(`<li class="page-item disabled"><span class="page-link">…</span></li>`);
      }
    }
    li.push(`<li class="page-item ${page>=totalPages?'disabled':''}">
              <button class="page-link" data-goto="${page+1}">ถัดไป</button>
            </li>`);
    pager.innerHTML = li.join('');
    pager.querySelectorAll('button[data-goto]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const to = parseInt(btn.dataset.goto,10);
        if(!Number.isNaN(to)){ page = to; render(); window.scrollTo({top:0, behavior:'smooth'}); }
      });
    });

    updateActiveChips();
  }

  // โหลดจาก Firestore (อ่านเฉพาะที่ isActive=true)
  async function loadProducts(){
    showLoader(true);
    try {
      const colRef = collection(db, 'products');
      // ดึงทั้งหมดที่ isActive=true (หน้า shop เลือกไปกรอง/ค้นหาภายหลัง)
      const qref = query(colRef, where('isActive','==', true), orderBy('updatedAt','desc'), limit(200)); // ปรับ limit ตามต้องการ
      const snap = await getDocs(qref);
      allItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      page = 1;
      render();
    } catch(err){
      console.error('loadProducts error:', err);
      document.getElementById('grid').innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            โหลดข้อมูลไม่สำเร็จ: ${escapeHtml(err?.message || String(err))}
          </div>
        </div>`;
    } finally {
      showLoader(false);
    }
  }

  // events
  document.getElementById('btnSearch').addEventListener('click', render);
  document.getElementById('q').addEventListener('keyup', e=>{
    if(e.key==='Enter') render();
  });
  document.getElementById('onlyFeatured').addEventListener('change', render);
  document.getElementById('sort').addEventListener('change', render);

  // เริ่ม!
  loadProducts();
</script>

</body>
</html>
