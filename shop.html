<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>สินค้าทั้งหมด — alltasks24</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap / Icons (ใช้เวอร์ชันเดียวกับหน้าเว็บหลักได้เลย) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --brand:#6f42c1;           /* ม่วงหลัก */
      --brand-10:#f3eaff;        /* พื้นหลังจาง */
      --chip:#f1f5ff;            /* พื้นชิป */
      --chip-text:#3b82f6;
    }
    body{ background:var(--brand-10); }
    .page-wrap{ max-width:1080px; margin:auto; padding:24px 12px 48px; }

    /* การ์ดสินค้า */
    .product-card{ border:0; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); overflow:hidden; background:#fff; }
    .thumb-wrap{ position:relative; background:#f5f5f5; }
    .thumb-wrap img{ width:100%; height:220px; object-fit:cover; display:block; }
    .sale-badge{
      position:absolute; left:12px; top:12px;
      background:#ef4444; color:#fff; font-weight:700; font-size:.75rem;
      padding:.25rem .5rem; border-radius:999px; z-index:3;
      box-shadow:0 4px 10px rgba(239,68,68,.25);
    }
    .badge-chip{ background:var(--chip); color:var(--chip-text); font-weight:600; }
    .price{ font-weight:700; }
    .price del{ color:#9ca3af; font-weight:500; margin-right:.25rem; }
    .price .text-danger{ font-weight:800; }

    /* สินค้าหมด */
    .oos{ position:absolute; right:12px; top:12px; z-index:3; }
    .thumb-wrap::after{
      content:""; position:absolute; inset:0; background:transparent; z-index:1;
    }

    /* skeleton */
    .skeleton{ border-radius:16px; overflow:hidden; background:#fff; box-shadow:0 8px 20px rgba(0,0,0,.06); }
    .sk-img{ height:220px; background:linear-gradient(90deg,#eee,#f5f5f5,#eee); animation:sh 1.2s linear infinite; }
    .sk-line{ height:12px; border-radius:6px; margin:10px 0; background:linear-gradient(90deg,#eee,#f5f5f5,#eee); animation:sh 1.2s linear infinite; }
    @keyframes sh{ 0%{background-position:-200px 0}100%{background-position:200px 0} }

    /* ปุ่มหลัก */
    .btn-brand{ background:var(--brand); color:#fff; border:none; }
    .btn-brand:hover{ filter:brightness(.95); color:#fff; }
    .btn-outline-brand{ border-color:var(--brand); color:var(--brand); }
    .btn-outline-brand:hover{ background:var(--brand); color:#fff; }

    .form-chip{ background:#fff; border:1px solid #e5e7eb; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .muted{ color:#64748b; font-size:.9rem; }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="topbar">
      <div>
        <div class="muted">รับจ้างสารพัด 24 ชั่วโมง</div>
        <h3 class="mb-0">สินค้าทั้งหมด</h3>
        <div class="muted" id="totalText">พบทั้งหมด 0 รายการ</div>
      </div>
      <a href="./index.html" class="btn btn-sm btn-outline-brand"><i class="bi bi-arrow-left"></i> กลับหน้าแรก</a>
    </div>

    <!-- แถบค้นหา/เรียง -->
    <div class="d-flex gap-2 flex-wrap mb-3">
      <div class="input-group" style="max-width:330px;">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input id="q" class="form-control form-chip" placeholder="ค้นหา (ชื่อ/แท็ก)">
        <button id="btnClear" class="btn btn-outline-secondary">ล้าง</button>
      </div>
      <select id="sort" class="form-select form-chip" style="max-width:220px">
        <option value="createdAt:desc">เรียงตามล่าสุด</option>
        <option value="price:asc">ราคา (ต่ำ→สูง)</option>
        <option value="price:desc">ราคา (สูง→ต่ำ)</option>
        <option value="rank:asc">ลำดับ (rank)</option>
      </select>
      <div class="form-check align-self-center ms-1">
        <input id="onlyFeatured" class="form-check-input" type="checkbox">
        <label class="form-check-label" for="onlyFeatured">แสดงเฉพาะแนะนำ</label>
      </div>
    </div>

    <!-- พื้นที่รายการ -->
    <div id="grid" class="row g-3"></div>

    <!-- หน้า -->
    <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
      <button id="prev" class="btn btn-sm btn-outline-secondary">&lt; ก่อนหน้า</button>
      <span id="pageInfo" class="small text-muted">1 / 1</span>
      <button id="next" class="btn btn-sm btn-outline-secondary">ถัดไป &gt;</button>
    </div>
  </div>

  <!-- Modal รายละเอียด -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="mTitle" class="modal-title">รายละเอียดสินค้า</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="thumb-wrap mb-3">
            <span id="mSale" class="sale-badge d-none"></span>
            <img id="mImg" src="" alt="">
          </div>

          <div class="d-flex flex-wrap gap-2 mb-2" id="mTags"></div>

          <div class="mb-2">
            <span id="mPrice" class="price h5"></span>
            <span id="mUnit" class="text-muted"></span>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">รายละเอียด</div>
              <div id="mDesc"></div>
            </div>
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  สต็อก
                  <span id="mStock" class="badge rounded-pill text-bg-secondary">-</span>
                </li>
                <li class="list-group-item">
                  <div class="small text-muted mb-1">ช่วงโปรโมชัน</div>
                  <div id="mSalePeriod">-</div>
                </li>
                <li class="list-group-item d-flex gap-2 flex-wrap">
                  <span id="mBadges" class="d-flex gap-2 flex-wrap"></span>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <div class="text-muted small" id="mMeta"></div>
          <div class="d-flex gap-2">
            <a id="btnTel" class="btn btn-outline-secondary"><i class="bi bi-telephone-fill"></i> โทร</a>
            <a id="btnLine" class="btn btn-success text-white"><i class="bi bi-chat-dots-fill"></i> LINE</a>
            <a id="btnFb" class="btn btn-primary"><i class="bi bi-facebook"></i> Facebook</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { app } from './firebase-init.js';
    import {
      getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const db = getFirestore(app);

    /* ==== ตั้งค่า ==== */
    const PAGE = 6; // จำนวนต่อหน้า
    const grid = document.getElementById('grid');
    const totalText = document.getElementById('totalText');
    const qInput = document.getElementById('q');
    const sortSel = document.getElementById('sort');
    const onlyFeatured = document.getElementById('onlyFeatured');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');

    let cursors = [];    // เก็บ startAfter ของแต่ละหน้า
    let page = 0;        // เริ่มที่หน้า 0

    // โหลด settings เพื่อใส่ปุ่มติดต่อใน modal
    let SETTINGS = {phone:'', line:'', facebook:''};
    (async () => {
      try{
        const sdoc = await getDoc(doc(db,'settings','general'));
        if(sdoc.exists()){
          const d = sdoc.data();
          SETTINGS.phone = d.phone||'';
          SETTINGS.line = d.line||'';
          SETTINGS.facebook = d.facebook||'';
        }
      }catch(e){}
    })();

    // helper
    const baht = n => new Intl.NumberFormat('th-TH').format(n||0);
    const fmt = t => t instanceof Timestamp ? t.toDate() : (t?.toDate?.() ?? (t? new Date(t): null));
    const fmtDT = t => t? t.toLocaleString('th-TH',{dateStyle:'medium', timeStyle:'short'}) : '-';

    function percentOff(price, sale){
      if(!price || !sale || sale>=price) return null;
      return Math.round((1 - (sale/price))*100);
    }

    function buildSkeleton(){
      grid.innerHTML = '';
      for(let i=0;i<PAGE;i++){
        grid.insertAdjacentHTML('beforeend', `
        <div class="col-md-6 col-lg-4">
          <div class="skeleton p-2">
            <div class="sk-img"></div>
            <div class="p-3">
              <div class="sk-line" style="width:60%"></div>
              <div class="sk-line" style="width:40%"></div>
              <div class="sk-line" style="width:85%"></div>
            </div>
          </div>
        </div>`);
      }
    }

    function chip(txt, variant='chip'){ 
      if(variant==='red') return `<span class="badge text-bg-danger">${txt}</span>`;
      if(variant==='green') return `<span class="badge text-bg-success">${txt}</span>`;
      return `<span class="badge badge-chip">${txt}</span>`;
    }

    function cardHTML(d, id){
      const p = d.price||0, s = d.salePrice||0;
      const poff = percentOff(p,s);
      const hasSale = s>0 && (!d.saleStart || new Date(d.saleStart)<=new Date()) &&
                                   (!d.saleEnd   || new Date(d.saleEnd)  >=new Date());
      const priceHTML = hasSale
        ? `<span class="price"><del>฿${baht(p)}</del> <span class="text-danger">฿${baht(s)}</span></span>`
        : `<span class="price">฿${baht(p)}</span>`;

      const tags = []
      if(d.isBestSeller) tags.push('ฮิต');
      if(d.isNew) tags.push('ใหม่');
      if(d.freeShip) tags.push('ส่งฟรี');
      (d.tags? (Array.isArray(d.tags)? d.tags: String(d.tags).split(','))
             : []).forEach(t=>{ const v=t.trim(); if(v) tags.push('#'+v) });

      const oos = (Number(d.stock||0) <= 0);
      const unit = d.unit? ` <span class="text-muted">/ ${d.unit}</span>` : '';

      return `
      <div class="col-md-6 col-lg-4">
        <div class="product-card">
          <div class="thumb-wrap">
            ${ hasSale && poff ? `<span class="sale-badge">ลด ${poff}%</span>`:''}
            ${ oos ? `<span class="oos badge text-bg-secondary">สินค้าหมด</span>`:''}
            <img src="${d.cover||'https://placehold.co/800x500?text=No+Image'}" alt="">
          </div>
          <div class="p-3">
            <div class="mb-1 d-flex flex-wrap gap-1">
              ${tags.map(t=> chip(t.startsWith('#')? t : t, t==='ส่งฟรี'?'green':'chip')).join('')}
            </div>
            <div class="fw-semibold mb-1">${d.name||'-'}</div>
            <div class="mb-2">${priceHTML}${unit}</div>
            <div class="small text-muted mb-2">
              ${d.desc ? String(d.desc).slice(0,80) : ''}${(d.desc&&d.desc.length>80)?'…':''}
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <span class="small ${oos?'text-danger':'text-muted'}">
                ${oos? 'คงเหลือ 0' : ('คงเหลือ ' + (d.stock??'-'))}
              </span>
              <button class="btn btn-brand btn-sm" data-id="${id}" data-name="${d.name||''}">ดูรายละเอียด</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    async function fetchPage(){
      buildSkeleton();
      const [field,dir] = sortSel.value.split(':');   // createdAt:desc / price:asc ...
      try{
        let base = collection(db,'products');
        let q = query(base, where('isActive','==',true));
        if(onlyFeatured.checked) q = query(q, where('featured','==',true));

        // orderBy
        q = query(q, orderBy(field, dir==='desc'?'desc':'asc'), limit(PAGE));
        if(page>0 && cursors[page-1]) q = query(q, startAfter(cursors[page-1]));

        const snap = await getDocs(q);

        // เก็บ cursor
        cursors[page] = snap.docs.at(-1) || null;

        // รวมทั้งหมดเพื่อแสดงจำนวน (ปลอดภัยถ้า collection ใหญ่ ให้ตัดออกได้)
        totalText.textContent = `พบทั้งหมด ${snap.size} รายการ`;

        // สร้างการ์ด
        let html = '';
        snap.forEach(d => html += cardHTML(d.data(), d.id));
        grid.innerHTML = html || `<div class="text-center text-muted p-5">ไม่พบสินค้า</div>`;

        pageInfo.textContent = `${page+1} / ${page+1}`; // simple pager (ปรับง่าย)

        // ผูกปุ่ม modal
        grid.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.addEventListener('click',()=> openModal(btn.dataset.id, btn.dataset.name));
        });
      }catch(err){
        console.error(err);
        let hint = '';
        if(String(err.code)==='failed-precondition' || /index/i.test(err.message)){
          hint = `<div class="alert alert-warning">
                    จำเป็นต้องสร้าง <b>Composite Index</b> สำหรับการค้นหาหน้านี้
                    (isActive + ${field}). เปิดคอนโซลเพื่อกดลิงก์สร้างอัตโนมัติได้เลย
                  </div>`;
        }
        grid.innerHTML = hint || `<div class="text-center text-danger p-5">โหลดข้อมูลไม่สำเร็จ</div>`;
      }
    }

    async function openModal(id, name){
      try{
        const d = (await getDoc(doc(db,'products',id))).data() || {};
        const poff = percentOff(d.price, d.salePrice);
        const hasSale = d.salePrice>0 && (!d.saleStart || new Date(d.saleStart)<=new Date()) &&
                                       (!d.saleEnd   || new Date(d.saleEnd)  >=new Date());

        // ภาพ
        document.getElementById('mImg').src = d.cover || 'https://placehold.co/1000x600?text=No+Image';
        const mSale = document.getElementById('mSale');
        if(hasSale && poff){ mSale.classList.remove('d-none'); mSale.textContent = `ลด ${poff}%`; }
        else mSale.classList.add('d-none');

        // หัวเรื่อง + ราคา
        document.getElementById('mTitle').textContent = d.name || name || 'รายละเอียดสินค้า';
        document.getElementById('mPrice').innerHTML = hasSale
          ? `<del>฿${baht(d.price)}</del> <span class="text-danger">฿${baht(d.salePrice)}</span>`
          : `฿${baht(d.price||0)}`;
        document.getElementById('mUnit').textContent = d.unit? ` / ${d.unit}` : '';

        // แท็ก
        const tgs = [];
        if(d.isBestSeller) tgs.push(chip('ฮิต'));
        if(d.isNew)        tgs.push(chip('ใหม่'));
        if(d.freeShip)     tgs.push(chip('ส่งฟรี','green'));
        (d.tags? (Array.isArray(d.tags)? d.tags: String(d.tags).split(',')) : [])
          .forEach(t=>{ const v=t.trim(); if(v) tgs.push(chip('#'+v)); });
        document.getElementById('mTags').innerHTML = tgs.join('') || '<span class="text-muted small">—</span>';

        // คำอธิบาย/สต็อก/ช่วงโปรฯ
        document.getElementById('mDesc').textContent = d.desc || '-';
        const stockEl = document.getElementById('mStock');
        const stock = Number(d.stock??0);
        stockEl.textContent = stock>0? stock : 'หมด';
        stockEl.className = 'badge rounded-pill ' + (stock>0? 'text-bg-secondary' : 'text-bg-danger');

        document.getElementById('mSalePeriod').textContent =
          (d.saleStart||d.saleEnd)
            ? `${d.saleStart? fmtDT(fmt(d.saleStart)):'-'}  ถึง  ${d.saleEnd? fmtDT(fmt(d.saleEnd)):'-'}`
            : '-';

        // แสดงแถบสถานะที่ติ๊ก
        const mb = [];
        if(d.featured)     mb.push(chip('แนะนำ'));
        if(d.isBestSeller) mb.push(chip('ฮิต'));
        if(d.isNew)        mb.push(chip('ใหม่'));
        if(d.freeShip)     mb.push(chip('ส่งฟรี','green'));
        document.getElementById('mBadges').innerHTML = mb.join('');

        // ปุ่มติดต่อ
        const tel = (SETTINGS.phone||'').replace(/\s/g,'');
        const lineId = (SETTINGS.line||'').replace(/@/g,'').trim();
        const fb = SETTINGS.facebook||'#';
        document.getElementById('btnTel').href = tel? `tel:${tel}` : '#';
        document.getElementById('btnLine').href = lineId? `https://line.me/R/ti/p/${lineId}` : '#';
        document.getElementById('btnFb').href = fb;

        document.getElementById('mMeta').textContent =
          `ลำดับ: ${d.rank??'-'} · อัปเดตล่าสุด: ${fmtDT(fmt(d.updatedAt)||fmt(d.createdAt))}`;

        bootstrap.Modal.getOrCreateInstance('#productModal').show();
      }catch(e){
        console.error(e);
      }
    }

    // events
    document.getElementById('btnClear').onclick = ()=>{ qInput.value=''; fetchPage(); }
    sortSel.onchange = ()=>{ page=0; cursors=[]; fetchPage(); }
    onlyFeatured.onchange = ()=>{ page=0; cursors=[]; fetchPage(); }
    prevBtn.onclick = ()=>{ if(page>0){ page--; fetchPage(); } }
    nextBtn.onclick = ()=>{ page++; fetchPage(); }   // (ตัวอย่างแบบง่าย)

    // เริ่ม
    fetchPage();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
