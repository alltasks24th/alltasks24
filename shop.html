<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>สินค้าทั้งหมด | รับจ้างสารพัด 24 ชั่วโมง</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --brand:#7C3AED;           /* ม่วงหลัก */
      --brand-600:#6D28D9;
      --brand-100:#F3E8FF;
      --ink:#0f172a;
      --muted:#6b7280;
      --chip-bg:#EFE7FF;
      --chip-bd:#E3D7FF;
      --bg:#F6F3FF;              /* พื้นหลังอ่อน เหมือนหน้าแรก */
      --card-radius:16px;
    }
    body{ background:var(--bg); color:var(--ink); }

    .btn-brand{
      --bs-btn-color:#fff;
      --bs-btn-bg:var(--brand);
      --bs-btn-border-color:var(--brand);
      --bs-btn-hover-bg:var(--brand-600);
      --bs-btn-hover-border-color:var(--brand-600);
      --bs-btn-focus-shadow-rgb:124,58,237;
    }
    .badge-chips .badge{
      background:var(--chip-bg);
      border:1px solid var(--chip-bd);
      color:var(--brand-600);
      font-weight:600;
    }
    .shadow-soft{ box-shadow:0 10px 30px rgba(15,23,42,.06); }

    /* การ์ดสินค้า */
    .product-card{ border:0; border-radius:var(--card-radius); overflow:hidden; }
    .product-card .card-body{ padding:14px 16px 16px; }
    .img-wrap{ position:relative; background:#fafafa; }
    .img-wrap>img{
      width:100%; height:220px; object-fit:cover;
      display:block;
    }
    .ribbon{
      position:absolute; top:12px; left:12px; z-index:3;
      background:#ef4444; color:#fff; font-weight:700; font-size:.8rem;
      padding:4px 8px; border-radius:999px; box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .price-row{ display:flex; align-items:baseline; gap:8px; }
    .price-now{ color:#dc2626; font-weight:700; }
    .price-old{ color:#9ca3af; text-decoration:line-through; font-size:.9rem; }

    .prod-meta{ font-size:.85rem; color:var(--muted); display:flex; gap:14px; flex-wrap:wrap; }
    .prod-meta i{ margin-right:6px; }

    /* คอนโทรลบนสุด */
    .topbar{ position:sticky; top:0; z-index:50; background:rgba(246,243,255,.7); backdrop-filter:saturate(180%) blur(8px); }
    .filter-wrap{ background:#fff; border:1px solid #eee; border-radius:12px; padding:8px; }

    /* Pagination */
    .pager .btn{ min-width:86px; }
  </style>
</head>
<body>
  <header class="pt-4 topbar">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted small">รับจ้างสารพัด 24 ชั่วโมง</div>
          <h4 class="mb-0 fw-bold">สินค้าทั้งหมด</h4>
          <div id="resultCount" class="text-muted small mt-1"></div>
        </div>
        <a href="./" class="btn btn-outline-secondary btn-sm rounded-pill"><i class="bi bi-arrow-left"></i> กลับหน้าแรก</a>
      </div>

      <div class="filter-wrap mt-3">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-md">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="q" type="search" class="form-control" placeholder="ค้นหา (ชื่อ/แท็ก)">
              <button id="btnClear" class="btn btn-outline-secondary">ล้าง</button>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <select id="sortBy" class="form-select">
              <option value="rank-asc">เรียงตามลำดับ (แนะนำก่อน)</option>
              <option value="price-asc">ราคาต่ำ→สูง</option>
              <option value="price-desc">ราคาสูง→ต่ำ</option>
              <option value="name-asc">ชื่อ A→Z</option>
              <option value="name-desc">ชื่อ Z→A</option>
              <option value="newest">ใหม่ล่าสุด</option>
            </select>
          </div>
          <div class="col-6 col-md-auto">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="onlyFeatured">
              <label class="form-check-label" for="onlyFeatured">เฉพาะแนะนำ</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <div id="grid" class="row g-3"></div>

      <div class="d-flex justify-content-center align-items-center gap-2 mt-4 pager">
        <button id="prev" class="btn btn-outline-secondary rounded-pill"><i class="bi bi-chevron-left"></i> ก่อนหน้า</button>
        <span id="pageInfo" class="small text-muted"></span>
        <button id="next" class="btn btn-outline-secondary rounded-pill">ถัดไป <i class="bi bi-chevron-right"></i></button>
      </div>
    </div>
  </main>

  <!-- Modal: รายละเอียดสินค้า -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="border:0; border-radius:20px;">
        <div class="modal-body p-0">
          <div class="img-wrap">
            <span class="ribbon d-none" id="mRibbon"></span>
            <img id="mImg" src="" alt="" style="width:100%; max-height:360px; object-fit:cover;">
          </div>

          <div class="p-3 p-md-4">
            <h5 id="mTitle" class="fw-bold mb-1"></h5>

            <div id="mPrice" class="mb-2"></div>
            <div id="mFlags" class="badge-chips mb-2"></div>

            <div id="mMeta" class="prod-meta mb-3"></div>
            <p id="mDesc" class="text-muted mb-3"></p>

            <!-- ปุ่มติดต่อ -->
            <div class="d-flex flex-wrap gap-2">
              <a id="btnCall" href="#" class="btn btn-outline-secondary"><i class="bi bi-telephone"></i> โทร</a>
              <a id="btnLine" href="#" class="btn btn-success"><i class="bi bi-line"></i> LINE</a>
              <a id="btnFb" href="#" class="btn btn-primary"><i class="bi bi-facebook"></i> Facebook</a>
              <button type="button" class="btn btn-outline-secondary ms-auto" data-bs-dismiss="modal">ปิด</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (auto init บน Firebase Hosting) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js"></script>

  <script>
    // ---------- utils ----------
    const $ = sel => document.querySelector(sel);
    const grid = $('#grid'), pageInfo = $('#pageInfo');
    const THB = n => (n||n===0) ? n.toLocaleString('th-TH',{style:'currency',currency:'THB',maximumFractionDigits:0}) : '';
    const toDate = v => (v && typeof v.toDate === 'function') ? v.toDate() : (v ? new Date(v) : null);
    const fmtDT = d => d ? d.toLocaleString('th-TH',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
    const inSale = (p, now=new Date())=>{
      const s=toDate(p.saleStart), e=toDate(p.saleEnd);
      if (p.salePrice==null) return false;
      if (s && now<s) return false;
      if (e && now>e) return false;
      return true;
    };

    // ---------- state ----------
    let ALL=[], VIEW=[], page=1, perPage=6, SETTINGS={};

    // ---------- settings (เบอร์/ไลน์/เฟซ) ----------
    async function loadSettings(){
      const tryIds = ['general','site','app'];
      for (const id of tryIds){
        try{
          const snap = await firebase.firestore().collection('settings').doc(id).get();
          if(snap.exists){ SETTINGS = snap.data(); break; }
        }catch(e){}
      }
    }
    function applyContacts(){
      const tel = (SETTINGS.phone||'').replace(/\s/g,'');
      const line = (SETTINGS.line||'').trim();
      const fb = (SETTINGS.facebook||'').trim();

      const aCall = $('#btnCall'); if(tel) aCall.href = `tel:${tel}`;
      const aLine = $('#btnLine'); if(line){
        // รับทั้งรูปแบบ line.me/R/ti/p/xxxx หรือ @xxxx
        const id = line.includes('line.me') ? line : `https://line.me/R/ti/p/${line.replace('@','')}`;
        aLine.href = id;
      }
      const aFb = $('#btnFb'); if(fb) aFb.href = fb;
    }

    // ---------- fetch products ----------
    async function fetchProducts(){
      const db = firebase.firestore();
      try{
        // ต้องใช้ index: isActive==true + orderBy('rank')
        const qs = await db.collection('products')
          .where('isActive','==',true)
          .orderBy('rank','asc')
          .get();
        return qs.docs.map(d=>({id:d.id,...d.data()}));
      }catch(err){
        console.warn('Index ยังไม่พร้อม / fallback', err?.message);
        // fallback: ดึงทั้งหมดแล้วคัดกรอง/เรียงฝั่ง client
        const qs = await db.collection('products').get();
        return qs.docs.map(d=>({id:d.id,...d.data()}))
          .filter(x=>x.isActive!==false)
          .sort((a,b)=> (a.rank??999) - (b.rank??999));
      }
    }

    // ---------- render ----------
    function render(){
      // filter & sort
      const q = ($('#q').value||'').toLowerCase();
      const onlyFeat = $('#onlyFeatured').checked;
      const sort = $('#sortBy').value;

      VIEW = ALL.filter(p=>{
        const okFeat = onlyFeat ? !!p.featured : true;
        const txt = (p.name||'')+' '+(p.tags||'');
        const okQ = !q || txt.toLowerCase().includes(q);
        return okFeat && okQ;
      });

      switch(sort){
        case 'price-asc':  VIEW.sort((a,b)=>(a.price??0)-(b.price??0)); break;
        case 'price-desc': VIEW.sort((a,b)=>(b.price??0)-(a.price??0)); break;
        case 'name-asc':   VIEW.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''),'th')); break;
        case 'name-desc':  VIEW.sort((a,b)=> String(b.name||'').localeCompare(String(a.name||''),'th')); break;
        case 'newest':     VIEW.sort((a,b)=> (b.createdAt?.seconds??0)-(a.createdAt?.seconds??0)); break;
        default:           VIEW.sort((a,b)=> (a.rank??999)-(b.rank??999));
      }

      // pagination
      const total = VIEW.length;
      const pages = Math.max(1, Math.ceil(total/perPage));
      page = Math.min(page, pages);
      const start = (page-1)*perPage, end = start+perPage;
      const items = VIEW.slice(start,end);

      $('#resultCount').textContent = `พบทั้งหมด ${total} รายการ`;
      pageInfo.textContent = `${page} / ${pages}`;
      $('#prev').disabled = page<=1;
      $('#next').disabled = page>=pages;

      // draw cards
      grid.innerHTML = items.map(cardHTML).join('');
    }

    function cardHTML(p){
      const price = Number(p.price||0);
      const saleOn = inSale(p);
      const sale = saleOn ? Number(p.salePrice) : null;
      const pct = (saleOn && price>0) ? Math.max(0, Math.round((1-(sale/price))*100)) : 0;

      const flags = [
        p.featured ? 'แนะนำ':null,
        p.isBestSeller ? 'ฮิต':null,
        p.isNew ? 'ใหม่':null,
        p.freeShip ? 'ส่งฟรี':null
      ].filter(Boolean);

      const promo = (p.promoText||'').trim();
      const stockStr = (typeof p.stock==='number') ? `สต็อก ${p.stock}` : null;
      const startStr = p.saleStart ? `เริ่มโปรฯ ${fmtDT(toDate(p.saleStart))}` : null;

      return `
      <div class="col-12 col-md-6 col-lg-6">
        <div class="card product-card shadow-soft h-100">
          <div class="img-wrap">
            ${pct ? `<span class="ribbon">ลด ${pct}%</span>`:''}
            <img src="${p.cover||'https://via.placeholder.com/800x450?text=No+Image'}" alt="${p.name||''}">
          </div>
          <div class="card-body">
            <h6 class="fw-semibold mb-1 text-truncate" title="${p.name||''}">${p.name||''}</h6>

            <div class="mb-1">
              ${saleOn && price ? `
                <div class="price-row">
                  <span class="price-now">${THB(sale)}</span>
                  <span class="price-old">${THB(price)}</span>
                </div>` : `<div class="fw-semibold">${THB(price)}</div>`}
            </div>

            ${flags.length || promo ? `
              <div class="badge-chips mb-2">
                ${flags.map(t=>`<span class="badge rounded-pill">${t}</span>`).join('')}
                ${promo ? `<span class="badge rounded-pill">${promo}</span>`:''}
              </div>`:''}

            <div class="prod-meta mb-2">
              ${stockStr ? `<span><i class="bi bi-box-seam"></i>${stockStr}</span>`:''}
              ${startStr ? `<span><i class="bi bi-clock"></i>${startStr}</span>`:''}
            </div>

            <button class="btn btn-brand w-100" onclick="openProductModal('${p.id}')">ดูรายละเอียด</button>
          </div>
        </div>
      </div>`;
    }

    // ---------- modal ----------
    async function openProductModal(id){
      const snap = await firebase.firestore().collection('products').doc(id).get();
      if(!snap.exists) return;
      const p = {id:snap.id, ...snap.data()};

      const price = Number(p.price||0);
      const saleOn = inSale(p);
      const sale = saleOn ? Number(p.salePrice) : null;
      const pct = (saleOn && price>0) ? Math.max(0, Math.round((1-(sale/price))*100)) : 0;

      const flags = [
        p.featured ? 'แนะนำ':null,
        p.isBestSeller ? 'ฮิต':null,
        p.isNew ? 'ใหม่':null,
        p.freeShip ? 'ส่งฟรี':null
      ].filter(Boolean);

      // ribbon + รูป
      $('#mRibbon').classList.toggle('d-none', !pct);
      $('#mRibbon').textContent = pct ? `ลด ${pct}%` : '';
      $('#mImg').src = p.cover || 'https://via.placeholder.com/1200x675?text=No+Image';
      $('#mTitle').textContent = p.name||'';

      // ราคา
      $('#mPrice').innerHTML = saleOn && price
        ? `<div class="price-row"><span class="price-now">${THB(sale)}</span><span class="price-old">${THB(price)}</span></div>`
        : `<div class="fw-semibold">${THB(price)}</div>`;

      // badges
      $('#mFlags').innerHTML = `
        ${flags.map(t=>`<span class="badge rounded-pill">${t}</span>`).join('')}
        ${p.promoText ? `<span class="badge rounded-pill">${p.promoText}</span>`:''}
      `;

      // meta
      const metaBits = [];
      if (typeof p.stock==='number') metaBits.push(`<span><i class="bi bi-box-seam"></i>สต็อก ${p.stock}</span>`);
      if (p.saleStart) metaBits.push(`<span><i class="bi bi-clock"></i>เริ่มโปรฯ ${fmtDT(toDate(p.saleStart))}</span>`);
      if (p.saleEnd)   metaBits.push(`<span><i class="bi bi-hourglass-split"></i>สิ้นสุด ${fmtDT(toDate(p.saleEnd))}</span>`);
      $('#mMeta').innerHTML = metaBits.join('');

      $('#mDesc').textContent = p.desc || '';

      // ปุ่มติดต่อ
      applyContacts();

      new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    // ---------- events ----------
    $('#q').addEventListener('input', ()=>{ page=1; render(); });
    $('#btnClear').addEventListener('click', ()=>{ $('#q').value=''; page=1; render(); });
    $('#sortBy').addEventListener('change', ()=>{ page=1; render(); });
    $('#onlyFeatured').addEventListener('change', ()=>{ page=1; render(); });
    $('#prev').addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
    $('#next').addEventListener('click', ()=>{ const pages=Math.ceil(VIEW.length/perPage); if(page<pages){ page++; render(); }});

    // ---------- boot ----------
    (async function init(){
      await loadSettings();
      ALL = await fetchProducts();
      render();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
