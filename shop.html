<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>สินค้าทั้งหมด | รับจ้างสารพัด 24 ชั่วโมง</title>

  <!-- Bootstrap (ใช้ bundle เพราะมี modal, dropdown) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f5f0ff;           /* พื้นหลังอ่อน แบบหน้าแรก */
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#6f42c1;      /* ปุ่ม/ลิงก์หลัก */
      --primary-600:#5b35a8;
      --pill:#f1e7ff;
      --danger:#e11d48;
      --success:#059669;
      --chip:#f3f4f6;
      --shadow:0 8px 24px rgba(17,24,39,.06);
    }
    body{ background:var(--bg) }
    .page-wrap{ max-width: 1080px; margin: 32px auto 80px; padding:0 16px }
    .title{ font-weight:800; font-size:22px }
    .toolbar .btn, .toolbar .form-select, .toolbar .form-control{
      border-radius: 999px;
    }
    .card-prod{
      border:0; border-radius:16px; overflow:hidden; background:var(--card); box-shadow:var(--shadow);
    }
    .card-prod .cover{
      aspect-ratio: 16/9; width:100%; object-fit:cover; background:#eee;
    }
    .badge-sale{
      position:absolute; top:10px; left:10px;
      background:var(--danger); color:#fff; font-weight:700; border-radius:999px; padding:6px 10px; font-size:12px;
      box-shadow:0 6px 16px rgba(225,29,72,.35);
    }
    .pill{ background:var(--pill); color:#5b35a8; font-size:12px; border-radius:999px; padding:3px 8px; }
    .chip{ background:var(--chip); font-size:12px; border-radius:999px; padding:3px 8px; color:#374151 }
    .btn-primary{
      background:var(--primary); border-color:var(--primary);
    }
    .btn-primary:hover{ background:var(--primary-600); border-color:var(--primary-600) }
    .price{ font-weight:800 }
    .price .old{ color:#9ca3af; text-decoration:line-through; font-weight:600; margin-right:6px }
    .skeleton{
      animation: pulse 1.2s ease-in-out infinite; background:linear-gradient(90deg,#eee 25%,#f6f6f6 37%,#eee 63%); background-size:400% 100%;
      border-radius: 14px; min-height: 280px;
    }
    @keyframes pulse{ 0%{background-position:100% 50%} 100%{background-position:0 50%} }
    .pager .btn{ border-radius:999px }
    .err{ color:var(--danger) }
  </style>
</head>

<body>
  <div class="page-wrap">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <div class="text-muted small">รับจ้างสารพัด 24 ชั่วโมง</div>
        <div class="title">สินค้าทั้งหมด</div>
        <div class="text-muted small" id="resultCount">พบทั้งหมด … รายการ</div>
      </div>
      <a href="index.html" class="btn btn-outline-secondary btn-sm">กลับหน้าแรก</a>
    </div>

    <!-- Toolbar -->
    <div class="toolbar d-flex flex-wrap align-items-center gap-2 mb-4">
      <div class="flex-grow-1" style="min-width:220px;">
        <div class="input-group">
          <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
          <input id="q" class="form-control" placeholder="ค้นหา (ชื่อ/แท็ก)">
          <button id="btnClear" class="btn btn-outline-secondary">ล้าง</button>
        </div>
      </div>

      <select id="sort" class="form-select" style="width:180px">
        <option value="rank">เรียงตามลำดับ (แนะนํา)</option>
        <option value="latest">ใหม่ล่าสุด</option>
        <option value="priceAsc">ราคาต่ำ → สูง</option>
        <option value="priceDesc">ราคาสูง → ต่ำ</option>
      </select>

      <div class="form-check ms-1">
        <input class="form-check-input" type="checkbox" id="onlyFeatured">
        <label class="form-check-label" for="onlyFeatured">แสดงเฉพาะแนะนำ</label>
      </div>
    </div>

    <!-- GRID -->
    <div id="grid" class="row g-3"></div>
    <div id="err" class="err mt-3 d-none">โหลดข้อมูลไม่สำเร็จ</div>

    <!-- Pager -->
    <div class="pager d-flex justify-content-center align-items-center gap-2 mt-4">
      <button id="prev" class="btn btn-outline-secondary btn-sm" disabled>‹ ก่อนหน้า</button>
      <span class="small" id="pageInfo">1 / 1</span>
      <button id="next" class="btn btn-outline-secondary btn-sm" disabled>ถัดไป ›</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="prodModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="border-radius:18px">
        <div class="modal-header">
          <h5 class="modal-title" id="mTitle">รายละเอียดสินค้า</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="position-relative mb-3">
            <img id="mCover" class="w-100 rounded" style="aspect-ratio:16/9;object-fit:cover;background:#eee">
            <span id="mSaleBadge" class="badge-sale d-none"></span>
          </div>
          <div class="d-flex flex-wrap gap-2 mb-2" id="mChips"></div>
          <div class="mb-2"><span class="price" id="mPrice"></span> <span class="text-muted" id="mUnit"></span></div>
          <div class="text-muted small mb-2" id="mStock"></div>
          <div class="text-muted small mb-3" id="mPromo"></div>
          <div id="mDesc" class="mb-3"></div>

          <!-- ปุ่มติดต่อ -->
          <div class="d-flex gap-2">
            <a id="btnCall" class="btn btn-outline-secondary"><i class="bi bi-telephone"></i> โทร</a>
            <a id="btnLine" class="btn btn-success"><i class="bi bi-chat-dots"></i> LINE</a>
            <a id="btnFb" class="btn btn-primary"><i class="bi bi-facebook"></i> Facebook</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase init ของโปรเจกต์ (มีอยู่แล้วในโปรเจกต์) -->
  <script type="module" src="firebase-init.js"></script>

  <!-- ไอคอน Bootstrap (ใช้กับปุ่ม/ไอคอนเล็กน้อย) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <!-- หน้านี้ -->
  <script type="module">
    import { db } from './firebase-init.js';
    import {
      collection, doc, getDoc, getDocs, query, where, orderBy, limit, startAfter
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ---------------- helpers ----------------
    const $ = (s, el=document) => el.querySelector(s);
    const grid = $('#grid'), errBox = $('#err');
    const pageInfo = $('#pageInfo'), btnPrev = $('#prev'), btnNext = $('#next');
    const qInput = $('#q'), sortSel = $('#sort'), onlyFeatured = $('#onlyFeatured'), btnClear=$('#btnClear');

    const pager = { size: 8, cursor: null, page:1, totalPages:1 };

    const settings = { phone:'', line:'', facebook:'' };

    async function loadSettings(){
      try{
        const snap = await getDoc(doc(db,'settings','general'));
        if(snap.exists()){
          const d = snap.data();
          settings.phone = d.phone||d.tel||'';
          settings.line = (d.line||'').replace('@','');
          settings.facebook = d.facebook||'';
        }
      }catch(e){ /* เงียบได้ */ }
    }

    function saleInfo(p){
      const now = Date.now();
      if(!p.salePrice) return { on:false };
      const start = p.saleStart ? new Date(p.saleStart).getTime() : null;
      const end   = p.saleEnd   ? new Date(p.saleEnd).getTime()   : null;
      const inRange =
        (start ? now>=start : true) &&
        (end ? now<=end : true);
      if(!inRange) return { on:false };
      const pct = Math.max(0, Math.round((1 - (p.salePrice/(p.price||1))) * 100));
      return { on:true, pct, start, end };
    }

    function priceHTML(p){
      const s = saleInfo(p);
      if(s.on){
        return \`<span class="old">฿\${(p.price||0).toLocaleString()}</span>
                <span class="text-danger">฿\${(p.salePrice||0).toLocaleString()}</span>\`;
      }
      return \`<span>฿\${(p.price||0).toLocaleString()}</span>\`;
    }

    function chipsHTML(p){
      const chips=[];
      if(p.featured) chips.push('<span class="pill">แนะนำ</span>');
      if(p.isBestSeller) chips.push('<span class="chip">ฮิต</span>');
      if(p.isNew) chips.push('<span class="chip">ใหม่</span>');
      if(p.freeShip) chips.push('<span class="chip">ส่งฟรี</span>');
      if(Array.isArray(p.tags)) p.tags.slice(0,3).forEach(t=>chips.push(\`<span class="chip">#\${t}</span>\`));
      return chips.join(' ');
    }

    function saleBadgeHTML(p){
      const s = saleInfo(p);
      if(!s.on) return '';
      return \`<span class="badge-sale">ลด \${s.pct}%</span>\`;
    }

    function stockLine(p){
      if(p.stock===0) return '<span class="text-danger">สต็อก: หมด</span>';
      if(p.stock>0) return \`สต็อก: \${p.stock.toLocaleString()} ชิ้น\`;
      return '';
    }

    function promoLine(p){
      const s = saleInfo(p);
      if(!s.on) return '';
      const f = (ts)=> new Date(ts).toLocaleString('th-TH',{dateStyle:'medium', timeStyle:'short'});
      if(s.start && s.end) return \`โปรฯ \${f(s.start)} - \${f(s.end)}\`;
      if(s.end) return \`โปรฯ ถึง \${f(s.end)}\`;
      if(s.start) return \`โปรฯ เริ่ม \${f(s.start)}\`;
      return 'โปรฯ กำลังจัดอยู่';
    }

    function skeleton(n=6){
      grid.innerHTML = Array.from({length:n}).map(()=>`
        <div class="col-12 col-sm-6">
          <div class="skeleton w-100"></div>
        </div>`).join('');
    }

    function cardHTML(id,p){
      return `
      <div class="col-12 col-sm-6">
        <div class="card card-prod h-100">
          <div class="position-relative">
            <img class="cover" loading="lazy" src="${p.cover||''}" onerror="this.src='https://placehold.co/800x450?text=No+Image'">
            ${saleBadgeHTML(p)}
          </div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-1 mb-2">${chipsHTML(p)}</div>
            <h6 class="mb-1">${p.name||'-'}</h6>
            <div class="price mb-1">${priceHTML(p)} <span class="text-muted">${p.unit||''}</span></div>
            ${p.stock!=null ? `<div class="text-muted small mb-1">${stockLine(p)}</div>`:''}
            ${p.salePrice ? `<div class="text-muted small mb-2">${promoLine(p)}</div>`:''}
            <button class="btn btn-primary w-100" data-id="${id}" data-action="detail">ดูรายละเอียด</button>
          </div>
        </div>
      </div>`;
    }

    // ---------------- data load ----------------
    async function run(page=1){
      errBox.classList.add('d-none');
      skeleton();

      try{
        const base = collection(db,'products');
        const filters = [ where('isActive','==',true) ];
        if(onlyFeatured.checked) filters.push( where('featured','==',true) );

        let order = orderBy('rank','asc');
        if(sortSel.value==='latest') order = orderBy('__name__','desc');       // เรียง id เป็นตัวแทน created ล่าสุด
        if(sortSel.value==='priceAsc')  order = orderBy('price','asc');
        if(sortSel.value==='priceDesc') order = orderBy('price','desc');

        const q = query(base, ...filters, order, limit(pager.size));
        const snap = await getDocs(q);
        const docs = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // ค้นหาแบบง่ายฝั่ง client (ชื่อ/แท็ก)
        const kw = (qInput.value||'').trim().toLowerCase();
        let items = !kw ? docs : docs.filter(p=>{
          const t = (p.tags||[]).join(' ').toLowerCase();
          return (p.name||'').toLowerCase().includes(kw) || t.includes(kw);
        });

        // อัปเดตหน้าจอ
        if(items.length===0){
          grid.innerHTML = `<div class="text-center text-muted py-5">ไม่พบข้อมูล</div>`;
        }else{
          grid.innerHTML = items.map(p=>cardHTML(p.id,p)).join('');
        }
        $('#resultCount').textContent = `พบทั้งหมด ${items.length} รายการ`;
        pageInfo.textContent = '1 / 1'; btnPrev.disabled=true; btnNext.disabled=true;

      }catch(e){
        console.error(e);
        errBox.classList.remove('d-none');
        grid.innerHTML = '';
      }
    }

    // ---------------- modal ----------------
    const m = new bootstrap.Modal('#prodModal');
    grid.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button[data-action="detail"]');
      if(!btn) return;
      const id = btn.dataset.id;

      try{
        const ref = doc(db,'products',id);
        const s = await getDoc(ref);
        if(!s.exists()) return;
        const p = s.data();

        $('#mTitle').textContent = p.name||'-';
        $('#mCover').src = p.cover||'https://placehold.co/800x450?text=No+Image';
        const sInfo = saleInfo(p);
        const badge = $('#mSaleBadge');
        if(sInfo.on){ badge.classList.remove('d-none'); badge.textContent = `ลด ${sInfo.pct}%`; }
        else{ badge.classList.add('d-none'); }

        $('#mChips').innerHTML = chipsHTML(p);
        $('#mPrice').innerHTML = priceHTML(p);
        $('#mUnit').textContent = p.unit||'';
        $('#mStock').innerHTML = stockLine(p);
        $('#mPromo').textContent = promoLine(p);
        $('#mDesc').textContent = p.desc||'';

        // ปุ่มติดต่อจาก settings
        const phone = settings.phone||'';
        const line  = settings.line||'';
        const fb    = settings.facebook||'';

        const aCall = $('#btnCall'), aLine=$('#btnLine'), aFb=$('#btnFb');
        if(phone){ aCall.href = `tel:${phone}`; aCall.classList.remove('disabled'); } else aCall.classList.add('disabled');
        if(line){  aLine.href = `https://line.me/R/ti/p/${line}`; aLine.classList.remove('disabled'); } else aLine.classList.add('disabled');
        if(fb){    aFb.href   = fb; aFb.target='_blank'; aFb.rel='noopener'; aFb.classList.remove('disabled'); } else aFb.classList.add('disabled');

        m.show();
      }catch(e){ console.error(e); }
    });

    // ---------------- events ----------------
    btnClear.addEventListener('click', ()=>{ qInput.value=''; run(); });
    qInput.addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });
    sortSel.addEventListener('change', ()=> run());
    onlyFeatured.addEventListener('change', ()=> run());

    // init
    await loadSettings();
    run();
  </script>
</body>
</html>
