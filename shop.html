<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>สินค้าทั้งหมด • รับจ้างสารพัด 24 ชั่วโมง</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body{ background:#f8f9fb; }
    .object-fit-cover{ object-fit:cover; }
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .price{ font-weight:700; }
    .price del{ color:#6c757d; margin-right:.35rem; }
    .badge-sale{ background: linear-gradient(45deg,#ff7aa2,#d63384); }
    .oos-img{ filter: grayscale(1) brightness(.85); }
    .ribbon{ position:absolute; top:.5rem; left:.5rem; z-index:5; }
    .ribbon-right{ left:auto; right:.5rem; }
    .card:hover{ box-shadow:0 0.5rem 1.25rem rgba(0,0,0,.08); transition:.2s; }
    .page-loader{ position:fixed; inset:0; background:#fff; display:flex; align-items:center; justify-content:center; z-index:2000; }
    .page-loader.hidden{ opacity:0; pointer-events:none; transition: opacity .25s ease; }
  </style>
</head>
<body>

<div id="pageLoader" class="page-loader">
  <div class="text-center">
    <div class="spinner-border" role="status"></div>
    <div class="mt-3 fw-semibold">กำลังโหลด...</div>
  </div>
</div>

<header class="py-4 bg-white border-bottom">
  <div class="container">
    <div class="d-flex justify-content-between align-items-end gap-3">
      <div>
        <h1 class="h3 fw-bold mb-1">สินค้าทั้งหมด</h1>
        <div class="text-muted small">เลือกดู ค้นหา และจัดเรียงได้</div>
      </div>
      <a href="index.html" class="btn btn-outline-secondary d-none d-md-inline-flex"><i class="bi bi-arrow-left"></i>&nbsp;กลับหน้าแรก</a>
    </div>
  </div>
</header>

<main class="py-4">
  <div class="container">
    <!-- Controls -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-md-4">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="q" class="form-control" placeholder="ค้นหาชื่อ/คำอธิบาย/แท็ก">
            </div>
          </div>
          <div class="col-6 col-md-3">
            <select id="sort" class="form-select">
              <option value="rank-asc">จัดลำดับ (rank) ก่อน</option>
              <option value="createdAt-desc">ล่าสุดก่อน</option>
              <option value="price-asc">ราคาต่ำ→สูง</option>
              <option value="price-desc">ราคาสูง→ต่ำ</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="onlyFeatured">
              <label class="form-check-label" for="onlyFeatured">แสดงเฉพาะรายการแนะนำ</label>
            </div>
          </div>
          <div class="col-12 col-md-2 text-md-end">
            <button id="btnClear" class="btn btn-outline-secondary w-100">ล้างตัวกรอง</button>
          </div>
        </div>
        <div id="activeTags" class="mt-2"></div>
      </div>
    </div>

    <!-- Grid + Info -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="small text-muted" id="resultInfo">—</div>
      <div class="btn-group" role="group" aria-label="paging">
        <button id="prevPage" class="btn btn-outline-secondary btn-sm" disabled>ก่อนหน้า</button>
        <button id="nextPage" class="btn btn-outline-secondary btn-sm" disabled>ถัดไป</button>
      </div>
    </div>

    <div id="grid" class="row g-3"></div>
    <div id="modals"></div>
  </div>
</main>

<script type="module">
  import {
    getFirestore, collection, query, where, orderBy, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ใช้ db จาก firebase-init.js ถ้ามี export; ถ้าไม่ก็ใช้ getFirestore()
  let db;
  try {
    const FI = await import('./firebase-init.js');
    db = FI.db || getFirestore();
  } catch(e){ db = getFirestore(); }

  const PAGE_SIZE = 12;
  const state = { all: [], filtered: [], page: 0 };
  const $ = (s,r=document)=>r.querySelector(s);
  const showLoader = (b)=> $('#pageLoader')?.classList.toggle('hidden', !b);

  const params = new URLSearchParams(location.search);
  const initQ = params.get('q') || '';
  const initTags = (params.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean);
  const initSort = params.get('sort') || 'rank-asc';
  const initOnlyFeatured = params.get('featured') === 'true';

  $('#q').value = initQ; $('#sort').value = initSort; $('#onlyFeatured').checked = initOnlyFeatured;

  function renderActiveTags(tags){
    const wrap = $('#activeTags'); if(!wrap) return;
    wrap.innerHTML = tags.length ? tags.map(t=>`
      <span class="badge text-bg-light border me-1 mb-1">
        #${t} <button class="btn btn-sm btn-link p-0 ms-1" data-remove-tag="${t}" title="เอาแท็กนี้ออก"><i class="bi bi-x-lg"></i></button>
      </span>`).join('') : '';
    wrap.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-remove-tag]'); if(!b) return;
      const t = b.getAttribute('data-remove-tag');
      const arr = getTags().filter(x=>x!==t); setTags(arr); apply();
    }, { once:true });
  }
  function getTags(){ const t = params.get('tags'); return t ? t.split(',').map(s=>s.trim()).filter(Boolean) : []; }
  function setTags(arr){ if (arr.length) params.set('tags', arr.join(',')); else params.delete('tags'); history.replaceState(null,'',`${location.pathname}?${params.toString()}`); renderActiveTags(arr); }
  function readControls(){ return { q:$('#q').value.trim(), sort:$('#sort').value, onlyFeatured:$('#onlyFeatured').checked, tags:getTags() }; }

  function productMatches(p, {q,tags,onlyFeatured}){
    if (onlyFeatured && !p.featured) return false;
    if (tags?.length){
      const ptags = (p.tags||[]).map(s=>String(s).trim());
      if (!tags.every(t=> ptags.includes(t))) return false;
    }
    if (q){
      const hay = `${p.name||''} ${p.desc||''} ${(p.tags||[]).join(' ')}`.toLowerCase();
      if (!hay.includes(q.toLowerCase())) return false;
    }
    return true;
  }
  function sortProducts(arr, key){
    const a=[...arr];
    switch(key){
      case 'createdAt-desc': return a.sort((x,y)=>(y.createdAt?.seconds||0)-(x.createdAt?.seconds||0)||(x.rank||999)-(y.rank||999));
      case 'price-asc':     return a.sort((x,y)=>(x.salePrice??x.price??0)-(y.salePrice??y.price??0));
      case 'price-desc':    return a.sort((x,y)=>(y.salePrice??y.price??0)-(x.salePrice??x.price??0));
      case 'rank-asc':
      default:              return a.sort((x,y)=>(x.rank||999)-(y.rank||999)||(y.createdAt?.seconds||0)-(x.createdAt?.seconds||0));
    }
  }
  function pctOff(p){ return (!p.price||!p.salePrice)?0:Math.round((1-(p.salePrice/p.price))*100); }
  function isSaleActive(p){
    if (typeof p.salePrice !== 'number') return false;
    const now=new Date();
    const s=p.saleStart?.toDate? p.saleStart.toDate() : (p.saleStart? new Date(p.saleStart):null);
    const e=p.saleEnd?.toDate?   p.saleEnd.toDate()   : (p.saleEnd?   new Date(p.saleEnd):null);
    const startOk=!s||s<=now, endOk=!e||now<=e;
    return startOk && endOk && p.salePrice < p.price;
  }

  function renderGrid(){
    const grid=$('#grid'), mods=$('#modals'); if(!grid||!mods) return;
    grid.innerHTML=''; mods.innerHTML='';
    const PAGE=12, start=state.page*PAGE, slice=state.filtered.slice(start,start+PAGE);

    slice.forEach(p=>{
      const saleOn=isSaleActive(p), percent=pctOff(p);
      const out=(typeof p.stock==='number')? p.stock<=0 : p.inStock===false;
      const chips=(p.tags||[]).slice(0,5).map(t=>`<span class="badge text-bg-light border me-1 mb-1">#${t}</span>`).join('');

      grid.insertAdjacentHTML('beforeend', `
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100 shadow-sm position-relative">
            ${p.isBestSeller?`<span class="badge ribbon bg-warning text-dark">ฮิต</span>`:''}
            ${p.featured?`<span class="badge ribbon ribbon-right bg-primary">แนะนำ</span>`:''}
            ${saleOn?`<span class="badge badge-sale position-absolute top-0 start-50 translate-middle-x mt-2">ลด ${percent}%</span>`:''}
            <div class="ratio ratio-4x3">
              ${p.cover?`<img src="${p.cover}" class="w-100 h-100 object-fit-cover rounded-top ${out?'oos-img':''}" alt="">`:`<div class="bg-light rounded-top"></div>`}
            </div>
            <div class="card-body d-flex flex-column">
              <h6 class="mb-1">${p.name||''}</h6>
              <div class="price mb-1">
                ${saleOn?`<del>฿${(p.price||0).toLocaleString()}</del> <span class="text-danger">฿${(p.salePrice||0).toLocaleString()}</span>`:`฿${(p.price||0).toLocaleString()}${p.unit?` / ${p.unit}`:''}`}
              </div>
              <div class="mb-2 d-flex flex-wrap">${chips}</div>
              <p class="text-muted flex-grow-1 line-clamp-2">${p.desc||''}</p>
              <button class="btn btn-outline-primary mt-auto" data-bs-toggle="modal" data-bs-target="#prod-${p.id}" ${out?'disabled':''}>ดูรายละเอียด</button>
            </div>
          </div>
        </div>`);

      const gal=Array.isArray(p.gallery)?p.gallery:[];
      mods.insertAdjacentHTML('beforeend', `
        <div class="modal fade" id="prod-${p.id}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${p.name||''}</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${gal.length?`
                <div id="gal-${p.id}" class="carousel slide mb-3" data-bs-ride="carousel">
                  <div class="carousel-inner">
                    ${gal.map((u,i)=>`
                      <div class="carousel-item ${i===0?'active':''}">
                        <img src="${u}" class="d-block w-100 rounded" alt="">
                      </div>`).join('')}
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#gal-${p.id}" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
                  <button class="carousel-control-next" type="button" data-bs-target="#gal-${p.id}" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
                </div>`:''}
                <div class="fw-semibold mb-2">
                  ราคา: ${saleOn?`<del>฿${(p.price||0).toLocaleString()}</del> <span class="text-danger">฿${(p.salePrice||0).toLocaleString()}</span>`:`฿${(p.price||0).toLocaleString()}${p.unit?` / ${p.unit}`:''}`}
                </div>
                <div class="small text-muted mb-2">${(p.tags||[]).join(' · ')}</div>
                <p style="white-space:pre-line">${p.desc||''}</p>
              </div>
            </div>
          </div>
        </div>`);
    });

    $('#resultInfo').textContent = `ทั้งหมด ${state.filtered.length} รายการ — หน้า ${state.page+1} / ${Math.max(1, Math.ceil(state.filtered.length / 12))}`;
    $('#prevPage').disabled = state.page <= 0;
    $('#nextPage').disabled = (state.page + 1) * 12 >= state.filtered.length;
  }

  function apply(){
    const qEl=$('#q'), sortEl=$('#sort'), featEl=$('#onlyFeatured');
    const q=qEl.value.trim(), sort=sortEl.value, onlyFeatured=featEl.checked, tags=getTags();
    const params=new URLSearchParams(location.search);
    q?params.set('q',q):params.delete('q'); params.set('sort',sort); params.set('featured',String(onlyFeatured));
    history.replaceState(null,'',`${location.pathname}?${params.toString()}`);
    state.filtered = state.all.filter(p=>productMatches(p,{q,sort,onlyFeatured,tags}));
    state.filtered = sortProducts(state.filtered, sort);
    state.page=0; renderGrid();
  }

  async function loadAll(){
    showLoader(true);
    try{
      const q1 = query(collection(db,'products'), where('isActive','==', true), orderBy('rank','asc'), limit(200));
      const snap = await getDocs(q1);
      state.all = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      setTags(initTags); // sync UI
      $('#q').value = initQ; $('#sort').value = initSort; $('#onlyFeatured').checked = initOnlyFeatured;
      apply();
    }finally{ showLoader(false); }
  }

  // helpers for tags
  function getTags(){ const p=new URLSearchParams(location.search); const t=p.get('tags'); return t? t.split(',').map(s=>s.trim()).filter(Boolean):[]; }
  function setTags(arr){ const p=new URLSearchParams(location.search); arr.length? p.set('tags',arr.join(',')) : p.delete('tags'); history.replaceState(null,'',`${location.pathname}?${p.toString()}`); renderActiveTags(arr); }

  // events
  document.getElementById('q').addEventListener('input', apply);
  document.getElementById('sort').addEventListener('change', apply);
  document.getElementById('onlyFeatured').addEventListener('change', apply);
  document.getElementById('btnClear').addEventListener('click', ()=>{ $('#q').value=''; $('#onlyFeatured').checked=false; $('#sort').value='rank-asc'; setTags([]); apply(); });
  document.getElementById('prevPage').addEventListener('click', ()=>{ if(state.page>0){ state.page--; renderGrid(); window.scrollTo({top:0,behavior:'smooth'}); }});
  document.getElementById('nextPage').addEventListener('click', ()=>{ const max=Math.ceil(state.filtered.length/12)-1; if(state.page<max){ state.page++; renderGrid(); window.scrollTo({top:0,behavior:'smooth'});} });

  await loadAll();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
