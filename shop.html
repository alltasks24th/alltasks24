<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>สินค้าทั้งหมด</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{ --brand:#6f42c1; --brand-50:#efe9ff; --brand-100:#d9ccff; }
    body{ background:#f6f1ff; }
    .page-wrap{ max-width:1100px; margin:auto; padding:24px 16px 80px; }
    .card{ border:0; border-radius:16px; }
    .card .btn-primary{ background:var(--brand); border-color:var(--brand); }
    .form-check-input:checked{ background-color:var(--brand); border-color:var(--brand); }
    .btn-outline-secondary{ border-color:#e4e4e4; }

    .product-card{ position:relative; border-radius:16px; overflow:hidden; }
    .product-card img{ aspect-ratio:16/10; object-fit:cover; }
    .badge-sale{
      position:absolute; top:10px; left:10px; z-index:3;
      background:#ff3b30; color:#fff; font-weight:700; font-size:12px;
      padding:4px 8px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px; margin-top:6px;
      background:var(--brand-50); color:var(--brand); border:1px solid var(--brand-100); }
    .price .old{ text-decoration:line-through; color:#9aa0a6; margin-right:8px; }
    .price .new{ color:var(--brand); font-weight:800; }

    .out-stock::after{
      content:"สินค้าหมด"; position:absolute; inset:0; z-index:4; display:flex;
      align-items:center; justify-content:center; background:rgba(0,0,0,.45);
      color:#fff; font-weight:800; letter-spacing:.5px; font-size:18px;
    }
    .btn-disabled{ pointer-events:none; opacity:.6; }

    .skel{ border-radius:16px; overflow:hidden; }
    .skel .ph{ background:#eee; border-radius:12px; }
    .ph-line{ height:10px; width:60%; margin:10px 0; }
    .ph-img{ height:180px; }
  </style>
</head>
<body>

<div class="page-wrap">
  <div class="d-flex justify-content-end">
    <a href="/" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> กลับหน้าแรก</a>
  </div>

  <h1 class="h4 mt-2 mb-1">สินค้าทั้งหมด</h1>
  <div class="text-muted small mb-3" id="foundText"></div>

  <div class="row g-2 align-items-center mb-3">
    <div class="col-12 col-md">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="q" class="form-control" placeholder="ค้นหา (ชื่อ/แท็ก)">
        <button id="btnClear" class="btn btn-outline-secondary">ล้าง</button>
      </div>
    </div>
    <div class="col-auto">
      <select id="sortBy" class="form-select">
        <option value="rank">เรียงตามลำดับ (แนะนำ)</option>
      </select>
    </div>
    <div class="col-auto">
      <div class="form-check">
        <input id="onlyFeatured" class="form-check-input" type="checkbox">
        <label class="form-check-label" for="onlyFeatured">แสดงเฉพาะแนะนำ</label>
      </div>
    </div>
  </div>

  <div id="grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-2 g-3"></div>

  <div class="d-flex justify-content-center gap-2 mt-3">
    <button id="btnPrev" class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-left"></i> ก่อนหน้า</button>
    <span id="pageInfo" class="align-self-center small text-muted">1 / 1</span>
    <button id="btnNext" class="btn btn-outline-secondary btn-sm">ถัดไป <i class="bi bi-chevron-right"></i></button>
  </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="pmTitle" class="modal-title"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <img id="pmImg" class="img-fluid rounded mb-3" alt="">
        <div id="pmPrice" class="mb-2"></div>
        <div id="pmChips" class="mb-2"></div>
        <div id="pmStock" class="mb-1"></div>
        <div id="pmPromo" class="small text-muted"></div>
        <div id="pmDesc" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <a id="pmCall" class="btn btn-outline-dark"><i class="bi bi-telephone"></i> โทร</a>
        <a id="pmLine" class="btn btn-success"><i class="bi bi-chat-dots"></i> LINE</a>
        <a id="pmFb"   class="btn btn-primary"><i class="bi bi-facebook"></i> Facebook</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>

<!-- (ถ้ามี public.js อยู่คนละที่ ให้แก้ path ให้ตรงโปรเจค) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="/public.js"></script>

<script>
(() => {
  const $ = s=>document.querySelector(s);
  const grid = $('#grid');
  const fmtBaht = n => (n ?? 0).toLocaleString('th-TH');
  const fmtDT   = v => v ? new Date(v).toLocaleString('th-TH',{dateStyle:'medium',timeStyle:'short'}) : '';

  // ---------- ป้องกันค้างสเกลตัน: หา Firestore จากอะไรก็ได้ที่โปรเจคมี ----------
  function getDB(){
    try{
      if (window.firebase && window.firebase.apps && window.firebase.apps.length){
        return window.firebase.firestore();
      }
    }catch(e){}
    if (window.db) return window.db;               // โปรเจคเก่าอาจสร้างไว้
    if (window.firestore) return window.firestore; // หรือชื่อ firestore ตรงๆ
    throw new Error('ไม่พบการตั้งค่า Firestore (ตรวจ path ของ public.js)');
  }

  function isSaleActive(p){
    const now = Date.now();
    const start = p.saleStart ? new Date(p.saleStart).getTime() : -Infinity;
    const end   = p.saleEnd   ? new Date(p.saleEnd).getTime()   :  Infinity;
    return +p.price>0 && +p.salePrice>0 && +p.salePrice < +p.price && now>=start && now<=end;
  }
  const salePercent = p => isSaleActive(p) ? Math.round(100 - (p.salePrice/p.price)*100) : 0;

  let settings = {};
  async function loadSettings(){
    try{
      const db = getDB();
      const snap = await db.collection('settings').limit(1).get();
      if(!snap.empty) settings = {...snap.docs[0].data()};
    }catch(e){ /* ข้ามได้ ไม่ให้ค้าง */ }
  }

  const PAGE = 6;
  let current = 0;
  let lastSnapshot = null;
  const productsMap = new Map();

  function skeleton(){
    let html='';
    for(let i=0;i<PAGE;i++){
      html += `
      <div class="col">
        <div class="card skel p-3">
          <div class="ph ph-img"></div>
          <div class="ph-line" style="width:70%"></div>
          <div class="ph-line" style="width:40%"></div>
          <div class="ph-line" style="width:55%"></div>
        </div>
      </div>`;
    }
    grid.innerHTML = html;
  }

  function renderCard(p){
    const saleOn = isSaleActive(p);
    const percent = salePercent(p);
    const chips = [
      p.featured     ? '<span class="chip">แนะนำ</span>' : '',
      p.isBestSeller ? '<span class="chip">ฮิต</span>'    : '',
      p.isNew        ? '<span class="chip">ใหม่</span>'   : '',
      p.freeShip     ? '<span class="chip">ส่งฟรี</span>' : ''
    ].join('');

    const priceHtml = saleOn
      ? `<div class="price"><span class="old">฿${fmtBaht(p.price)}</span><span class="new">฿${fmtBaht(p.salePrice)}</span></div>`
      : `<div class="price"><span class="new">฿${fmtBaht(p.price)}</span></div>`;

    let stockLine = '';
    let outCls = '';
    if(typeof p.stock === 'number'){
      if(p.stock<=0){ stockLine = `<span class="text-danger fw-semibold">สต็อก: 0</span>`; outCls=' out-stock'; }
      else stockLine = `<span class="text-muted">สต็อก: ${p.stock}</span>`;
    }

    return `
    <div class="col">
      <div class="card shadow-sm product-card${outCls}">
        ${saleOn ? `<div class="badge-sale">ลด ${percent}%</div>` : ``}
        <img class="card-img-top" src="${p.cover || '/assets/placeholder.jpg'}" alt="${p.name||''}" loading="lazy">
        <div class="card-body">
          <h6 class="card-title mb-1">${p.name||''}</h6>
          ${priceHtml}
          <div class="mt-1">${chips}</div>
          <div class="small mt-2">${stockLine}</div>
          <button class="btn btn-primary w-100 mt-2 ${outCls? 'btn-disabled':''}"
                  onclick="openProductModal('${p.id}')">ดูรายละเอียด</button>
        </div>
      </div>
    </div>`;
  }

  function renderList(docs){
    if(docs.length===0){
      grid.innerHTML = `<div class="text-center text-muted py-5">ไม่พบข้อมูล</div>`;
      $('#foundText').textContent = `พบทั้งหมด 0 รายการ`;
      return;
    }
    let html='';
    docs.forEach(d=>{
      const p = d.data(); p.id = d.id;
      productsMap.set(p.id, p);
      html += renderCard(p);
    });
    grid.innerHTML = html;
    $('#foundText').textContent = `พบทั้งหมด ${docs.length} รายการ`;
  }

  async function fetchPage(){
    skeleton();
    let snap;
    try{
      const db = getDB();
      const onlyFeatured = $('#onlyFeatured').checked;
      const qText = ($('#q').value || '').trim().toLowerCase();

      let q = db.collection('products')
                .where('isActive','==',true)
                .orderBy('rank')
                .limit(PAGE);

      if(onlyFeatured) q = db.collection('products')
                             .where('isActive','==',true)
                             .where('featured','==',true)
                             .orderBy('rank')
                             .limit(PAGE);

      snap = await q.get();
      lastSnapshot = snap;

      let docs = snap.docs;
      if(qText){
        docs = docs.filter(d=>{
          const p = d.data();
          const name = (p.name||'').toLowerCase();
          const tags = Array.isArray(p.tags) ? p.tags.join(',').toLowerCase() : (p.tags||'').toLowerCase();
          return name.includes(qText) || tags.includes(qText);
        });
      }

      renderList(docs);
      $('#pageInfo').textContent = `1 / 1`;
      $('#btnPrev').disabled = true;
      $('#btnNext').disabled = true;

    }catch(err){
      console.error(err);
      grid.innerHTML = `<div class="text-center text-danger py-5">โหลดข้อมูลไม่สำเร็จ<br><small>${(err && err.message)||''}</small></div>`;
    }
  }

  window.openProductModal = function(id){
    const p = productsMap.get(id);
    if(!p) return;
    const saleOn = isSaleActive(p);
    const percent = salePercent(p);

    const priceBlock = saleOn
      ? `<div class="price"><span class="old">฿${fmtBaht(p.price)}</span>
          <span class="new">฿${fmtBaht(p.salePrice)}</span>
          <span class="badge-sale" style="position:static;margin-left:8px">ลด ${percent}%</span></div>`
      : `<div class="price"><span class="new">฿${fmtBaht(p.price)}</span></div>`;

    const chips = [
      p.featured     ? '<span class="chip">แนะนำ</span>' : '',
      p.isBestSeller ? '<span class="chip">ฮิต</span>'    : '',
      p.isNew        ? '<span class="chip">ใหม่</span>'   : '',
      p.freeShip     ? '<span class="chip">ส่งฟรี</span>' : ''
    ].join('');

    const stockLine = (typeof p.stock==='number')
      ? (p.stock<=0 ? `<span class="text-danger fw-semibold">สต็อก: 0</span>` : `สต็อก: ${p.stock}`)
      : '';

    const promoLine = p.saleStart
      ? `เริ่มโปรฯ: ${fmtDT(p.saleStart)}${p.saleEnd?` · จบ: ${fmtDT(p.saleEnd)}`:''}`
      : '';

    $('#pmTitle').textContent = p.name || '';
    $('#pmImg').src = p.cover || '/assets/placeholder.jpg';
    $('#pmPrice').innerHTML = priceBlock;
    $('#pmChips').innerHTML = chips;
    $('#pmStock').innerHTML = stockLine;
    $('#pmPromo').textContent = promoLine;
    $('#pmDesc').textContent = p.desc || '';

    const tel = (settings?.phone||'').replace(/\s/g,'');
    $('#pmCall').href = tel ? `tel:${tel}` : '#';
    $('#pmLine').href = settings?.line ? `https://line.me/R/ti/p/${(settings.line||'').replace('@','')}` : '#';
    $('#pmFb').href   = settings?.facebook || '#';

    new bootstrap.Modal('#productModal').show();
  };

  $('#btnPrev').addEventListener('click', ()=>{});
  $('#btnNext').addEventListener('click', ()=>{});
  $('#btnClear').addEventListener('click', ()=>{ $('#q').value=''; fetchPage(); });
  $('#q').addEventListener('input', ()=>fetchPage());
  $('#onlyFeatured').addEventListener('change', ()=>fetchPage());
  $('#sortBy').addEventListener('change', ()=>fetchPage());

  (async function init(){
    skeleton();
    await loadSettings();
    fetchPage();
  })();

})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
