<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>AllTasks24 ‚Äî ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÇ‡∏ó‡∏ô‡∏°‡πà‡∏ß‡∏á) + ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</title>
<style>
:root{
  --bg:#f6f5fb; --surface:#ffffff; --muted:#6b7280; --text:#0f172a; --line:#e5e7eb;
  --accent:#7c3aed; --accent-2:#a78bfa;
  --danger:#ef4444; --warn:#f59e0b; --ok:#16a34a;
  --radius:16px; --shadow:0 12px 28px rgba(17,24,39,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; background:var(--bg); color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Kanit", Arial, Tahoma, sans-serif;}
.container{max-width:1100px; margin:0 auto; padding:18px 12px 100px}
header{position:sticky; top:0; z-index:5; background:rgba(255,255,255,.85); backdrop-filter:blur(10px) saturate(120%);
  border-bottom:1px solid var(--line);}
.head{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px}
h1{margin:0; font-size:18px}
.actions{display:flex; gap:8px; flex-wrap:wrap}
.btn{border:1px solid var(--line); background:#fff; padding:9px 12px; border-radius:10px; cursor:pointer}
.btn.primary{background:var(--accent); color:#fff; border-color:transparent}
.btn.danger{background:#fee2e2; border-color:#fecaca; color:#b91c1c}
.btn:disabled{opacity:.6; cursor:not-allowed}
.kpis{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px}
@media (max-width:900px){.kpis{grid-template-columns:repeat(2, minmax(0,1fr))}}
.card{background:var(--surface); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
.card h3{margin:0 0 8px; font-size:15px}
.kpi{display:flex; align-items:baseline; gap:8px}
.kpi .big{font-size:30px; font-weight:800}
.mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
.caption{font-size:12px; color:var(--muted)}
.grid{display:grid; gap:12px}
.grid-2{grid-template-columns:repeat(2, minmax(0,1fr))}
@media (max-width:1000px){.grid-2{grid-template-columns:1fr}}
table{width:100%; border-collapse:collapse; border:1px solid var(--line); border-radius:12px; overflow:hidden}
thead{background:#f8fafc; color:#475569}
th,td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top}
tr:last-child td{border-bottom:none}
.badge{display:inline-flex; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#fff; color:#475569}
.badge.ok{background:#ecfdf5; color:#065f46; border-color:#d1fae5}
.badge.warn{background:#fffbeb; color:#92400e; border-color:#fde68a}
.badge.danger{background:#fef2f2; color:#991b1b; border-color:#fecaca}
.row{display:flex; gap:10px; flex-wrap:wrap}
.row>*{flex:1 1 160px}
input,select,textarea{width:100%; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; outline:none; color:#0f172a}
.hbar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden}
.hbar>i{display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); width:0%}
hr.sep{border:none; border-top:1px dashed var(--line); margin:10px 0}
.small{font-size:12px}

/* Segmented control + period nav */
.segment{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:10px 0 6px}
.seg{display:inline-flex; padding:4px; border:1px solid var(--line); border-radius:999px; background:#fff; box-shadow:var(--shadow);}
.seg button{border:none; background:transparent; padding:8px 12px; border-radius:999px; cursor:pointer; font-size:13px}
.seg button.active{background:var(--accent); color:#fff}
.periodnav{display:flex; align-items:center; gap:8px}
.periodnav .btn{padding:7px 10px}
.period-label{font-weight:700}

/* Accordion */
.acc{margin-top:14px}
.acc .acc-item{border:1px solid var(--line); border-radius:12px; background:#fff; box-shadow:var(--shadow); margin-bottom:10px; overflow:hidden}
.acc .acc-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer; background:linear-gradient(180deg,#fff,#fafbff)}
.acc .acc-head h3{margin:0; font-size:15px}
.acc .acc-body{display:none; padding:14px}
.acc .acc-item.open .acc-body{display:block}

/* Pager */
.pager{display:flex; align-items:center; justify-content:flex-end; gap:8px; margin:8px 0 2px; flex-wrap:wrap}
.pager .btn{padding:6px 10px}
.pager .info{font-size:12px; color:#6b7280}

/* Responsive tables -> stacked cards on small screens */
@media (max-width: 720px){
  table.rtbl thead{display:none}
  table.rtbl, table.rtbl tbody, table.rtbl tr, table.rtbl td{display:block; width:100%}
  table.rtbl tr{background:#fff; border:1px solid var(--line); margin-bottom:10px; border-radius:12px; overflow:hidden}
  table.rtbl td{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; border-bottom:1px dashed var(--line)}
  table.rtbl td:last-child{border-bottom:none}
  table.rtbl td::before{content:attr(data-label); font-weight:600; color:#6b7280}
}
</style>
<meta content="noindex,nofollow" name="robots"/><link href="https://alltasks24.online/admin-income.html" rel="canonical"/><meta content="‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏±‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‚Äî ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ô‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" name="description"/><meta content="AllTasks24 ‚Äî ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÇ‡∏ó‡∏ô‡∏°‡πà‡∏ß‡∏á) + ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" property="og:title"/><meta content="‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏±‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‚Äî ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ô‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" property="og:description"/><meta content="https://alltasks24.online/icons/android-chrome-512x512.png" property="og:image"/><meta content="https://alltasks24.online/admin-income.html" property="og:url"/><meta content="website" property="og:type"/><meta content="AllTasks24" property="og:site_name"/><meta content="summary_large_image" name="twitter:card"/><meta content="AllTasks24 ‚Äî ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÇ‡∏ó‡∏ô‡∏°‡πà‡∏ß‡∏á) + ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" name="twitter:title"/><meta content="‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏±‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‚Äî ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ô‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" name="twitter:description"/><meta content="https://alltasks24.online/icons/android-chrome-512x512.png" name="twitter:image"/></head>
<body>
<header>
<div class="container head">
<h1>AllTasks24 ¬∑ ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏°‡πà‡∏ß‡∏á) + ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>
<div class="actions">
<button class="btn" id="seedBtn">‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
<button class="btn" id="clearBtn">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>
</div>
</header>
<main class="container">
<!-- Overview -->
<section class="card">
<div class="segment">
<div class="seg" id="granularity">
<button class="active" data-g="day">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
<button data-g="week">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
<button data-g="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
<button data-g="year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
</div>
<div class="periodnav">
<button class="btn" id="prevBtn">‚óÄÔ∏é</button>
<div class="period-label" id="periodLabel">‚Äî</div>
<button class="btn" id="nextBtn">‚ñ∂Ô∏é</button>
</div>
</div>
<div class="kpis">
<div class="card"><h3>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</h3><div class="kpi"><div class="big mono" id="kpiIn">0</div><span class="caption" id="curLabel">‡∏ö‡∏≤‡∏ó</span></div></div>
<div class="card"><h3>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</h3><div class="kpi"><div class="big mono" id="kpiOut">0</div><span class="caption" id="curLabel2">‡∏ö‡∏≤‡∏ó</span></div></div>
<div class="card"><h3>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</h3><div class="kpi"><div class="big mono" id="kpiNet">0</div><span class="caption" id="curLabel3">‡∏ö‡∏≤‡∏ó</span></div></div>
<div class="card"><h3>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3><div class="kpi"><div class="big mono" id="kpiBal">0</div><span class="caption" id="curLabel4">‡∏ö‡∏≤‡∏ó</span></div></div>
</div>
<div class="grid grid-2" style="margin-top:12px">
<div class="card">
<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
<div id="catSum"></div>
</div>
<div class="card">
<h3>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
<table class="rtbl"><thead><tr><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th class="mono">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead><tbody id="acctTable"></tbody></table>
</div>
</div>
<div class="card" style="margin-top:12px">
<h3>‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
<canvas id="cfChart" style="width:100%;max-height:220px;background:#fff;border:1px solid var(--line);border-radius:12px"></canvas>
<div class="caption">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)</div>
</div>
</section>
<!-- Accordion sections -->
<section class="acc">
<div class="acc-item open">
<div class="acc-head"><h3>üßæ ‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á/Export)</h3><div class="caption">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢</div></div>
<div class="acc-body">
<div class="grid grid-2">
<div>
<div class="card">
<h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
<div class="row">
<div><div class="caption">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><input id="t_date" type="date"/></div>
<div><div class="caption">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div><select id="t_type"><option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option><option value="transfer">‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</option></select></div>
<div><div class="caption">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><select id="t_accIn"></select></div>
<div><div class="caption">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><select id="t_accOut"></select></div>
</div>
<div class="row">
<div><div class="caption">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div><select id="t_cat"></select></div>
<div><div class="caption">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div><input id="t_amt" step="0.01" type="number" value="0"/></div>
<div><div class="caption">‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><input id="t_party" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô A / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ B"/></div>
</div>
<div class="row"><div style="flex:1 1 100%"><div class="caption">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (#‡πÅ‡∏ó‡πá‡∏Å)</div><input id="t_note"/></div></div>
<div class="row" style="justify-content:flex-end; margin-top:8px"><button class="btn primary" id="btnAddTx">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></div>
</div>
<div class="card">
<h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏´‡∏°‡∏ß‡∏î</h3>
<div class="row">
<div>
<div class="caption">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><input id="a_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î"/>
<div class="caption">‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</div><input id="a_open" step="0.01" type="number" value="0"/>
<div class="row" style="justify-content:flex-end; margin-top:8px"><button class="btn" id="btnAddAcc">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button></div>
</div>
<div>
<div class="caption">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</div>
<div class="row">
<div><select id="c_type"><option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select></div>
<div><input id="c_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î"/></div>
<div><input id="c_budget" placeholder="‡∏á‡∏ö/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)" step="0.01" type="number" value="0"/></div>
</div>
<div class="row" style="justify-content:flex-end; margin-top:8px"><button class="btn" id="btnAddCat">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button></div>
</div>
</div>
</div>
</div>
<div>
<div class="card">
<h3>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + Export</h3>
<div class="row">
<div><div class="caption">‡∏à‡∏≤‡∏Å</div><input id="f_from" type="date"/></div>
<div><div class="caption">‡∏ñ‡∏∂‡∏á</div><input id="f_to" type="date"/></div>
<div><div class="caption">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div><select id="f_type"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option>income</option><option>expense</option><option>transfer</option></select></div>
<div><div class="caption">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><select id="f_acc"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div>
<div><div class="caption">‡∏´‡∏°‡∏ß‡∏î</div><select id="f_cat"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div>
</div>
<div class="row" style="justify-content:flex-end; margin-top:8px">
<button class="btn" id="btnClearFilters">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
<button class="btn primary" id="btnExportCSV">Export CSV</button>
</div>
</div>
<div class="card">
<div class="row" style="align-items:center; justify-content:space-between">
<h3 style="margin:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
<div class="pager" id="txPagerTop"></div>
</div>
<table class="rtbl">
<thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤</th><th class="mono">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th></th></tr></thead>
<tbody id="txTable"></tbody>
</table>
<div class="pager" id="txPager"></div>
</div>
<div class="grid grid-2">
<div class="card">
<div class="row" style="align-items:center; justify-content:space-between">
<h3 style="margin:0">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
</div>
<table class="rtbl"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th class="mono">‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</th><th class="mono">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th><th></th></tr></thead><tbody id="accList"></tbody></table>
</div>
<div class="card">
<div class="row" style="align-items:center; justify-content:space-between">
<h3 style="margin:0">‡∏´‡∏°‡∏ß‡∏î</h3>
</div>
<table class="rtbl"><thead><tr><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th class="mono">‡∏á‡∏ö/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th></th></tr></thead><tbody id="catList"></tbody></table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="acc-item">
<div class="acc-head"><h3>üì¶ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤/‡∏õ‡∏£‡∏±‡∏ö + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3><div class="caption">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢</div></div>
<div class="acc-body">
<div class="grid grid-2">
<div class="card">
<h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
<div class="row">
<div><div class="caption">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><input id="m_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 10W-40"/></div>
<div><div class="caption">‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><input id="m_unit" placeholder="‡∏Ç‡∏ß‡∏î / ‡∏ä‡∏¥‡πâ‡∏ô / ‡πÄ‡∏™‡πâ‡∏ô"/></div>
<div><div class="caption">SKU</div><input id="m_sku" placeholder="SKU"/></div>
<div><div class="caption">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</div><input id="m_bar" placeholder="‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î"/></div>
<div><div class="caption">Reorder</div><input id="m_reorder" type="number" value="0"/></div>
</div>
<div class="row" style="justify-content:flex-end; margin-top:8px"><button class="btn primary" id="btnAddMat">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button></div>
</div>
<div class="card">
<h3>‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
<div class="row">
<div><div class="caption">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><select id="mm_sel"></select></div>
<div><div class="caption">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (+/‚àí)</div><input id="mm_qty" step="0.01" type="number" value="1"/></div>
<div><div class="caption">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤)</div><input id="mm_cost" step="0.01" type="number" value="0"/></div>
<div><div class="caption">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div><select id="mm_type"><option value="in">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="adjust">‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</option></select></div>
</div>
<div class="row" style="justify-content:flex-end; margin-top:8px"><button class="btn primary" id="btnDoMove">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
<div class="caption">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ = ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ñ‡∏±‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
</div>
</div>
<div class="card" style="margin-top:10px">
<div class="row" style="align-items:center; justify-content:space-between">
<h3 style="margin:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
<div class="pager" id="matPagerTop"></div>
</div>
<table class="rtbl">
<thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>SKU</th><th>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</th><th class="mono">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="mono">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th class="mono">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th class="mono">Reorder</th><th></th></tr></thead>
<tbody id="matTable"></tbody>
</table>
<div class="pager" id="matPager"></div>
</div>
<div class="card" style="margin-top:10px">
<div class="row" style="align-items:center; justify-content:space-between">
<h3 style="margin:0">‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
<div class="pager" id="movePagerTop"></div>
</div>
<table class="rtbl">
<thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="mono">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="mono">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th></tr></thead>
<tbody id="moveTable"></tbody>
</table>
<div class="pager" id="movePager"></div>
</div>
</div>
</div>
<div class="acc-item">
<div class="acc-head"><h3>üìã ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å (Cycle Count)</h3><div class="caption">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢</div></div>
<div class="acc-body">
<div class="grid grid-2">
<div class="card">
<h3>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡∏ö</h3>
<div class="row">
<div><div class="caption">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö</div><input id="c_name" placeholder="Cycle Sep-2025"/></div>
<div><div class="caption">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div><input id="c_note" placeholder="‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏Ø‡∏•‡∏Ø"/></div>
</div>
<div class="row" style="justify-content:flex-end; margin-top:8px"><button class="btn primary" id="btnStartCount">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡∏ö</button></div>
<div class="caption">‡∏£‡∏∞‡∏ö‡∏ö snapshot ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
</div>
<div class="card">
<h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡∏ö</h3>
<table class="rtbl">
<thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="mono">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th><th></th></tr></thead>
<tbody id="countList"></tbody>
</table>
</div>
</div>
<div class="card" id="countDetail" style="margin-top:10px; display:none"></div>
</div>
</div>
<div class="acc-item">
<div class="acc-head"><h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á/‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)</h3><div class="caption">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢</div></div>
<div class="acc-body">
<div class="grid grid-2">
<div class="card">
<h3>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h3>
<div class="row">
<div><div class="caption">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ô‡∏™‡∏∏‡∏î)</div>
<select id="set_gran"><option value="day">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="week">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option><option value="month">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option></select>
</div>
<div><div class="caption">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
<select id="set_weekStart"><option value="mon">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="sun">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option></select>
</div>
<div><div class="caption">‡∏™‡∏µ‡∏ò‡∏µ‡∏°</div><input id="set_color" type="color" value="#7c3aed"/></div>
</div>
<div class="row">
<div><div class="caption">‡∏Ñ‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô</div><input id="set_currency" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏≤‡∏ó"/></div>
<div><div class="caption">‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div><input id="set_decimals" max="4" min="0" type="number" value="2"/></div>
<div><div class="caption">‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Top N</div><input id="set_topCats" max="20" min="1" type="number" value="8"/></div>
</div>
</div>
<div class="card">
<h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</h3>
<div class="row">
<div><div class="caption">‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><select id="set_ps_tx"><option>10</option><option>25</option><option>50</option><option>100</option></select></div>
<div><div class="caption">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><select id="set_ps_mat"><option>10</option><option>25</option><option>50</option><option>100</option></select></div>
<div><div class="caption">‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div><select id="set_ps_move"><option>10</option><option>25</option><option>50</option><option>100</option></select></div>
</div>
</div>
</div>
<div class="row" style="justify-content:flex-end">
<button class="btn" id="btnResetSet">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
<button class="btn primary" id="btnSaveSet">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
</div>
</div>
</div>
<div class="acc-item">
<div class="acc-head"><h3>‚§¥Ô∏è ‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h3><div class="caption">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢</div></div>
<div class="acc-body">
<div class="row">
<div class="card" style="flex:1">
<h3>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
<button class="btn primary" id="btnExportJSON">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
</div>
<div class="card" style="flex:1">
<h3>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h3>
<input accept="application/json" id="importFile" type="file"/>
<div class="caption">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
</div>
</div>
</div>
</div>
</section>
</main>
<script>
// ===== Storage & Settings =====
const K = { TX:"ie5_tx", AC:"ie5_accounts", CAT:"ie5_categories", MAT:"ie5_materials", MOV:"ie5_moves", CT:"ie5_counts", SET:"ie5_settings" };
let tx = load(K.TX, []), accounts = load(K.AC, []), categories = load(K.CAT, []), materials = load(K.MAT, []), moves = load(K.MOV, []), counts = load(K.CT, []);
function load(k, d){ try{ return JSON.parse(localStorage.getItem(k)) || d; }catch(e){ return d; } }
function saveAll(){ localStorage.setItem(K.TX, JSON.stringify(tx)); localStorage.setItem(K.AC, JSON.stringify(accounts)); localStorage.setItem(K.CAT, JSON.stringify(categories)); localStorage.setItem(K.MAT, JSON.stringify(materials)); localStorage.setItem(K.MOV, JSON.stringify(moves)); localStorage.setItem(K.CT, JSON.stringify(counts)); localStorage.setItem(K.SET, JSON.stringify(settings)); }
function uid(p=""){ return p + Math.random().toString(36).slice(2,8) + "-" + Date.now().toString(36).slice(-4); }
const DEFSET = { pageSizeTx:25, pageSizeMat:25, pageSizeMove:25, defaultGranularity:"month", weekStart:"mon", currency:"‡∏ö‡∏≤‡∏ó", decimals:2, theme:"#7c3aed", catTopN:8 };
let settings = Object.assign({}, DEFSET, load(K.SET, {}));

// ===== Helpers =====
function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
function fmt(n){ return (Number(n)||0).toLocaleString("th-TH",{minimumFractionDigits:settings.decimals, maximumFractionDigits:settings.decimals}); }
function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
function indexById(arr){ const m={}; arr.forEach(o=>m[o.id]=o); return m; }
function lighten(hex, pct=0.3){ try{ let h=hex.replace("#",""); if(h.length===3) h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2]; const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16); const lr=Math.min(255, Math.round(r+(255-r)*pct)); const lg=Math.min(255, Math.round(g+(255-g)*pct)); const lb=Math.min(255, Math.round(b+(255-b)*pct)); return "#"+[lr,lg,lb].map(v=>v.toString(16).padStart(2,"0")).join(""); }catch(e){ return "#a78bfa"; } }

// Apply theme + labels
function applyLook(){
  document.documentElement.style.setProperty('--accent', settings.theme);
  document.documentElement.style.setProperty('--accent-2', lighten(settings.theme, 0.35));
  document.getElementById('curLabel').textContent = settings.currency;
  document.getElementById('curLabel2').textContent = settings.currency;
  document.getElementById('curLabel3').textContent = settings.currency;
  document.getElementById('curLabel4').textContent = settings.currency;
}

// ===== Accordion =====
document.querySelectorAll('.acc-head').forEach(h=>{
  h.addEventListener('click', ()=> h.parentElement.classList.toggle('open'));
});

// ===== Period State =====
const state = { g:settings.defaultGranularity, offset:0, p_tx:1, p_mat:1, p_move:1 };
const seg = document.getElementById('granularity');
seg.querySelectorAll('button').forEach(b=>{
  if(b.dataset.g===state.g) b.classList.add('active');
  b.addEventListener('click', ()=>{
    seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); state.g = b.dataset.g; state.offset = 0; renderAll();
  });
});
document.getElementById('prevBtn').addEventListener('click', ()=>{ state.offset -= 1; renderAll(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ if(state.offset<0) { state.offset += 1; renderAll(); } });

function startOfWeek(d){
  const dt=new Date(d);
  let day=dt.getDay(); // 0=Sun
  const weekStart = settings.weekStart==="sun"? 0 : 1;
  const delta = (day - weekStart + 7) % 7;
  dt.setDate(dt.getDate() - delta); dt.setHours(0,0,0,0); return dt;
}
function periodRange(g, offset){
  const now = new Date(); now.setHours(0,0,0,0);
  const cur = new Date(now);
  if(g==='day'){ cur.setDate(cur.getDate()+offset); const start=cur; const end=new Date(cur); end.setDate(end.getDate()+1); return [start,end, start.toLocaleDateString('th-TH')]; }
  if(g==='week'){ const base = startOfWeek(cur); base.setDate(base.getDate()+7*offset); const start=base; const end=new Date(base); end.setDate(end.getDate()+7);
    const lab = `${start.toLocaleDateString('th-TH')} ‚Äì ${new Date(end-1).toLocaleDateString('th-TH')}`; return [start,end, lab]; }
  if(g==='month'){ const base = new Date(cur.getFullYear(), cur.getMonth()+offset, 1); const start=base; const end=new Date(base.getFullYear(), base.getMonth()+1, 1);
    const lab = start.toLocaleString('th-TH', {month:'long', year:'numeric'}); return [start,end, lab]; }
  if(g==='year'){ const y = cur.getFullYear()+offset; const start=new Date(y,0,1); const end=new Date(y+1,0,1); const lab = start.toLocaleString('th-TH', {year:'numeric'}); return [start,end, lab]; }
}
function txInRange(start,end){ return tx.filter(t=>{ const d=new Date(t.date); return d>=start && d<end; }); }

// ===== Overview Rendering =====
function computeBalances(){ const bal={}; accounts.forEach(a=> bal[a.id]=Number(a.opening||0));
  tx.forEach(t=>{ if(t.type==='income'){ bal[t.accIn]=(bal[t.accIn]||0)+Number(t.amount||0); }
    else if(t.type==='expense'){ bal[t.accOut]=(bal[t.accOut]||0)-Number(t.amount||0); }
    else if(t.type==='transfer'){ bal[t.accOut]=(bal[t.accOut]||0)-Number(t.amount||0); bal[t.accIn]=(bal[t.accIn]||0)+Number(t.amount||0); } });
  return bal;
}
function renderOverview(){
  const [start,end,label] = periodRange(state.g, state.offset);
  document.getElementById('periodLabel').textContent = label;
  document.getElementById('nextBtn').disabled = (state.offset===0);

  const list = txInRange(start,end);
  let inSum=0, outSum=0;
  list.forEach(t=>{ if(t.type==='income') inSum+=Number(t.amount||0); else if(t.type==='expense') outSum+=Number(t.amount||0); });
  document.getElementById('kpiIn').textContent = fmt(inSum);
  document.getElementById('kpiOut').textContent = fmt(outSum);
  document.getElementById('kpiNet').textContent = fmt(inSum-outSum);
  const bal=computeBalances(); const total=Object.values(bal).reduce((s,v)=>s+Number(v||0),0);
  document.getElementById('kpiBal').textContent = fmt(total);
  const am=indexById(accounts);
  document.getElementById('acctTable').innerHTML = Object.keys(bal).map(id=> `<tr><td data-label="‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">${esc(am[id]?.name||id)}</td><td class="mono" data-label="‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">${fmt(bal[id])}</td></tr>`).join("") || `<tr><td colspan="2" class="caption">‚Äî</td></tr>`;

  // Category summary (expense)
  const cm = {}; const catMap=indexById(categories);
  list.forEach(t=>{ if(t.type==='expense'){ cm[t.cat]=(cm[t.cat]||0)+Number(t.amount||0); } });
  const entries = Object.entries(cm).sort((a,b)=>b[1]-a[1]).slice(0, settings.catTopN || 8);
  const tot = entries.reduce((s,[_,v])=>s+v,0);
  document.getElementById('catSum').innerHTML = entries.map(([cid,val])=>{
    const pct = tot? Math.round(val*100/tot) : 0;
    return `<div style="margin:8px 0"><div class="row" style="align-items:center"><div style="flex:1"><b>${esc(catMap[cid]?.name||'‚Äî')}</b></div><div class="mono">${fmt(val)}</div></div><div class="hbar"><i style="width:${pct}%"></i></div></div>`;
  }).join("") || `<div class="caption">‚Äî</div>`;

  drawCashflow(start,end);
}
function fitCanvas(){
  const c = document.getElementById('cfChart');
  const rect = c.getBoundingClientRect();
  c.width = Math.max(320, Math.floor(rect.width));
  c.height = 170;
}
function drawCashflow(start,end){
  fitCanvas();
  const c = document.getElementById('cfChart');
  const ctx = c.getContext('2d'); const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  // build bins according to state.g
  let bins=[];
  if(state.g==='day'){
    const endDay = new Date(end); const startDay = new Date(end); startDay.setDate(endDay.getDate()-14);
    for(let d=new Date(startDay); d<endDay; d.setDate(d.getDate()+1)){ bins.push({key:d.toISOString().slice(0,10), label:d}); }
  }else if(state.g==='week' || state.g==='month'){
    for(let d=new Date(start); d<end; d.setDate(d.getDate()+1)){ bins.push({key:d.toISOString().slice(0,10), label:d}); }
  }else if(state.g==='year'){
    for(let m=0;m<12;m++){ const s=new Date(start.getFullYear(), m, 1); bins.push({key:`${s.getFullYear()}-${String(m+1).padStart(2,'0')}`, label:s}); }
  }
  const inVals=[], outVals=[];
  bins.forEach(b=>{
    let sumIn=0, sumOut=0;
    if(state.g==='year'){
      tx.forEach(t=>{ if(t.date.startsWith(b.key)){ if(t.type==='income') sumIn+=Number(t.amount||0); else if(t.type==='expense') sumOut+=Number(t.amount||0); } });
    }else{
      tx.forEach(t=>{ if(t.date===b.key){ if(t.type==='income') sumIn+=Number(t.amount||0); else if(t.type==='expense') sumOut+=Number(t.amount||0); } });
    }
    inVals.push(sumIn); outVals.push(sumOut);
  });
  const vals = inVals.concat(outVals.map(v=>-v)); const min=Math.min(0,...vals), max=Math.max(0,...vals);
  const pad=14, xStep=W/(bins.length-1 || 1), yScale=v=> H-pad - ((v-min)*(H-2*pad)/((max-min)||1));
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1; const y0=yScale(0); ctx.beginPath(); ctx.moveTo(0,y0); ctx.lineTo(W,y0); ctx.stroke();
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent') || "#7c3aed";
  ctx.lineWidth=2; ctx.beginPath();
  inVals.forEach((v,i)=>{ const x=i*xStep; const y=yScale(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
  outVals.forEach((v,i)=>{ const x=i*xStep; const y=yScale(-v); ctx.strokeStyle="#ef4444"; ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y); ctx.stroke(); });
}
window.addEventListener('resize', ()=>{ const [s,e]=periodRange(state.g, state.offset); drawCashflow(s,e); });

// ===== Ledger =====
const el = id=>document.getElementById(id);
const t_date = el('t_date'); t_date.value=todayISO();
function refreshSelectors(){
  const acctOpts = accounts.map(a=> `<option value="${a.id}">${esc(a.name)}</option>`).join("");
  el('t_accIn').innerHTML = acctOpts; el('t_accOut').innerHTML = acctOpts; el('f_acc').innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'+acctOpts;
  const catByType = type=> categories.filter(c=>c.type===type).map(c=> `<option value="${c.id}">${esc(c.name)}</option>`).join("");
  el('t_cat').innerHTML = catByType(el('t_type').value);
  const allCats = categories.map(c=> `<option value="${c.id}">${esc(c.name)}</option>`).join("");
  el('f_cat').innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'+allCats;
}
el('t_type').addEventListener('change', ()=>{
  refreshSelectors();
  el('t_accIn').parentElement.parentElement.style.display = (el('t_type').value!=='expense')?'block':'none';
  el('t_accOut').parentElement.parentElement.style.display = (el('t_type').value!=='income')?'block':'none';
});
el('btnAddTx').addEventListener('click', ()=>{
  const type=el('t_type').value, amount=Number(el('t_amt').value||0);
  if(amount<=0) return alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
  if(type==='income' && !el('t_accIn').value) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
  if(type==='expense' && !el('t_accOut').value) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡πà‡∏≤‡∏¢');
  if(type==='transfer' && (!el('t_accIn').value || !el('t_accOut').value)) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÇ‡∏≠‡∏ô/‡∏£‡∏±‡∏ö');
  tx.unshift({id:uid("TX"), date: el('t_date').value || todayISO(), type, accIn: type!=='expense'?el('t_accIn').value:null, accOut: type!=='income'?el('t_accOut').value:null, cat: el('t_cat').value||null, amount, party: el('t_party').value.trim(), note: el('t_note').value.trim()});
  el('t_amt').value=0; el('t_party').value=''; el('t_note').value=''; saveAll(); renderAll();
});
el('btnAddAcc').addEventListener('click', ()=>{
  const name=el('a_name').value.trim(), opening=Number(el('a_open').value||0); if(!name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
  accounts.unshift({id:uid("AC"), name, opening}); el('a_name').value=''; el('a_open').value=0; saveAll(); renderAll();
});
el('btnAddCat').addEventListener('click', ()=>{
  const type=el('c_type').value, name=el('c_name').value.trim(), budget=Number(el('c_budget').value||0); if(!name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î');
  categories.unshift({id:uid("CT"), type, name, budget:(type==='expense'?budget:0)}); el('c_name').value=''; el('c_budget').value=0; saveAll(); renderAll();
});
function renderAccCatTables(){
  const bal = computeBalances();
  el('accList').innerHTML = accounts.map(a=> `<tr>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠">${esc(a.name)}</td>
      <td class="mono" data-label="‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô">${fmt(a.opening||0)}</td>
      <td class="mono" data-label="‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">${fmt(bal[a.id]||0)}</td>
      <td data-label=""><button class="btn danger" onclick="delAcc('${a.id}')">‡∏•‡∏ö</button></td>
    </tr>`).join("") || `<tr><td colspan="4" class="caption">‚Äî</td></tr>`;
  el('catList').innerHTML = categories.map(c=> `<tr>
      <td data-label="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó">${c.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</td>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠">${esc(c.name)}</td>
      <td class="mono" data-label="‡∏á‡∏ö/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">${c.type==='expense'?fmt(c.budget||0):'-'}</td>
      <td data-label=""><button class="btn danger" onclick="delCat('${c.id}')">‡∏•‡∏ö</button></td>
    </tr>`).join("") || `<tr><td colspan="4" class="caption">‚Äî</td></tr>`;
}
function delTx(id){ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; tx = tx.filter(x=>x.id!==id); saveAll(); renderAll(); }
function delAcc(id){ if(!confirm('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ?')) return; accounts = accounts.filter(x=>x.id!==id); saveAll(); renderAll(); }
function delCat(id){ if(!confirm('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ?')) return; categories = categories.filter(x=>x.id!==id); saveAll(); renderAll(); }

// Filters + table + pagination
;['f_from','f_to','f_type','f_acc','f_cat'].forEach(id=> el(id).addEventListener('change', ()=>{state.p_tx=1; renderTxTable();}));
el('btnClearFilters').addEventListener('click', ()=>{ ['f_from','f_to','f_type','f_acc','f_cat'].forEach(id=> el(id).value=""); state.p_tx=1; renderTxTable(); });

function paginate(list, page, size){
  const total=list.length; const pages=Math.max(1, Math.ceil(total/size)); const cur=Math.min(Math.max(1,page), pages);
  const start=(cur-1)*size; const items=list.slice(start, start+size);
  return {items, cur, pages, total};
}
function renderPager(elTopId, elId, stateKey, totalPages, totalItems, pageSize){
  function html(where){
    return `<div class="pager">
      <span class="info">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      <label class="small">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</label>
      <select id="${stateKey}_ps_${where}"><option>10</option><option>25</option><option>50</option><option>100</option></select>
      <button class="btn" id="${stateKey}_prev_${where}">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <span class="info">‡∏´‡∏ô‡πâ‡∏≤ ${state[stateKey]} / ${totalPages}</span>
      <button class="btn" id="${stateKey}_next_${where}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>`;
  }
  if(elTopId) document.getElementById(elTopId).innerHTML = html("top");
  document.getElementById(elId).innerHTML = html("bot");
  // bind
  ["top","bot"].forEach(where=>{
    const ps = document.getElementById(`${stateKey}_ps_${where}`);
    ps.value = String(pageSize);
    ps.addEventListener('change', (e)=>{
      const v = Number(e.target.value);
      if(stateKey==="p_tx"){ settings.pageSizeTx=v; }
      if(stateKey==="p_mat"){ settings.pageSizeMat=v; }
      if(stateKey==="p_move"){ settings.pageSizeMove=v; }
      saveAll(); state[stateKey]=1; renderAll();
    });
    document.getElementById(`${stateKey}_prev_${where}`).addEventListener('click', ()=>{ if(state[stateKey]>1){ state[stateKey]-=1; renderAll(); } });
    document.getElementById(`${stateKey}_next_${where}`).addEventListener('click', ()=>{ if(state[stateKey]<totalPages){ state[stateKey]+=1; renderAll(); } });
  });
}
function renderTxTable(){
  const ffrom=el('f_from').value, fto=el('f_to').value, ftype=el('f_type').value, facc=el('f_acc').value, fcat=el('f_cat').value;
  const am=indexById(accounts), cm=indexById(categories);
  const filtered = tx.filter(t=>{
    if(ffrom && new Date(t.date) < new Date(ffrom)) return false;
    if(fto && new Date(t.date) > new Date(fto)) return false;
    if(ftype && t.type!==ftype) return false;
    if(facc && ![t.accIn, t.accOut].includes(facc)) return false;
    if(fcat && t.cat!==fcat) return false;
    return true;
  });
  const p = paginate(filtered, state.p_tx, settings.pageSizeTx);
  state.p_tx = p.cur;
  const rows = p.items.map(t=>{
    const typ = t.type==='income'?'<span class="badge ok">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>' : t.type==='expense'?'<span class="badge danger">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>' : '<span class="badge">‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</span>';
    const acct = t.type==='income' ? (am[t.accIn]?.name||'-') : t.type==='expense' ? (am[t.accOut]?.name||'-') : `${am[t.accOut]?.name||'-'} ‚Üí ${am[t.accIn]?.name||'-'}`;
    const cat = cm[t.cat]?.name || '-';
    return `<tr>
      <td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">${new Date(t.date).toLocaleDateString('th-TH')}</td>
      <td data-label="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó">${typ}</td>
      <td data-label="‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">${esc(acct)}</td>
      <td data-label="‡∏´‡∏°‡∏ß‡∏î">${esc(cat)}</td>
      <td data-label="‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤">${esc(t.party||'')}</td>
      <td class="mono" data-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">${fmt(t.amount)}</td>
      <td data-label="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">${esc(t.note||'')}</td>
      <td data-label=""><button class="btn danger" onclick="delTx('${t.id}')">‡∏•‡∏ö</button></td>
    </tr>`;
  }).join("");
  el('txTable').innerHTML = rows || `<tr><td colspan="8" class="caption">‚Äî</td></tr>`;
  renderPager("txPagerTop", "txPager", "p_tx", p.pages, p.total, settings.pageSizeTx);
}

// ===== Inventory =====
function refreshMatSelectors(){ document.getElementById('mm_sel').innerHTML = materials.map(m=> `<option value="${m.id}">${esc(m.name)}</option>`).join(""); }
function renderMaterials(){
  const allRows = materials.map(m=>{
    const value = Number(m.onHand||0) * Number(m.avgCost||0);
    const badge = (m.onHand||0) <= (m.reorder||0) ? '<span class="badge warn">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>' : '<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>';
    return {html:`<tr>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠">${esc(m.name)}</td>
      <td data-label="SKU">${esc(m.sku||'-')}</td>
      <td data-label="‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">${esc(m.barcode||'-')}</td>
      <td class="mono" data-label="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">${fmt(m.onHand||0)}</td>
      <td data-label="‡∏´‡∏ô‡πà‡∏ß‡∏¢">${esc(m.unit||'')}</td>
      <td class="mono" data-label="‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢">${fmt(m.avgCost||0)}</td>
      <td class="mono" data-label="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤">${fmt(value)}</td>
      <td class="mono" data-label="Reorder">${fmt(m.reorder||0)}</td>
      <td data-label=""><button class="btn danger" onclick="delMat('${m.id}')">‡∏•‡∏ö</button> ${badge}</td>
    </tr>`, key:m.id};
  });
  const p = paginate(allRows, state.p_mat, settings.pageSizeMat);
  state.p_mat = p.cur;
  document.getElementById('matTable').innerHTML = (p.items.map(r=>r.html).join("")) || `<tr><td colspan="9" class="caption">‚Äî</td></tr>`;
  renderPager("matPagerTop", "matPager", "p_mat", p.pages, p.total, settings.pageSizeMat);
}
function renderMoves(){
  const all = moves.map(mv=>{
    const mat = materials.find(x=>x.id===mv.materialId);
    const t = mv.type==="in"?"‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤": mv.type==="adjust"?"‡∏õ‡∏£‡∏±‡∏ö": mv.type==="use"?"‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ":"‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏ö";
    const qty = (mv.qty>0?"+":"") + fmt(mv.qty);
    return {time:mv.ts, html:`<tr>
      <td data-label="‡πÄ‡∏ß‡∏•‡∏≤">${new Date(mv.ts).toLocaleString('th-TH')}</td>
      <td data-label="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">${esc(mat?.name||mv.materialId)}</td>
      <td data-label="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó">${t}</td>
      <td class="mono" data-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">${qty}</td>
      <td class="mono" data-label="‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢">${fmt(mv.unitCost||0)}</td>
      <td data-label="‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á">${esc(mv.ref||"")}</td>
    </tr>`};
  });
  // newest first
  all.sort((a,b)=>b.time-a.time);
  const p = paginate(all, state.p_move, settings.pageSizeMove);
  state.p_move = p.cur;
  document.getElementById('moveTable').innerHTML = (p.items.map(r=>r.html).join("")) || `<tr><td colspan="6" class="caption">‚Äî</td></tr>`;
  renderPager("movePagerTop", "movePager", "p_move", p.pages, p.total, settings.pageSizeMove);
}
function addMaterial(){
  const m = { id:uid('M'), name:el('m_name').value.trim(), unit:el('m_unit').value.trim(), sku:el('m_sku').value.trim(), barcode:el('m_bar').value.trim(), reorder:Number(el('m_reorder').value||0), onHand:0, avgCost:0 };
  if(!m.name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  materials.unshift(m); saveAll(); renderAll();
  ['m_name','m_unit','m_sku','m_bar','m_reorder'].forEach(id=> el(id).value="");
}
function receiveStock(id, qty, unitCost, ref='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'){
  const m = materials.find(x=>x.id===id); if(!m) return;
  qty=Number(qty); unitCost=Number(unitCost);
  const oldQ=Number(m.onHand||0), oldC=Number(m.avgCost||0);
  const newQ=oldQ+qty;
  const newAvg=newQ<=0?0:((oldQ*oldC + qty*unitCost)/newQ);
  m.onHand = round(newQ,3); m.avgCost = round(newAvg,4);
  moves.unshift({id:uid('MV'), ts:Date.now(), materialId:id, type:'in', qty, unitCost, ref});
  saveAll(); renderAll();
}
function adjustStock(id, delta, ref='‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å'){
  const m = materials.find(x=>x.id===id); if(!m) return;
  delta=Number(delta); m.onHand = round(Number(m.onHand||0)+delta,3);
  moves.unshift({id:uid('MV'), ts:Date.now(), materialId:id, type:'adjust', qty:delta, unitCost:m.avgCost||0, ref});
  saveAll(); renderAll();
}
function round(n,d=2){ const p=Math.pow(10,d); return Math.round((Number(n)||0)*p)/p; }
function delMat(id){ if(!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')) return; materials = materials.filter(x=>x.id!==id); saveAll(); renderAll(); }
document.getElementById('btnAddMat').addEventListener('click', addMaterial);
document.getElementById('btnDoMove').addEventListener('click', ()=>{
  const id=document.getElementById('mm_sel').value; const qty=Number(document.getElementById('mm_qty').value||0); const cost=Number(document.getElementById('mm_cost').value||0);
  const type=document.getElementById('mm_type').value;
  if(!id) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); if(!qty) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
  if(type==='in'){ if(cost<=0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'); receiveStock(id, qty, cost); } else { adjustStock(id, qty); }
});

// ===== Count =====
function startCount(name,note){
  const lines = materials.map(m=> ({materialId:m.id, name:m.name, expected:Number(m.onHand||0), counted:null, unitCost:Number(m.avgCost||0)}));
  const c = {id:uid('CT'), name, note, startedAt:Date.now(), status:'open', lines};
  counts.unshift(c); saveAll(); renderAll(); openCount(c.id);
}
function openCount(id){
  const c = counts.find(x=>x.id===id); if(!c) return;
  const rows = c.lines.map((ln,idx)=>{
    const diff = (ln.counted==null? null : Number(ln.counted)-Number(ln.expected));
    const impact = (diff==null? 0 : diff*Number(ln.unitCost));
    return `<tr>
      <td data-label="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">${esc(ln.name||ln.materialId)}</td>
      <td class="mono" data-label="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏∞‡∏ö‡∏ö)">${fmt(ln.expected)}</td>
      <td data-label="‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ"><input type="number" step="0.01" value="${ln.counted==null? "": ln.counted}" oninput="updateCountLine('${c.id}', ${idx}, this.value)"></td>
      <td class="mono" data-label="‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á">${diff==null? "‚Äî":fmt(diff)}</td>
      <td class="mono" data-label="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤">${diff==null? "‚Äî":fmt(impact)}</td>
    </tr>`;
  }).join("");
  const totalImpact = c.lines.reduce((s,ln)=> s + (ln.counted==null?0 : (Number(ln.counted)-Number(ln.expected))*Number(ln.unitCost||0)), 0);
  const box = document.getElementById('countDetail'); box.style.display='block';
  box.innerHTML = `<div class="row" style="align-items:center"><h3 style="margin:0">‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡∏ö: ${esc(c.name)}</h3><span class="badge">${c.status==='open'?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏ö':'‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß'}</span><div class="caption">‡πÄ‡∏£‡∏¥‡πà‡∏°: ${new Date(c.startedAt).toLocaleString('th-TH')}</div></div>
  <div class="caption">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${esc(c.note||'-')}</div>
  <div style="max-height:420px; overflow:auto; margin-top:8px"><table class="rtbl"><thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="mono">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏∞‡∏ö‡∏ö)</th><th>‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</th><th class="mono">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th><th class="mono">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th></tr></thead><tbody>${rows || '<tr><td colspan="5" class="caption">‚Äî</td></tr>'}</tbody></table></div>
  <div class="row" style="margin-top:8px"><div class="card" style="flex:1"><div class="row" style="align-items:center"><div><b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°</b><div class="mono" style="font-size:22px">${fmt(totalImpact)}</div></div>
  <div class="row" style="margin-left:auto; justify-content:flex-end"><button class="btn" onclick="clearCountInputs('${c.id}')">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å</button><button class="btn danger" onclick="discardCount('${c.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn primary" ${c.status!=='open'?'disabled':''} onclick="postCount('${c.id}')">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</button></div>
  </div></div>`;
}
function updateCountLine(cid, idx, val){ const c=counts.find(x=>x.id===cid); if(!c) return; c.lines[idx].counted=(val===""? null : Number(val)); saveAll(); openCount(cid); }
function clearCountInputs(cid){ const c=counts.find(x=>x.id===cid); if(!c) return; c.lines.forEach(ln=> ln.counted=null); saveAll(); openCount(cid); }
function postCount(cid){
  const c = counts.find(x=>x.id===cid); if(!c) return;
  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) return;
  c.lines.forEach(ln=>{
    if(ln.counted==null) return;
    const diff = Number(ln.counted)-Number(ln.expected); if(diff===0) return;
    const m = materials.find(x=>x.id===ln.materialId); if(!m) return;
    m.onHand = round(Number(m.onHand||0)+diff, 3);
    moves.unshift({id:uid('MV'), ts:Date.now(), materialId:m.id, type:'count_adj', qty:diff, unitCost:Number(m.avgCost||0), ref:`‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö ${c.name}`});
  });
  c.status='posted'; saveAll(); renderAll(); openCount(cid);
}
function discardCount(cid){ if(!confirm('‡∏•‡∏ö/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) return; counts = counts.filter(x=>x.id!==cid); saveAll(); renderAll(); document.getElementById('countDetail').style.display='none'; }
document.getElementById('btnStartCount').addEventListener('click', ()=>{
  const name=document.getElementById('c_name').value.trim() || ('Cycle-'+todayISO());
  const note=document.getElementById('c_note').value.trim();
  startCount(name, note); document.getElementById('c_name').value=''; document.getElementById('c_note').value='';
});
function renderCountList(){
  document.getElementById('countList').innerHTML = counts.map(c=>{
    const totalImpact=c.lines.reduce((s,ln)=> s + (ln.counted==null?0: (Number(ln.counted)-Number(ln.expected))*Number(ln.unitCost||0)), 0);
    const badge = c.status==='open' ? '<span class="badge warn">‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>' : '<span class="badge ok">‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>';
    return `<tr>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö">${esc(c.name)}</td>
      <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">${badge}</td>
      <td class="mono" data-label="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á">${fmt(totalImpact)}</td>
      <td data-label=""><button class="btn" onclick="openCount('${c.id}')">‡πÄ‡∏õ‡∏¥‡∏î</button></td>
    </tr>`;
  }).join("") || `<tr><td colspan="4" class="caption">‚Äî</td></tr>`;
}

// ===== Settings UI =====
function loadSettingsToUI(){
  document.getElementById('set_gran').value = settings.defaultGranularity;
  document.getElementById('set_weekStart').value = settings.weekStart;
  document.getElementById('set_color').value = settings.theme;
  document.getElementById('set_currency').value = settings.currency;
  document.getElementById('set_decimals').value = settings.decimals;
  document.getElementById('set_topCats').value = settings.catTopN;
  document.getElementById('set_ps_tx').value = String(settings.pageSizeTx);
  document.getElementById('set_ps_mat').value = String(settings.pageSizeMat);
  document.getElementById('set_ps_move').value = String(settings.pageSizeMove);
}
document.getElementById('btnSaveSet').addEventListener('click', ()=>{
  settings.defaultGranularity = document.getElementById('set_gran').value;
  settings.weekStart = document.getElementById('set_weekStart').value;
  settings.theme = document.getElementById('set_color').value || settings.theme;
  settings.currency = document.getElementById('set_currency').value || settings.currency;
  settings.decimals = Math.max(0, Math.min(4, Number(document.getElementById('set_decimals').value||2)));
  settings.catTopN = Math.max(1, Math.min(20, Number(document.getElementById('set_topCats').value||8)));
  settings.pageSizeTx = Number(document.getElementById('set_ps_tx').value||25);
  settings.pageSizeMat = Number(document.getElementById('set_ps_mat').value||25);
  settings.pageSizeMove = Number(document.getElementById('set_ps_move').value||25);
  saveAll();
  // Apply immediately
  state.g = settings.defaultGranularity;
  state.p_tx = state.p_mat = state.p_move = 1;
  applyLook(); renderAll();
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
});
document.getElementById('btnResetSet').addEventListener('click', ()=>{
  if(!confirm('‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
  settings = Object.assign({}, DEFSET); saveAll(); loadSettingsToUI(); applyLook(); state.g=settings.defaultGranularity; state.p_tx=state.p_mat=state.p_move=1; renderAll();
});

// ===== Backup =====
document.getElementById('btnExportJSON').addEventListener('click', ()=>{
  const data={tx, accounts, categories, materials, moves, counts, settings, exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download='alltasks24_single_menu_paged_settings.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('importFile').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{
    const d=JSON.parse(r.result);
    tx=d.tx||[]; accounts=d.accounts||[]; categories=d.categories||[]; materials=d.materials||[]; moves=d.moves||[]; counts=d.counts||[];
    settings=Object.assign({}, DEFSET, d.settings||{});
    saveAll(); loadSettingsToUI(); applyLook(); renderAll(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }catch(err){ alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message); } };
  r.readAsText(f);
});

// ===== Seed & Clear =====
document.getElementById('seedBtn').addEventListener('click', ()=>{
  if(!confirm('‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°?')) return;
  accounts=[{id:uid('AC'), name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', opening:1200},{id:uid('AC'), name:'‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ A', opening:4200},{id:uid('AC'), name:'‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ï', opening:300}];
  categories=[{id:uid('CT'), type:'income', name:'‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', budget:0},{id:uid('CT'), type:'income', name:'‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', budget:0},{id:uid('CT'), type:'expense', name:'‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà/‡∏ß‡∏±‡∏™‡∏î‡∏∏', budget:4000},{id:uid('CT'), type:'expense', name:'‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', budget:1800},{id:uid('CT'), type:'expense', name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤', budget:4500},{id:uid('CT'), type:'expense', name:'‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î', budget:2000}];
  materials=[{id:uid('M'), name:'‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 10W-40', unit:'‡∏Ç‡∏ß‡∏î', sku:'OIL-10W40', barcode:'8850000001', reorder:3, onHand:8, avgCost:120},{id:uid('M'), name:'‡∏´‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô CR7HSA', unit:'‡∏ä‡∏¥‡πâ‡∏ô', sku:'SP-CR7', barcode:'8850000002', reorder:5, onHand:12, avgCost:70},{id:uid('M'), name:'‡∏ô‡πá‡∏≠‡∏ï M6x20', unit:'‡∏ï‡∏±‡∏ß', sku:'BOLT-M6-20', barcode:'8850000003', reorder:50, onHand:40, avgCost:1.5}];
  const iso=(d)=>{ d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }; const now=new Date();
  moves=[{id:uid('MV'), ts:Date.now()-86400000*10, materialId:materials[0].id, type:'in', qty:10, unitCost:120, ref:'‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'},
         {id:uid('MV'), ts:Date.now()-86400000*8, materialId:materials[1].id, type:'in', qty:20, unitCost:70, ref:'‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'},
         {id:uid('MV'), ts:Date.now()-86400000*7, materialId:materials[2].id, type:'in', qty:200, unitCost:1.5, ref:'‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'}];
  tx=[{id:uid('TX'), date: iso(new Date(now)), type:'income', accIn:accounts[0].id, accOut:null, cat:categories[0].id, amount:900, party:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A', note:'‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°'},
      {id:uid('TX'), date: iso(new Date(now)), type:'expense', accIn:null, accOut:accounts[0].id, cat:categories[3].id, amount:180, party:'‡∏õ‡∏±‡πä‡∏° B', note:'‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô'},
      {id:uid('TX'), date: iso(new Date(now.getFullYear(), now.getMonth(), now.getDate()-2)), type:'income', accIn:accounts[1].id, accOut:null, cat:categories[1].id, amount:1500, party:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ C', note:'‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'},
      {id:uid('TX'), date: iso(new Date(now.getFullYear(), now.getMonth(), now.getDate()-4)), type:'expense', accIn:null, accOut:accounts[1].id, cat:categories[5].id, amount:250, party:'Facebook Ads', note:'‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç'},
      {id:uid('TX'), date: iso(new Date(now.getFullYear(), now.getMonth(), now.getDate()-6)), type:'expense', accIn:null, accOut:accounts[2].id, cat:categories[2].id, amount:320, party:'‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà D', note:'‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏'}];
  counts=[]; saveAll(); renderAll();
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
  tx=[]; accounts=[]; categories=[]; materials=[]; moves=[]; counts=[]; saveAll(); renderAll();
});

// Init
function renderAll(){ refreshSelectors(); applyLook(); renderOverview(); renderTxTable(); renderAccCatTables(); refreshMatSelectors(); renderMaterials(); renderMoves(); renderCountList(); loadSettingsToUI(); }
el('t_date').value=todayISO(); renderAll();
</script>
<script src="/seo.js"></script><script src="/share.js"></script></body>
</html>
